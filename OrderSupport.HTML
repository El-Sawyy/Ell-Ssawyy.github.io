<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Advanced Retention MBR Dashboard</title>
    
    <!-- Stable CDNs for Production -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .drag-active { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .tab-active { color: #2563eb; border-bottom: 2px solid #2563eb; font-weight: 600; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; hover:border-gray-300; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden text-sm">

    <!-- Top Navigation -->
    <header class="bg-white shadow-sm z-20 border-b border-gray-200">
        <div class="max-w-[1600px] mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                    <i class="ph ph-trend-up text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 leading-tight">Retention MBR Dashboard</h1>
                    <div class="flex items-center gap-2">
                        <p class="text-xs text-gray-500">Order Support Team Analytics</p>
                        <span class="bg-green-100 text-green-700 text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1 font-bold">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Live Sync
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="flex space-x-6" id="navTabs">
                <button onclick="switchTab('overview')" class="tab-active pb-1 px-1 transition-colors outline-none" data-tab="overview">Overview</button>
                <button onclick="switchTab('agents')" class="tab-inactive pb-1 px-1 transition-colors outline-none" data-tab="agents">Agent Performance</button>
                <button onclick="switchTab('reasons')" class="tab-inactive pb-1 px-1 transition-colors outline-none" data-tab="reasons">Reason Analytics</button>
                <button onclick="switchTab('data')" class="tab-inactive pb-1 px-1 transition-colors outline-none" data-tab="data">Data Manager</button>
            </div>
            
            <div class="flex items-center gap-3">
                <span class="text-xs font-medium bg-gray-100 text-gray-600 px-2 py-1 rounded-md" id="recordCountBadge">0 Records</span>
                <button onclick="openAddRecordModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-sm font-medium transition-colors flex items-center gap-1">
                    <i class="ph ph-plus"></i> Add Data
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Layout -->
    <main class="flex-1 flex overflow-hidden max-w-[1600px] w-full mx-auto">
        
        <!-- Sidebar: Global Controls -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col z-10 overflow-hidden shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            
            <!-- Upload Section -->
            <div class="p-4 border-b border-gray-100 bg-gray-50/50">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-1"><i class="ph ph-database"></i> Add to Database</h2>
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-colors bg-white" onclick="document.getElementById('csvFileInput').click()">
                    <i class="ph ph-cloud-arrow-up text-2xl text-blue-500 mb-1"></i>
                    <p class="text-xs text-gray-600 font-medium">Upload CSV or XLSX</p>
                    <p class="text-[10px] text-gray-400 mt-1">Duplicates overwritten by Ticket ID</p>
                    <input type="file" id="csvFileInput" accept=".csv, .xlsx, .xls" class="hidden">
                </div>
            </div>

            <!-- Team Filter -->
            <div class="p-4 border-b border-gray-100">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-1"><i class="ph ph-users-three"></i> Team Filter</h2>
                <select id="teamFilter" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white cursor-pointer">
                    <option value="all">All Teams (Overall)</option>
                    <option value="order_support">Order Support</option>
                    <option value="mentors">Mentors</option>
                    <option value="mx">MX</option>
                </select>
            </div>

            <!-- Date Filter -->
            <div class="p-4 border-b border-gray-100">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-1"><i class="ph ph-calendar-blank"></i> Date Range</h2>
                <div class="flex flex-col gap-2">
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">Start Date</label>
                        <input type="date" id="startDateFilter" class="w-full text-xs border border-gray-300 rounded p-1.5 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">End Date</label>
                        <input type="date" id="endDateFilter" class="w-full text-xs border border-gray-300 rounded p-1.5 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <button onclick="clearDateFilters()" class="text-xs text-blue-600 hover:text-blue-800 mt-1 text-left w-max">Clear Dates</button>
                </div>
            </div>

            <!-- Reason Filters -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-4 pb-2 flex justify-between items-center bg-white">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1"><i class="ph ph-funnel"></i> Exclude Reasons</h2>
                    <button id="selectAllBtn" class="text-[10px] text-blue-600 hover:text-blue-800 font-bold bg-blue-50 px-2 py-1 rounded">Toggle All</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar px-4 pb-4" id="reasonFilterContainer">
                    <p class="text-xs text-gray-400 italic mt-2 text-center">No data loaded yet.</p>
                </div>
            </div>
        </aside>

        <!-- Dynamic Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-[#f8fafc] relative" id="mainContent">
            
            <!-- Empty State Overlay -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center bg-[#f8fafc] z-10">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 text-center max-w-md" id="emptyStateBox">
                    <div class="mx-auto w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4">
                        <i class="ph ph-spinner animate-spin text-3xl" id="emptyStateIcon"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 mb-2" id="emptyStateTitle">Connecting to Database...</h2>
                    <p class="text-gray-500 text-sm mb-6" id="emptyStateDesc">Please wait while we establish a secure connection to the live team data.</p>
                </div>
            </div>

            <!-- TAB 1: OVERVIEW -->
            <div id="tab-overview" class="tab-pane hidden flex-col gap-6">
                <!-- Summary KPI Cards -->
                <div class="grid grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1">Total Cases</p>
                        <h3 class="text-2xl font-bold text-gray-900" id="kpiTotalCases">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-2 bg-green-500"></div>
                        <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1">Prevented / Saved</p>
                        <h3 class="text-2xl font-bold text-green-600" id="kpiSavedCases">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-2 bg-yellow-400"></div>
                        <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1" title="Excluded from retention math">Pending Cases</p>
                        <h3 class="text-2xl font-bold text-yellow-600" id="kpiPendingCases">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-2 bg-blue-600"></div>
                        <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1" title="Based on resolved cases only">Overall Retention Rate</p>
                        <h3 class="text-2xl font-bold text-blue-600" id="kpiRetentionRate">0%</h3>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-6">
                    <!-- Timeline Chart -->
                    <div class="col-span-2 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-800 mb-4">Retention Trend Over Time</h3>
                        <div class="w-full h-72">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Status Distribution -->
                    <div class="col-span-1 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-800 mb-4">Ticket Status Breakdown</h3>
                        <div class="w-full h-64 flex justify-center">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: AGENTS (Drill-Down Setup) -->
            <div id="tab-agents" class="tab-pane hidden h-[calc(100vh-140px)] flex-col gap-6 pb-6">
                
                <!-- View 1: Leaderboard -->
                <div id="agentLeaderboardView" class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                    <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-900">Agent Performance Leaderboard</h3>
                        <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">Click any agent to view full profile & tickets</span>
                    </div>
                    <div class="overflow-y-auto flex-1 custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead class="sticky top-0 bg-white shadow-sm z-10">
                                <tr class="text-xs text-gray-500 uppercase tracking-wider">
                                    <th class="py-3 px-6 font-semibold bg-white border-b border-gray-100">Agent Name / Email</th>
                                    <th class="py-3 px-6 font-semibold text-center bg-white border-b border-gray-100">Total Cases</th>
                                    <th class="py-3 px-6 font-semibold text-center bg-white border-b border-gray-100">Saved</th>
                                    <th class="py-3 px-6 font-semibold text-center bg-white border-b border-gray-100 text-yellow-600">Pending</th>
                                    <th class="py-3 px-6 font-semibold text-right bg-white border-b border-gray-100">Retention Rate</th>
                                </tr>
                            </thead>
                            <tbody id="agentTableBody" class="divide-y divide-gray-100 text-gray-800">
                                <!-- Injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- View 2: Detailed Agent Profile -->
                <div id="agentProfileView" class="hidden flex-col h-full gap-4">
                    <!-- Top Toolbar for Profile -->
                    <div class="flex items-center justify-between shrink-0 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center gap-4">
                            <button onclick="backToLeaderboard()" class="flex items-center gap-1.5 text-sm font-medium text-gray-600 hover:text-blue-600 px-3 py-1.5 bg-gray-50 hover:bg-blue-50 rounded-md border border-gray-200 transition-colors">
                                <i class="ph ph-arrow-left text-lg"></i> Back to Leaderboard
                            </button>
                            <div class="w-px h-6 bg-gray-300"></div>
                            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2" id="selectedAgentTitle">Agent Name</h3>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 gap-4 shrink-0">
                        <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase tracking-wider mb-2">Retention Rate</div>
                            <div class="text-4xl font-bold text-blue-600" id="snapRate">0%</div>
                        </div>
                        <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase tracking-wider mb-2">Resolved Volume</div>
                            <div class="text-4xl font-bold text-gray-900" id="snapVol">0</div>
                        </div>
                    </div>

                    <!-- Bottom Split: Charts & Tickets -->
                    <div class="grid grid-cols-2 gap-4 flex-1 min-h-0">
                        <!-- Left: Reasons Chart -->
                        <div class="bg-white border border-gray-200 p-5 rounded-xl shadow-sm flex flex-col">
                            <h4 class="text-sm font-bold text-gray-800 mb-4">Top Cancellation Reasons Handled</h4>
                            <div class="flex-1 relative min-h-[250px]">
                                <canvas id="agentReasonChart"></canvas>
                            </div>
                        </div>

                        <!-- Right: Ticket Validation List -->
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm flex flex-col overflow-hidden">
                            <div class="bg-gray-50 px-5 py-4 border-b border-gray-200 flex justify-between items-center shrink-0">
                                <h4 class="text-sm font-bold text-gray-800">Validation: Agent's Tickets</h4>
                                <div class="flex items-center gap-3">
                                    <select id="agentTicketFilter" class="text-xs border border-gray-300 rounded px-2 py-1 outline-none bg-white cursor-pointer" onchange="renderAgentTicketsList()">
                                        <option value="all">All Statuses</option>
                                        <option value="true">Saved (Yes)</option>
                                        <option value="false">Unsaved (No)</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                    <span class="text-xs text-gray-500" id="ticketListCount">0 records</span>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-0 bg-white">
                                <table class="w-full text-left text-xs whitespace-nowrap">
                                    <thead class="bg-white sticky top-0 shadow-sm z-10">
                                        <tr class="text-gray-500 uppercase">
                                            <th class="py-3 px-4 font-semibold border-b border-gray-100">Ticket / FC ID</th>
                                            <th class="py-3 px-4 font-semibold border-b border-gray-100">Order ID</th>
                                            <th class="py-3 px-4 font-semibold border-b border-gray-100 text-right">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agentTicketsBody" class="divide-y divide-gray-100">
                                        <!-- Drill down tickets go here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- TAB 3: REASONS -->
            <div id="tab-reasons" class="tab-pane hidden flex-col gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold text-gray-900">Cancellation Reasons Analysis</h3>
                        <p class="text-xs text-gray-500">Sorted by frequency. Excluded reasons are hidden.</p>
                    </div>
                    <div class="w-full h-[500px]">
                        <canvas id="topReasonsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TAB 4: DATA MANAGER -->
            <div id="tab-data" class="tab-pane hidden flex-col h-full gap-4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                    <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <div>
                            <h3 class="text-sm font-bold text-gray-900">Live Team Database Explorer</h3>
                            <p class="text-xs text-gray-500">View, edit, or remove individual records affecting everyone's dashboard.</p>
                        </div>
                        <button onclick="clearAllData()" class="text-xs text-red-600 hover:text-red-800 border border-red-200 hover:bg-red-50 px-3 py-1.5 rounded transition-colors flex items-center gap-1">
                            <i class="ph ph-trash"></i> Wipe Database
                        </button>
                    </div>
                    <div class="flex-1 overflow-auto custom-scrollbar p-0">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="sticky top-0 bg-white shadow-sm z-10">
                                <tr class="text-xs text-gray-500 uppercase tracking-wider bg-gray-50">
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Date</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Ticket ID</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Agent</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Reason</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Status</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Prevented</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rawDataTableBody" class="divide-y divide-gray-100 text-xs">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal for Adding/Editing Record -->
    <div id="recordModal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden transform transition-all modal-enter" id="recordModalContent">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-900" id="modalTitle">Add Database Record</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-6">
                <form id="recordForm" class="grid grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Ticket ID (Primary Key)</label>
                        <input type="text" id="formTicketId" placeholder="Auto-generated if blank" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none disabled:bg-gray-100 disabled:text-gray-500">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Created Date</label>
                        <input type="datetime-local" id="formDate" required class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Agent (Submitted By)</label>
                        <input type="text" id="formAgent" required placeholder="e.g. agent@company.com" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    
                    <!-- New Fields for Order ID and Freshchat Convo ID -->
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Order ID</label>
                        <input type="text" id="formOrderId" placeholder="Optional" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Freshchat Convo ID</label>
                        <input type="text" id="formFreshchatId" placeholder="Optional" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>

                    <div class="col-span-2">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Cancellation Reason</label>
                        <input type="text" id="formReason" required placeholder="e.g. Pricing, Content, etc." list="reasonSuggestions" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <datalist id="reasonSuggestions"></datalist>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Status</label>
                        <select id="formStatus" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                            <option value="Open">Open</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Request Prevented?</label>
                        <select id="formPrevented" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="False">No (False)</option>
                            <option value="True">Yes (True)</option>
                            <option value="Pending">Pending (Excluded from Rate)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="saveRecord()" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors flex items-center gap-2"><i class="ph ph-cloud-check"></i> Sync Record</button>
            </div>
        </div>
    </div>

    <!-- Firebase Realtime Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Team Definitions (Lowercase for robust comparison)
        const TEAM_ORDER_SUPPORT = [
            'mohamed.kheer@tempo.fit',
            'rima.khaled@tempo.fit',
            'santos.nyikang@tempo.fit',
            'youkabed.farid@tempo.fit',
            'ahmed.elsawy@tempo.fit'
        ];
        
        const TEAM_MENTORS = [
            'noha.radwan@tempo.fit',
            'rashad.mohamed@tempo.fit',
            'emad.mohamed@tempo.fit'
        ];

        function getAgentTeam(emailStr) {
            const email = String(emailStr).trim().toLowerCase();
            if (TEAM_ORDER_SUPPORT.includes(email)) return 'Order Support';
            if (TEAM_MENTORS.includes(email)) return 'Mentors';
            return 'MX';
        }

        // Global State
        let globalDataMap = new Map(); 
        let uniqueReasons = new Set();
        let excludedReasons = new Set();
        let charts = { trend: null, status: null, topReasons: null, agentReason: null };
        let currentActiveTab = 'overview';
        let selectedAgentForSnapshot = null;
        let currentAgentSpecificTickets = []; 

        // Firebase Auth Variables
        let app, auth, db, user = null;
        
        // --- YOUR FIREBASE CONFIGURATION GOES HERE ---
        const appId = 'order-support-retention'; // Updated to match your project
        const firebaseConfig = {
            apiKey: "AIzaSyAdEiz5ZHa8T6qgReekxYCtjHppPZ66kA8",
            authDomain: "order-support-retention.firebaseapp.com",
            projectId: "order-support-retention",
            storageBucket: "order-support-retention.firebasestorage.app",
            messagingSenderId: "930779552737",
            appId: "1:930779552737:web:857e66b4307e647d9e50a0"
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            setupUIControls();
            
            // Firebase setup
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                try {
                    await signInAnonymously(auth);
                } catch (err) {
                    console.error("Auth Error", err);
                    showEmptyState("Authentication Failed", "Could not connect to the database. Refresh to try again.", "ph-warning-circle text-red-500");
                }

                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        setupRealtimeListener();
                    }
                });
            } else {
                showEmptyState("Database Not Found", "Firebase configuration is missing in this environment.", "ph-database text-red-500");
            }
        });

        function setupRealtimeListener() {
            const dataRef = collection(db, 'artifacts', appId, 'public', 'data', 'retention_records');
            onSnapshot(dataRef, (snapshot) => {
                globalDataMap.clear();
                uniqueReasons.clear();
                
                snapshot.forEach(docSnap => {
                    const row = docSnap.data();
                    row._parsedDate = new Date(row._timestamp || row['Created date']);
                    globalDataMap.set(docSnap.id, row);
                    uniqueReasons.add(row._cleanReason);
                });
                
                updateFilterSidebar();
                updateUIState();
                refreshDashboard();
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                showEmptyState("Connection Error", "Lost connection to the database. Trying to reconnect...", "ph-wifi-slash text-red-500");
            });
        }

        // --- UI & Utility Hooks ---
        function setupUIControls() {
            // Navigation
            window.switchTab = function(tabId) {
                currentActiveTab = tabId;
                document.querySelectorAll('#navTabs button').forEach(btn => {
                    btn.className = btn.dataset.tab === tabId ? 'tab-active pb-1 px-1 transition-colors outline-none' : 'tab-inactive pb-1 px-1 transition-colors outline-none';
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.add('hidden'); pane.classList.remove('flex');
                });
                if (globalDataMap.size > 0) {
                    const activePane = document.getElementById(`tab-${tabId}`);
                    activePane.classList.remove('hidden'); activePane.classList.add('flex');
                    refreshDashboard();
                }
            };

            // Back to Leaderboard function
            window.backToLeaderboard = function() {
                selectedAgentForSnapshot = null;
                document.getElementById('agentProfileView').classList.add('hidden');
                document.getElementById('agentProfileView').classList.remove('flex');
                document.getElementById('agentLeaderboardView').classList.remove('hidden');
                document.getElementById('agentLeaderboardView').classList.add('flex');
                
                // Clear row highlighting
                const tbody = document.getElementById('agentTableBody');
                Array.from(tbody.children).forEach(r => r.classList.remove('bg-blue-50'));
            };

            // Drag and Drop
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('csvFileInput');
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-active'); });
            ['dragleave', 'dragend'].forEach(type => dropZone.addEventListener(type, () => dropZone.classList.remove('drag-active')));
            dropZone.addEventListener('drop', e => {
                e.preventDefault(); dropZone.classList.remove('drag-active');
                if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', e => {
                if (e.target.files.length) handleFile(e.target.files[0]);
                fileInput.value = ''; 
            });

            // Filters Check
            document.getElementById('startDateFilter').addEventListener('change', refreshDashboard);
            document.getElementById('endDateFilter').addEventListener('change', refreshDashboard);
            document.getElementById('teamFilter').addEventListener('change', refreshDashboard);

            window.clearDateFilters = function() {
                document.getElementById('startDateFilter').value = '';
                document.getElementById('endDateFilter').value = '';
                refreshDashboard();
            };

            // Modal Controls
            window.openAddRecordModal = function() {
                document.getElementById('recordForm').reset();
                document.getElementById('modalTitle').textContent = 'Add Database Record';
                document.getElementById('formTicketId').disabled = false; // Enabled for new records
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('formDate').value = now.toISOString().slice(0,16);
                document.getElementById('recordModal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('recordModalContent').classList.add('modal-enter-active'); }, 10);
            };
            window.closeModal = function() {
                document.getElementById('recordModalContent').classList.remove('modal-enter-active');
                setTimeout(() => { document.getElementById('recordModal').classList.add('hidden'); }, 200);
            };

            // Render Ticket List for Agent with filtering logic
            window.renderAgentTicketsList = function() {
                const filterVal = document.getElementById('agentTicketFilter').value;
                const tbody = document.getElementById('agentTicketsBody');
                tbody.innerHTML = '';
                
                let filtered = currentAgentSpecificTickets;
                if (filterVal === 'true') filtered = filtered.filter(t => t._isSaved && !t._isPending);
                else if (filterVal === 'false') filtered = filtered.filter(t => !t._isSaved && !t._isPending);
                else if (filterVal === 'pending') filtered = filtered.filter(t => t._isPending);
                
                document.getElementById('ticketListCount').textContent = `${filtered.length} records`;
                
                filtered.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 transition-colors";
                    
                    let savedBadge = '';
                    if(t._isPending) savedBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold">Pending</span>';
                    else if(t._isSaved) savedBadge = '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold">Yes</span>';
                    else savedBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold">No</span>';

                    tr.innerHTML = `
                        <td class="py-3 px-4 border-b border-gray-100">
                            <div class="font-mono text-[11px] text-gray-800 font-medium">TKT: ${t['Ticket ID']}</div>
                            <div class="font-mono text-[10px] text-gray-400 mt-1" title="Freshchat Conv ID">FC: ${t['Freshchat Conversation ID'] || '-'}</div>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-100 font-mono text-[11px] text-gray-600">
                            ${t['Order ID'] || '-'}
                        </td>
                        <td class="py-3 px-4 border-b border-gray-100 text-right">
                            ${savedBadge}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            };
        }

        function showEmptyState(title, desc, iconClass) {
            document.getElementById('emptyState').classList.remove('hidden');
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            
            document.getElementById('emptyStateIcon').className = `ph ${iconClass} text-4xl`;
            document.getElementById('emptyStateTitle').textContent = title;
            document.getElementById('emptyStateDesc').textContent = desc;
            
            if(title === "Database Connected. Awaiting Data.") {
                 if(!document.getElementById('btnUploadStart')) {
                     const btn = document.createElement('button');
                     btn.id = 'btnUploadStart';
                     btn.className = "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors w-full mt-4 flex justify-center items-center gap-2";
                     btn.innerHTML = `<i class="ph ph-cloud-arrow-up text-xl"></i> Upload Data to Start`;
                     btn.onclick = () => document.getElementById('csvFileInput').click();
                     document.getElementById('emptyStateBox').appendChild(btn);
                 }
            } else {
                const btn = document.getElementById('btnUploadStart');
                if(btn) btn.remove();
            }
        }

        function updateUIState() {
            if (globalDataMap.size === 0) {
                showEmptyState("Database Connected. Awaiting Data.", "Upload your CSV/XLSX. Duplicates will be safely updated based on Ticket ID.", "ph-database text-blue-500");
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById(`tab-${currentActiveTab}`).classList.remove('hidden');
                document.getElementById(`tab-${currentActiveTab}`).classList.add('flex');
            }
            // Count based on current team filter
            const count = getFilteredData().length;
            document.getElementById('recordCountBadge').textContent = `${count} Records`;
        }

        // --- File Upload & Firebase Batch Sync ---
        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                alert('Please upload a valid CSV or Excel file.');
                return;
            }

            if (fileName.endsWith('.csv')) {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: results => syncToDatabase(results.data), error: err => alert('CSV Error: ' + err.message) });
            } else {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                        const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false});
                        syncToDatabase(data);
                    } catch (err) { alert('Excel Error: ' + err.message); }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        async function syncToDatabase(dataArray) {
            if (!user) { alert("Not authenticated to database yet. Please wait."); return; }
            
            showEmptyState("Syncing to Cloud Database...", "Please wait while we merge your data securely. Duplicates are being updated.", "ph-spinner animate-spin text-blue-500");

            const dedupedData = new Map();
            
            dataArray.forEach(row => {
                if(!row['Submitted By'] || row['Submitted By'].trim() === '') return;

                let tId = row['Ticket ID'] || row['ticket_id'] || row['Freshchat Conversation ID'];
                if (!tId || String(tId).trim() === '') { tId = 'TKT-' + Math.random().toString(36).substr(2, 9).toUpperCase(); }
                tId = String(tId).trim();

                const pStr = String(row['New Request Prevented'] || '').trim().toLowerCase();
                const isPending = (pStr === 'pending');
                const isSaved = (pStr === 'true' || pStr === 'yes' || pStr === '1');

                let parsedDate = new Date(row['Created date'] || new Date());
                if (isNaN(parsedDate.getTime())) parsedDate = new Date();
                
                let cleanReason = (row['Cancellation & Return Reason'] || 'Unspecified').trim();
                if(cleanReason === '') cleanReason = 'Unspecified';

                const orderId = row['Order ID'] || row['order_id'] || '';
                const fcId = row['Freshchat Conversation ID'] || row['freshchat_conversation_id'] || '';

                dedupedData.set(tId, {
                    'Ticket ID': tId,
                    'Submitted By': row['Submitted By'].trim(),
                    'Created date': parsedDate.toISOString(),
                    'Order ID': String(orderId).trim(),
                    'Freshchat Conversation ID': String(fcId).trim(),
                    'Cancellation & Return Reason': cleanReason,
                    'Status': row['Status'] || '',
                    'New Request Prevented': row['New Request Prevented'] || '',
                    '_isSaved': isSaved,
                    '_isPending': isPending,
                    '_cleanReason': cleanReason,
                    '_timestamp': parsedDate.getTime()
                });
            });

            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'retention_records');
            let batch = writeBatch(db);
            let count = 0;

            try {
                for (const [tId, rowData] of dedupedData.entries()) {
                    const safeTId = tId.replace(/[^a-zA-Z0-9_-]/g, '_'); 
                    const docRef = doc(collectionRef, safeTId);
                    batch.set(docRef, rowData); 
                    count++;
                    if (count === 490) { 
                        await batch.commit();
                        batch = writeBatch(db);
                        count = 0;
                    }
                }
                if (count > 0) await batch.commit();
            } catch (err) {
                console.error("Batch Sync Error:", err);
                alert("An error occurred while saving to the database. Check console.");
                updateUIState();
            }
        }

        // --- Manual Database Writes ---
        window.editRecord = function(ticketId) {
            const record = globalDataMap.get(ticketId);
            if(!record) return;
            
            document.getElementById('modalTitle').textContent = 'Edit Database Record';
            document.getElementById('formTicketId').value = record['Ticket ID'];
            document.getElementById('formTicketId').disabled = true; // Prevent changing the primary ID key
            
            const localDate = new Date(record._timestamp);
            localDate.setMinutes(localDate.getMinutes() - localDate.getTimezoneOffset());
            document.getElementById('formDate').value = localDate.toISOString().slice(0,16);
            
            document.getElementById('formAgent').value = record['Submitted By'];
            document.getElementById('formReason').value = record['Cancellation & Return Reason'];
            document.getElementById('formStatus').value = record['Status'];
            
            // Map the internal value back to select input
            let prevVal = "False";
            if (record._isPending) prevVal = "Pending";
            else if (record._isSaved) prevVal = "True";
            document.getElementById('formPrevented').value = prevVal;
            
            document.getElementById('formOrderId').value = record['Order ID'] || '';
            document.getElementById('formFreshchatId').value = record['Freshchat Conversation ID'] || '';

            document.getElementById('recordModal').classList.remove('hidden');
            setTimeout(() => { document.getElementById('recordModalContent').classList.add('modal-enter-active'); }, 10);
        };

        window.saveRecord = async function() {
            if (!user) return;
            
            // Re-fetch the ID in case it is disabled
            let tId = document.getElementById('formTicketId').value.trim();
            if(!tId && !document.getElementById('formTicketId').disabled) {
                tId = 'MANUAL-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            }
            
            const agent = document.getElementById('formAgent').value.trim();
            const dateStr = document.getElementById('formDate').value;
            const reason = document.getElementById('formReason').value.trim() || 'Unspecified';
            const status = document.getElementById('formStatus').value;
            const preventedRaw = document.getElementById('formPrevented').value;
            
            const orderId = document.getElementById('formOrderId').value.trim();
            const fcId = document.getElementById('formFreshchatId').value.trim();

            if(!agent || !dateStr) { alert("Agent and Date are required."); return; }
            
            const isPending = (preventedRaw.toLowerCase() === 'pending');
            const isSaved = (preventedRaw.toLowerCase() === 'true' || preventedRaw.toLowerCase() === 'yes');

            const row = {
                'Ticket ID': tId,
                'Submitted By': agent,
                'Created date': new Date(dateStr).toISOString(),
                'Order ID': orderId,
                'Freshchat Conversation ID': fcId,
                'Cancellation & Return Reason': reason,
                'Status': status,
                'New Request Prevented': preventedRaw,
                '_isSaved': isSaved,
                '_isPending': isPending,
                '_cleanReason': reason,
                '_timestamp': new Date(dateStr).getTime()
            };

            try {
                const safeTId = tId.replace(/[^a-zA-Z0-9_-]/g, '_');
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'retention_records', safeTId);
                await setDoc(docRef, row);
                window.closeModal();
            } catch(err) { console.error(err); alert("Failed to sync record manually."); }
        };

        window.deleteRecord = async function(ticketId) {
            if (!user) return;
            if(confirm('Delete this record permanently from the database? Everyone will lose access to it.')) {
                try {
                    const safeTId = ticketId.replace(/[^a-zA-Z0-9_-]/g, '_');
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'retention_records', safeTId);
                    await deleteDoc(docRef);
                } catch(err) { console.error(err); alert("Failed to delete record."); }
            }
        };

        window.clearAllData = async function() {
            if (!user) return;
            if(confirm('DANGER: This will PERMANENTLY erase all data in the database for the entire team. Are you completely sure?')) {
                try {
                    showEmptyState("Erasing Database...", "Cleaning up all team records.", "ph-spinner animate-spin text-red-500");
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'retention_records');
                    const snapshot = await getDocs(colRef);
                    let batch = writeBatch(db);
                    let count = 0;
                    for (const docSnap of snapshot.docs) {
                        batch.delete(docSnap.ref);
                        count++;
                        if(count === 490) {
                            await batch.commit();
                            batch = writeBatch(db);
                            count = 0;
                        }
                    }
                    if(count > 0) await batch.commit();
                    
                    document.getElementById('startDateFilter').value = '';
                    document.getElementById('endDateFilter').value = '';
                    excludedReasons.clear();
                } catch (err) { console.error(err); alert("Failed to erase database."); }
            }
        };

        // --- Filtering Engine ---
        function updateFilterSidebar() {
            const container = document.getElementById('reasonFilterContainer');
            const dataList = document.getElementById('reasonSuggestions');
            container.innerHTML = ''; dataList.innerHTML = '';
            
            Array.from(uniqueReasons).sort().forEach(reason => {
                const opt = document.createElement('option'); opt.value = reason; dataList.appendChild(opt);

                const id = `chk_${Math.random().toString(36).substr(2, 9)}`;
                const isChecked = !excludedReasons.has(reason);
                const div = document.createElement('div');
                div.className = 'flex items-start gap-2 py-1.5 border-b border-gray-50 last:border-0 hover:bg-gray-50 rounded px-1';
                div.innerHTML = `
                    <input type="checkbox" id="${id}" value="${reason.replace(/"/g, '&quot;')}" class="mt-0.5 w-3.5 h-3.5 text-blue-600 rounded cursor-pointer" ${isChecked ? 'checked' : ''}>
                    <label for="${id}" class="text-xs text-gray-700 cursor-pointer flex-1 truncate select-none" title="${reason}">${reason}</label>
                `;
                div.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) excludedReasons.delete(e.target.value);
                    else excludedReasons.add(e.target.value);
                    refreshDashboard();
                });
                container.appendChild(div);
            });

            document.getElementById('selectAllBtn').onclick = () => {
                const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                checkboxes.forEach(cb => {
                    cb.checked = !allChecked;
                    if(cb.checked) excludedReasons.delete(cb.value); else excludedReasons.add(cb.value);
                });
                refreshDashboard();
            };
        }

        function getFilteredData() {
            const startDateStr = document.getElementById('startDateFilter').value;
            const endDateStr = document.getElementById('endDateFilter').value;
            const teamFilter = document.getElementById('teamFilter').value;

            let start = startDateStr ? new Date(startDateStr) : null;
            let end = endDateStr ? new Date(endDateStr) : null;
            if(end) end.setHours(23, 59, 59, 999);

            let result = [];
            globalDataMap.forEach(row => {
                // Date Filter
                if (start && row._parsedDate < start) return;
                if (end && row._parsedDate > end) return;
                
                // Reason Exclusions
                if (excludedReasons.has(row._cleanReason)) return;

                // Team Filter
                if (teamFilter !== 'all') {
                    const agentTeam = getAgentTeam(row['Submitted By']);
                    if (teamFilter === 'order_support' && agentTeam !== 'Order Support') return;
                    if (teamFilter === 'mentors' && agentTeam !== 'Mentors') return;
                    if (teamFilter === 'mx' && agentTeam !== 'MX') return;
                }

                result.push(row);
            });
            
            // Update the record badge with the filtered length
            document.getElementById('recordCountBadge').textContent = `${result.length} Records`;
            return result.sort((a,b) => b._parsedDate - a._parsedDate);
        }

        // --- Core Rendering Logic ---
        function refreshDashboard() {
            const data = getFilteredData();
            if(globalDataMap.size === 0) return;
            
            // Reusable metrics (Pending handling)
            let total = data.length;
            let saved = data.filter(d => d._isSaved).length;
            let pending = data.filter(d => d._isPending).length;
            let resolvedCases = total - pending; 
            let rate = resolvedCases > 0 ? ((saved / resolvedCases) * 100).toFixed(1) : '0.0';
            
            // Top Level KPIs
            document.getElementById('kpiTotalCases').textContent = total.toLocaleString();
            document.getElementById('kpiSavedCases').textContent = saved.toLocaleString();
            document.getElementById('kpiPendingCases').textContent = pending.toLocaleString();
            document.getElementById('kpiRetentionRate').textContent = `${rate}%`;
            
            // Render specific tab
            if(currentActiveTab === 'overview') renderOverview(data);
            if(currentActiveTab === 'agents') renderAgents(data);
            if(currentActiveTab === 'reasons') renderReasons(data);
            if(currentActiveTab === 'data') renderDataTable(data);
        }

        function formatAgentName(emailStr) {
            let name = String(emailStr).split('@')[0].replace('.', ' ');
            return name.replace(/\b\w/g, l => l.toUpperCase());
        }

        function getTeamBadge(teamName) {
            if(teamName === 'Order Support') return '<span class="bg-blue-100 text-blue-700 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">Order Support</span>';
            if(teamName === 'Mentors') return '<span class="bg-purple-100 text-purple-700 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">Mentors</span>';
            return '<span class="bg-gray-100 text-gray-600 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">MX</span>';
        }

        // --- TAB 1: Overview Render ---
        function renderOverview(data) {
            const timelineMap = {};
            const statusMap = {};

            data.forEach(row => {
                const dayKey = row._parsedDate.toISOString().split('T')[0];
                if(!timelineMap[dayKey]) timelineMap[dayKey] = { total: 0, saved: 0, pending: 0 };
                timelineMap[dayKey].total++;
                if(row._isSaved) timelineMap[dayKey].saved++;
                if(row._isPending) timelineMap[dayKey].pending++;

                let stat = (row['Status'] || 'Unknown').trim();
                
                // Merge Closed and Resolved into a single category for the chart
                if (stat.toLowerCase() === 'closed' || stat.toLowerCase() === 'resolved') {
                    stat = 'Resolved / Closed';
                }
                
                statusMap[stat] = (statusMap[stat] || 0) + 1;
            });

            const sortedDays = Object.keys(timelineMap).sort();
            if(charts.trend) charts.trend.destroy();
            charts.trend = new Chart(document.getElementById('trendChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: sortedDays,
                    datasets: [
                        { label: 'Total Cases', data: sortedDays.map(d => timelineMap[d].total), borderColor: '#94a3b8', backgroundColor: 'transparent', borderDash: [5,5], tension: 0.3 },
                        { label: 'Saved Cases', data: sortedDays.map(d => timelineMap[d].saved), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
            });

            if(charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('statusChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusMap),
                    datasets: [{ data: Object.values(statusMap), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{boxWidth:12, font:{size:10}} } } }
            });
        }

        // --- TAB 2: Agents Render ---
        function renderAgents(data) {
            const agentStats = {};
            data.forEach(row => {
                const ag = row['Submitted By'];
                if(!agentStats[ag]) agentStats[ag] = { total: 0, saved: 0, pending: 0, reasons: {} };
                agentStats[ag].total++;
                
                if(row._isPending) {
                    agentStats[ag].pending++;
                } else if(row._isSaved) {
                    agentStats[ag].saved++;
                }
                
                const r = row._cleanReason;
                agentStats[ag].reasons[r] = (agentStats[ag].reasons[r] || 0) + 1;
            });

            let leaderboard = Object.keys(agentStats).map(ag => {
                const resolved = agentStats[ag].total - agentStats[ag].pending;
                return { 
                    agent: ag, 
                    team: getAgentTeam(ag),
                    total: agentStats[ag].total, 
                    saved: agentStats[ag].saved,
                    pending: agentStats[ag].pending,
                    resolved: resolved,
                    rate: resolved > 0 ? (agentStats[ag].saved / resolved)*100 : 0,
                    reasons: agentStats[ag].reasons
                };
            }).sort((a,b) => b.rate !== a.rate ? b.rate - a.rate : b.resolved - a.resolved);

            const tbody = document.getElementById('agentTableBody');
            tbody.innerHTML = '';
            
            leaderboard.forEach((entry, idx) => {
                const tr = document.createElement('tr');
                tr.className = `hover:bg-blue-50 cursor-pointer transition-colors border-b border-gray-50 ${selectedAgentForSnapshot === entry.agent ? 'bg-blue-50' : ''}`;
                tr.onclick = () => {
                    selectedAgentForSnapshot = entry.agent;
                    
                    document.getElementById('agentLeaderboardView').classList.add('hidden');
                    document.getElementById('agentLeaderboardView').classList.remove('flex');
                    document.getElementById('agentProfileView').classList.remove('hidden');
                    document.getElementById('agentProfileView').classList.add('flex');
                    
                    renderAgentSnapshot(entry, data);
                    
                    Array.from(tbody.children).forEach(r => r.classList.remove('bg-blue-50'));
                    tr.classList.add('bg-blue-50');
                };

                let medal = idx === 0 ? '' : idx === 1 ? '' : idx === 2 ? '' : '';
                tr.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap">
                        <div class="font-medium text-gray-900 flex items-center">${medal} ${formatAgentName(entry.agent)} ${getTeamBadge(entry.team)}</div>
                        <div class="text-[11px] text-gray-400 mt-0.5 ml-${medal ? '6' : '0'}">${entry.agent}</div>
                    </td>
                    <td class="py-4 px-6 text-center text-base">${entry.total}</td>
                    <td class="py-4 px-6 text-center text-base font-medium text-green-600">${entry.saved}</td>
                    <td class="py-4 px-6 text-center text-base font-medium text-yellow-600">${entry.pending}</td>
                    <td class="py-4 px-6">
                        <div class="flex items-center justify-end gap-3">
                            <div class="w-24 bg-gray-200 rounded-full h-2"><div class="bg-blue-600 h-2 rounded-full" style="width:${entry.rate}%"></div></div>
                            <span class="text-sm font-bold w-12 text-right">${entry.rate.toFixed(1)}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Ensure we show the appropriate view based on state
            if (selectedAgentForSnapshot) {
                const currentEntry = leaderboard.find(l => l.agent === selectedAgentForSnapshot);
                if (currentEntry) {
                    renderAgentSnapshot(currentEntry, data);
                } else {
                    window.backToLeaderboard();
                }
            } else {
                document.getElementById('agentProfileView').classList.add('hidden');
                document.getElementById('agentProfileView').classList.remove('flex');
                document.getElementById('agentLeaderboardView').classList.remove('hidden');
                document.getElementById('agentLeaderboardView').classList.add('flex');
            }
        }

        function renderAgentSnapshot(agentData, allFilteredData) {
            document.getElementById('selectedAgentTitle').innerHTML = `${formatAgentName(agentData.agent)} ${getTeamBadge(agentData.team)}`;
            document.getElementById('snapRate').textContent = `${agentData.rate.toFixed(1)}%`;
            document.getElementById('snapVol').textContent = agentData.resolved;

            const reasonsArr = Object.entries(agentData.reasons).map(([k,v]) => ({reason: k, count: v})).sort((a,b) => b.count - a.count).slice(0,5);
            
            if(charts.agentReason) charts.agentReason.destroy();
            charts.agentReason = new Chart(document.getElementById('agentReasonChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: reasonsArr.map(r => r.reason.length > 25 ? r.reason.substring(0,25)+'...' : r.reason),
                    datasets: [{ label: 'Cases', data: reasonsArr.map(r => r.count), backgroundColor: '#8b5cf6', borderRadius: 4 }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, ticks:{stepSize:1} } }
                }
            });

            // Setup globally for the list filter
            currentAgentSpecificTickets = allFilteredData.filter(d => d['Submitted By'] === agentData.agent);
            
            // Execute the render for tickets
            window.renderAgentTicketsList();
        }

        // --- TAB 3: Reasons Render ---
        function renderReasons(data) {
            const reasonCounts = {};
            data.forEach(row => {
                const r = row._cleanReason;
                if(!reasonCounts[r]) reasonCounts[r] = {total: 0, saved: 0, pending: 0};
                reasonCounts[r].total++;
                if(row._isSaved) reasonCounts[r].saved++;
                if(row._isPending) reasonCounts[r].pending++;
            });

            const sorted = Object.keys(reasonCounts)
                .map(k => ({reason: k, ...reasonCounts[k]}))
                .sort((a,b) => b.total - a.total)
                .slice(0, 15);

            if(charts.topReasons) charts.topReasons.destroy();
            charts.topReasons = new Chart(document.getElementById('topReasonsChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s.reason),
                    datasets: [
                        { label: 'Unsaved Cases', data: sorted.map(s => s.total - s.saved - s.pending), backgroundColor: '#cbd5e1', stacked: true },
                        { label: 'Saved Cases', data: sorted.map(s => s.saved), backgroundColor: '#3b82f6', stacked: true },
                        { label: 'Pending Cases', data: sorted.map(s => s.pending), backgroundColor: '#facc15', stacked: true }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        x: { stacked: true, ticks: { maxRotation: 45, minRotation: 45 } },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
        }

        // --- TAB 4: Data Table Render ---
        function renderDataTable(data) {
            const tbody = document.getElementById('rawDataTableBody');
            tbody.innerHTML = '';
            
            const displayData = data.slice(0, 500); 

            displayData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 group';
                
                const dStr = row._parsedDate.toLocaleString([], {year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
                const teamBadge = getTeamBadge(getAgentTeam(row['Submitted By']));

                let savedBadge = '';
                if(row._isPending) savedBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold">Pending</span>';
                else if(row._isSaved) savedBadge = '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold">Yes</span>';
                else savedBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold">No</span>';
                
                tr.innerHTML = `
                    <td class="py-2 px-4 border-b border-gray-100 whitespace-nowrap">${dStr}</td>
                    <td class="py-2 px-4 border-b border-gray-100 font-mono text-[10px] text-gray-500">${row['Ticket ID']}</td>
                    <td class="py-2 px-4 border-b border-gray-100 truncate max-w-[200px]" title="${row['Submitted By']}">
                        <div class="flex items-center">${formatAgentName(row['Submitted By'])} ${teamBadge}</div>
                    </td>
                    <td class="py-2 px-4 border-b border-gray-100 truncate max-w-[200px]" title="${row._cleanReason}">${row._cleanReason}</td>
                    <td class="py-2 px-4 border-b border-gray-100">${row['Status'] || ''}</td>
                    <td class="py-2 px-4 border-b border-gray-100">${savedBadge}</td>
                    <td class="py-2 px-4 border-b border-gray-100 text-right opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editRecord('${row['Ticket ID']}')" class="text-blue-500 hover:text-blue-700 mr-3" title="Edit Record"><i class="ph ph-pencil-simple text-base"></i></button>
                        <button onclick="deleteRecord('${row['Ticket ID']}')" class="text-red-400 hover:text-red-600" title="Delete Record"><i class="ph ph-trash text-base"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if(data.length > 500) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="7" class="py-3 text-center text-gray-400 italic">Showing latest 500 of ${data.length} records...</td>`;
                tbody.appendChild(tr);
            }
        }
    </script>
</body>
</html>
