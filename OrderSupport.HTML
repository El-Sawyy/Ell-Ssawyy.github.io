<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Advanced Retention MBR Dashboard</title>
    
    <!-- Stable CDNs for Production -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .drag-active { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .tab-active { color: #2563eb; border-bottom: 2px solid #2563eb; font-weight: 600; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; hover:border-gray-300; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden text-sm">

    <!-- Top Navigation -->
    <header class="bg-white shadow-sm z-20 border-b border-gray-200">
        <div class="max-w-[1600px] mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg">
                    <i class="ph ph-trend-up text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 leading-tight">Retention MBR Dashboard</h1>
                    <div class="flex items-center gap-2">
                        <p class="text-xs text-gray-500">Order Support Team Analytics</p>
                        <span class="bg-green-100 text-green-700 text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1 font-bold">
                            <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Live Sync
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="flex space-x-6" id="navTabs">
                <button onclick="switchTab('overview')" class="tab-active pb-1 px-1 transition-colors outline-none" data-tab="overview">Overview</button>
                <button onclick="switchTab('agents')" class="tab-inactive pb-1 px-1 transition-colors outline-none" data-tab="agents">Agent Performance</button>
                <button onclick="switchTab('insights')" class="tab-inactive pb-1 px-1 transition-colors outline-none" data-tab="insights">Insights & Channels</button>
                <button onclick="switchTab('types')" class="tab-inactive pb-1 px-1 transition-colors outline-none" data-tab="types">Request Types</button>
                <button onclick="switchTab('data')" class="tab-inactive pb-1 px-1 transition-colors outline-none" data-tab="data">Data Manager</button>
                <button onclick="switchTab('uploads')" class="tab-inactive pb-1 px-1 transition-colors outline-none" data-tab="uploads">Uploads</button>
            </div>
            
            <div class="flex items-center gap-3">
                <span class="text-xs font-medium bg-gray-100 text-gray-600 px-2 py-1 rounded-md" id="recordCountBadge">0 Records</span>
                <button onclick="openAddRecordModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-sm font-medium transition-colors flex items-center gap-1">
                    <i class="ph ph-plus"></i> Add Data
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Layout -->
    <main class="flex-1 flex overflow-hidden max-w-[1600px] w-full mx-auto">
        
        <!-- Sidebar: Global Controls -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col z-10 overflow-hidden shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            
            <!-- Upload Section -->
            <div class="p-4 border-b border-gray-100 bg-gray-50/50">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-1"><i class="ph ph-database"></i> Add to Database</h2>
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-colors bg-white" onclick="document.getElementById('csvFileInput').click()">
                    <i class="ph ph-cloud-arrow-up text-2xl text-blue-500 mb-1"></i>
                    <p class="text-xs text-gray-600 font-medium">Upload CSV or XLSX</p>
                    <p class="text-[10px] text-gray-400 mt-1">Manual Duplicate Validation</p>
                    <input type="file" id="csvFileInput" accept=".csv, .xlsx, .xls" class="hidden">
                </div>
            </div>

            <!-- Team Filter -->
            <div class="p-4 border-b border-gray-100">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-1"><i class="ph ph-users-three"></i> Team Filter</h2>
                <select id="teamFilter" class="w-full text-xs border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white cursor-pointer">
                    <option value="all">All Teams (Overall)</option>
                    <option value="order_support">Order Support</option>
                    <option value="mentors">Mentors</option>
                    <option value="mx">MX</option>
                </select>
            </div>

            <!-- Date Filter -->
            <div class="p-4 border-b border-gray-100">
                <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 flex items-center gap-1"><i class="ph ph-calendar-blank"></i> Date Range</h2>
                <div class="flex flex-col gap-2">
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">Start Date</label>
                        <input type="date" id="startDateFilter" class="w-full text-xs border border-gray-300 rounded p-1.5 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 block mb-1">End Date</label>
                        <input type="date" id="endDateFilter" class="w-full text-xs border border-gray-300 rounded p-1.5 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <button onclick="clearDateFilters()" class="text-xs text-blue-600 hover:text-blue-800 mt-1 text-left w-max">Clear Dates</button>
                </div>
            </div>

            <!-- Reason Filters -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <div class="p-4 pb-2 flex justify-between items-center bg-white">
                    <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1"><i class="ph ph-funnel"></i> Exclude Reasons</h2>
                    <button id="selectAllBtn" class="text-[10px] text-blue-600 hover:text-blue-800 font-bold bg-blue-50 px-2 py-1 rounded">Toggle All</button>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar px-4 pb-4" id="reasonFilterContainer">
                    <p class="text-xs text-gray-400 italic mt-2 text-center">No data loaded yet.</p>
                </div>
            </div>
        </aside>

        <!-- Dynamic Content Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 bg-[#f8fafc] relative" id="mainContent">
            
            <!-- Empty State Overlay -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center bg-[#f8fafc] z-10">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200 text-center max-w-md" id="emptyStateBox">
                    <div class="mx-auto w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4">
                        <i class="ph ph-spinner animate-spin text-3xl" id="emptyStateIcon"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 mb-2" id="emptyStateTitle">Connecting to Database...</h2>
                    <p class="text-gray-500 text-sm mb-6" id="emptyStateDesc">Please wait while we establish a secure connection to the live team data.</p>
                </div>
            </div>

            <!-- TAB 1: OVERVIEW -->
            <div id="tab-overview" class="tab-pane hidden flex-col gap-6">
                <!-- Summary KPI Cards -->
                <div class="grid grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1">Total Cases</p>
                        <h3 class="text-2xl font-bold text-gray-900" id="kpiTotalCases">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-2 bg-green-500"></div>
                        <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1">Prevented / Saved</p>
                        <h3 class="text-2xl font-bold text-green-600" id="kpiSavedCases">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-2 bg-yellow-400"></div>
                        <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1" title="Excluded from retention math">Pending Cases</p>
                        <h3 class="text-2xl font-bold text-yellow-600" id="kpiPendingCases">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden">
                        <div class="absolute right-0 top-0 bottom-0 w-2 bg-blue-600"></div>
                        <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-1" title="Based on resolved cases only">Overall Retention Rate</p>
                        <h3 class="text-2xl font-bold text-blue-600" id="kpiRetentionRate">0%</h3>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-6">
                    <!-- Timeline Chart -->
                    <div class="col-span-2 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-800 mb-4">Retention Trend Over Time</h3>
                        <div class="w-full h-72">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Status Distribution -->
                    <div class="col-span-1 bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="text-sm font-bold text-gray-800 mb-4">Ticket Status Breakdown</h3>
                        <div class="w-full h-64 flex justify-center">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 2: AGENTS (Drill-Down Setup) -->
            <div id="tab-agents" class="tab-pane hidden h-[calc(100vh-140px)] flex-col gap-6 pb-6">
                
                <!-- View 1: Leaderboard -->
                <div id="agentLeaderboardView" class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                    <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-gray-900">Agent Performance Leaderboard</h3>
                        <span class="text-xs text-gray-500 bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">Click any agent to view full profile & tickets</span>
                    </div>
                    <div class="overflow-y-auto flex-1 custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead class="sticky top-0 bg-white shadow-sm z-10">
                                <tr class="text-xs text-gray-500 uppercase tracking-wider">
                                    <th class="py-3 px-6 font-semibold bg-white border-b border-gray-100">Agent Name / Email</th>
                                    <th class="py-3 px-6 font-semibold text-center bg-white border-b border-gray-100">Total Cases</th>
                                    <th class="py-3 px-6 font-semibold text-center bg-white border-b border-gray-100">Saved</th>
                                    <th class="py-3 px-6 font-semibold text-center bg-white border-b border-gray-100 text-yellow-600">Pending</th>
                                    <th class="py-3 px-6 font-semibold text-right bg-white border-b border-gray-100">Retention Rate</th>
                                </tr>
                            </thead>
                            <tbody id="agentTableBody" class="divide-y divide-gray-100 text-gray-800">
                                <!-- Injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- View 2: Detailed Agent Profile -->
                <div id="agentProfileView" class="hidden flex-col h-full gap-4">
                    <!-- Top Toolbar for Profile -->
                    <div class="flex items-center justify-between shrink-0 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center gap-4">
                            <button onclick="backToLeaderboard()" class="flex items-center gap-1.5 text-sm font-medium text-gray-600 hover:text-blue-600 px-3 py-1.5 bg-gray-50 hover:bg-blue-50 rounded-md border border-gray-200 transition-colors">
                                <i class="ph ph-arrow-left text-lg"></i> Back to Leaderboard
                            </button>
                            <div class="w-px h-6 bg-gray-300"></div>
                            <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2" id="selectedAgentTitle">Agent Name</h3>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-2 gap-4 shrink-0">
                        <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase tracking-wider mb-2">Retention Rate</div>
                            <div class="text-4xl font-bold text-blue-600" id="snapRate">0%</div>
                        </div>
                        <div class="bg-white border border-gray-200 p-6 rounded-xl shadow-sm text-center">
                            <div class="text-sm text-gray-500 font-semibold uppercase tracking-wider mb-2">Resolved Volume</div>
                            <div class="text-4xl font-bold text-gray-900" id="snapVol">0</div>
                        </div>
                    </div>

                    <!-- Bottom Split: Charts & Tickets -->
                    <div class="grid grid-cols-2 gap-4 flex-1 min-h-0">
                        <!-- Left: Reasons Chart -->
                        <div class="bg-white border border-gray-200 p-5 rounded-xl shadow-sm flex flex-col">
                            <h4 class="text-sm font-bold text-gray-800 mb-4">Top Cancellation Reasons Handled</h4>
                            <div class="flex-1 relative min-h-[250px]">
                                <canvas id="agentReasonChart"></canvas>
                            </div>
                        </div>

                        <!-- Right: Ticket Validation List -->
                        <div class="bg-white border border-gray-200 rounded-xl shadow-sm flex flex-col overflow-hidden">
                            <div class="bg-gray-50 px-5 py-4 border-b border-gray-200 flex justify-between items-center shrink-0">
                                <h4 class="text-sm font-bold text-gray-800">Validation: Agent's Tickets</h4>
                                <div class="flex items-center gap-3">
                                    <select id="agentTicketFilter" class="text-xs border border-gray-300 rounded px-2 py-1 outline-none bg-white cursor-pointer" onchange="renderAgentTicketsList()">
                                        <option value="all">All Statuses</option>
                                        <option value="true">Saved (Yes)</option>
                                        <option value="false">Unsaved (No)</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                    <span class="text-xs text-gray-500" id="ticketListCount">0 records</span>
                                </div>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar p-0 bg-white">
                                <table class="w-full text-left text-xs whitespace-nowrap">
                                    <thead class="bg-white sticky top-0 shadow-sm z-10">
                                        <tr class="text-gray-500 uppercase">
                                            <th class="py-3 px-4 font-semibold border-b border-gray-100">Ticket / FC ID</th>
                                            <th class="py-3 px-4 font-semibold border-b border-gray-100">Order ID</th>
                                            <th class="py-3 px-4 font-semibold border-b border-gray-100 text-right">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agentTicketsBody" class="divide-y divide-gray-100">
                                        <!-- Drill down tickets go here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- TAB 3: INSIGHTS & CHANNELS -->
            <div id="tab-insights" class="tab-pane hidden flex-col gap-6">
                <!-- Top Row: Channels -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                        <div class="bg-gray-50 px-5 py-4 border-b border-gray-200">
                            <h3 class="text-sm font-bold text-gray-900">Channel Performance</h3>
                            <p class="text-xs text-gray-500">Volume and retention by request channel</p>
                        </div>
                        <div class="p-0 flex-1">
                            <table class="w-full text-left border-collapse whitespace-nowrap">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase tracking-wider bg-white">
                                        <th class="py-3 px-5 font-semibold border-b border-gray-100">Channel</th>
                                        <th class="py-3 px-5 font-semibold text-center border-b border-gray-100">Total</th>
                                        <th class="py-3 px-5 font-semibold text-center border-b border-gray-100">Saved</th>
                                        <th class="py-3 px-5 font-semibold text-right border-b border-gray-100">Rate</th>
                                    </tr>
                                </thead>
                                <tbody id="channelTableBody" class="divide-y divide-gray-100 text-sm">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-sm font-bold text-gray-900">Channel Retention Rate</h3>
                            </div>
                        </div>
                        <div class="w-full h-48 relative">
                            <canvas id="channelChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Reasons -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="mb-4">
                            <h3 class="text-sm font-bold text-gray-900">Cancellation Reasons (Why they leave)</h3>
                            <p class="text-xs text-gray-500">Sorted by total frequency. Excluded reasons hidden.</p>
                        </div>
                        <div class="w-full h-72 relative">
                            <canvas id="topReasonsChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="mb-4">
                            <h3 class="text-sm font-bold text-gray-900 flex items-center gap-2">
                                Prevention Strategies <span class="bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded font-bold">Saved Cases Only</span>
                            </h3>
                            <p class="text-xs text-gray-500">How we successfully retained customers (New Prevention Reason).</p>
                        </div>
                        <div class="w-full h-72 relative">
                            <canvas id="preventionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3.5: REQUEST TYPES -->
            <div id="tab-types" class="tab-pane hidden flex-col gap-6">
                <!-- Top Row: Overview -->
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden h-64">
                        <div class="bg-gray-50 px-5 py-4 border-b border-gray-200">
                            <h3 class="text-sm font-bold text-gray-900">Request Type Overview</h3>
                            <p class="text-xs text-gray-500">Volume and retention by ticket type</p>
                        </div>
                        <div class="overflow-y-auto flex-1 custom-scrollbar">
                            <table class="w-full text-left border-collapse whitespace-nowrap">
                                <thead class="sticky top-0 bg-white shadow-sm z-10">
                                    <tr class="text-xs text-gray-500 uppercase tracking-wider">
                                        <th class="py-3 px-5 font-semibold border-b border-gray-100">Request Type</th>
                                        <th class="py-3 px-5 font-semibold text-center border-b border-gray-100">Total</th>
                                        <th class="py-3 px-5 font-semibold text-center border-b border-gray-100">Saved</th>
                                        <th class="py-3 px-5 font-semibold text-right border-b border-gray-100">Rate</th>
                                    </tr>
                                </thead>
                                <tbody id="typesTableBody" class="divide-y divide-gray-100 text-sm">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-64 flex flex-col">
                        <div class="mb-2">
                            <h3 class="text-sm font-bold text-gray-900">Request Type Volume Distribution</h3>
                        </div>
                        <div class="w-full flex-1 relative">
                            <canvas id="typesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: Agent Breakdown -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-[500px] overflow-hidden">
                    <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center shrink-0">
                        <div>
                            <h3 class="text-sm font-bold text-gray-900">Agent Performance by Request Type</h3>
                            <p class="text-xs text-gray-500">Detailed breakdown of retention for each agent categorized under every request type.</p>
                        </div>
                    </div>
                    <div class="overflow-y-auto flex-1 custom-scrollbar p-0">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="sticky top-0 bg-white shadow-sm z-10">
                                <tr class="text-xs text-gray-500 uppercase tracking-wider">
                                    <th class="py-3 px-5 font-semibold border-b border-gray-200 pl-8">Agent Name</th>
                                    <th class="py-3 px-5 font-semibold text-center border-b border-gray-200">Total Cases</th>
                                    <th class="py-3 px-5 font-semibold text-center border-b border-gray-200 text-green-600">Saved</th>
                                    <th class="py-3 px-5 font-semibold text-center border-b border-gray-200 text-yellow-600">Pending</th>
                                    <th class="py-3 px-5 font-semibold text-right border-b border-gray-200 text-blue-600">Retention Rate</th>
                                </tr>
                            </thead>
                            <tbody id="agentTypeTableBody" class="divide-y divide-gray-100 text-sm">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 4: DATA MANAGER -->
            <div id="tab-data" class="tab-pane hidden flex-col h-full gap-4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                    <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center shrink-0">
                        <div>
                            <h3 class="text-sm font-bold text-gray-900">Live Team Database Explorer</h3>
                            <p class="text-xs text-gray-500">View, edit, or remove individual records affecting everyone's dashboard.</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <i class="ph ph-magnifying-glass absolute left-2.5 top-1.5 text-gray-400 text-sm"></i>
                                <input type="text" id="dataManagerSearch" placeholder="Search Order ID or Ticket ID..." class="text-xs border border-gray-300 rounded pl-7 pr-2 py-1.5 outline-none bg-white w-52 focus:border-blue-500 transition-colors">
                            </div>
                            <select id="dataManagerStatusFilter" class="text-xs border border-gray-300 rounded px-2 py-1.5 outline-none bg-white cursor-pointer">
                                <option value="all">All Statuses</option>
                                <option value="true">Saved (Yes)</option>
                                <option value="false">Unsaved (No)</option>
                                <option value="pending">Pending</option>
                            </select>
                            <button onclick="clearAllData()" class="text-xs text-red-600 hover:text-red-800 border border-red-200 hover:bg-red-50 px-3 py-1.5 rounded transition-colors flex items-center gap-1">
                                <i class="ph ph-trash"></i> Wipe Database
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto custom-scrollbar p-0">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="sticky top-0 bg-white shadow-sm z-10">
                                <tr class="text-xs text-gray-500 uppercase tracking-wider bg-gray-50">
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Date</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Ticket ID</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Agent</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Channel</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Req Type</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Reason / Prevention</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Status</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200">Prevented</th>
                                    <th class="py-2 px-4 font-semibold border-b border-gray-200 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="rawDataTableBody" class="divide-y divide-gray-100 text-xs">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Data Manager Pagination Footer -->
                    <div class="px-5 py-3 border-t border-gray-200 bg-white flex justify-between items-center shrink-0">
                        <div class="text-xs text-gray-500" id="dataManagerPaginationInfo">Showing 0 records</div>
                        <div class="flex items-center gap-2">
                            <button onclick="changeDataManagerPage(-1)" class="px-3 py-1.5 border border-gray-300 rounded text-xs hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" id="btnPrevPage">Previous</button>
                            <button onclick="changeDataManagerPage(1)" class="px-3 py-1.5 border border-gray-300 rounded text-xs hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" id="btnNextPage">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 5: UPLOADS HISTORY -->
            <div id="tab-uploads" class="tab-pane hidden flex-col h-full gap-4">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col h-full overflow-hidden">
                    <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <div>
                            <h3 class="text-sm font-bold text-gray-900">Upload History Manager</h3>
                            <p class="text-xs text-gray-500">Track and delete bulk files uploaded to the database.</p>
                        </div>
                    </div>
                    <div class="flex-1 overflow-auto custom-scrollbar p-0">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="sticky top-0 bg-white shadow-sm z-10">
                                <tr class="text-xs text-gray-500 uppercase tracking-wider bg-gray-50">
                                    <th class="py-3 px-5 font-semibold border-b border-gray-200">Date Uploaded</th>
                                    <th class="py-3 px-5 font-semibold border-b border-gray-200">File Name</th>
                                    <th class="py-3 px-5 font-semibold text-center border-b border-gray-200">Active Records</th>
                                    <th class="py-3 px-5 font-semibold border-b border-gray-200 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="uploadsTableBody" class="divide-y divide-gray-100 text-sm text-gray-700">
                                <!-- Uploads injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal for Adding/Editing Record -->
    <div id="recordModal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden transform transition-all modal-enter" id="recordModalContent">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold text-gray-900" id="modalTitle">Add Database Record</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[70vh]">
                <form id="recordForm" class="grid grid-cols-2 gap-4">
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Ticket ID (Primary Key)</label>
                        <input type="text" id="formTicketId" placeholder="Auto-generated if blank" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none disabled:bg-gray-100 disabled:text-gray-500">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Created Date</label>
                        <input type="datetime-local" id="formDate" required class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    
                    <div class="col-span-2">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Agent (Submitted By)</label>
                        <input type="text" id="formAgent" required placeholder="e.g. agent@company.com" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Order ID</label>
                        <input type="text" id="formOrderId" placeholder="Optional" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Freshchat Convo ID</label>
                        <input type="text" id="formFreshchatId" placeholder="Optional" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>
                    
                    <div class="col-span-1 border-t border-gray-100 pt-3 mt-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Request Channel</label>
                        <select id="formChannel" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="Chat">Chat</option>
                            <option value="Call">Call</option>
                            <option value="Email">Email</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="col-span-1 border-t border-gray-100 pt-3 mt-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Request Type</label>
                        <input type="text" id="formRequestType" placeholder="e.g. Order Return..." class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>

                    <div class="col-span-2">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Cancellation Reason</label>
                        <input type="text" id="formReason" required placeholder="e.g. Pricing, Content, etc." list="reasonSuggestions" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <datalist id="reasonSuggestions"></datalist>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Prevention Reason (If Saved)</label>
                        <input type="text" id="formPreventionReason" placeholder="e.g. Concession Offered, Account Paused..." class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                    </div>

                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Status</label>
                        <select id="formStatus" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="Resolved">Resolved</option>
                            <option value="Closed">Closed</option>
                            <option value="Open">Open</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Request Prevented?</label>
                        <select id="formPrevented" class="w-full text-sm border border-gray-300 rounded p-2 focus:ring-blue-500 focus:border-blue-500 outline-none bg-white">
                            <option value="False">No (False)</option>
                            <option value="True">Yes (True)</option>
                            <option value="Pending">Pending (Excluded from Rate)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="px-6 py-4 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-800">Cancel</button>
                <button onclick="saveRecord()" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors flex items-center gap-2"><i class="ph ph-cloud-check"></i> Sync Record</button>
            </div>
        </div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflictModal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl overflow-hidden transform transition-all modal-enter" id="conflictModalContent">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center bg-yellow-50 text-yellow-800">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="ph ph-warning-circle text-2xl text-yellow-600"></i> Data Conflict Detected (<span id="conflictProgress">1/1</span>)
                </h3>
                <span class="text-xs font-bold px-3 py-1 bg-yellow-200 rounded-full uppercase tracking-wider" id="conflictTypeBadge">Duplicate ID</span>
            </div>
            
            <div class="p-6 bg-gray-50 flex gap-6">
                <!-- Existing Record -->
                <div class="flex-1 bg-white p-5 rounded-xl border border-gray-200 shadow-sm opacity-80">
                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 border-b border-gray-100 pb-2">Currently in Database</h4>
                    <div id="conflictExistingContent" class="space-y-3 text-sm text-gray-700">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- Spacer/Icon -->
                <div class="flex flex-col justify-center items-center">
                    <div class="w-10 h-10 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center shadow-inner">
                        <i class="ph ph-arrows-left-right text-xl"></i>
                    </div>
                </div>

                <!-- Incoming Record -->
                <div class="flex-1 bg-white p-5 rounded-xl border-2 border-blue-300 shadow-[0_0_15px_rgba(59,130,246,0.15)] relative">
                    <div class="absolute -top-3 right-4 bg-blue-600 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-sm">New Upload</div>
                    <h4 class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-4 border-b border-blue-50 pb-2">Incoming Record</h4>
                    <div id="conflictIncomingContent" class="space-y-3 text-sm text-gray-800">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-gray-200 bg-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <button onclick="abortUpload()" class="px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded transition-colors">Cancel Entire Upload</button>
                    <label class="flex items-center gap-2 cursor-pointer ml-4 border-l border-gray-200 pl-4 text-sm text-gray-600">
                        <input type="checkbox" id="conflictApplyAll" class="w-4 h-4 text-blue-600 rounded cursor-pointer border-gray-300">
                        Apply choice to all remaining conflicts
                    </label>
                </div>
                <div class="flex gap-2">
                    <button onclick="resolveConflict('keep_existing')" class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded hover:bg-gray-50 transition-colors" title="Ignore the uploaded row">Keep Existing</button>
                    <button onclick="resolveConflict('keep_both')" class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded hover:bg-gray-50 transition-colors" title="Generate a new unique Ticket ID for the uploaded row">Keep Both</button>
                    <button onclick="resolveConflict('update')" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition-colors shadow-sm" title="Overwrite the existing database row">Update with New</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Realtime Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Team Definitions
        const TEAM_ORDER_SUPPORT = [
            'mohamed.kheer@tempo.fit',
            'rima.khaled@tempo.fit',
            'santos.nyikang@tempo.fit',
            'youkabed.farid@tempo.fit',
            'ahmed.elsawy@tempo.fit'
        ];
        
        const TEAM_MENTORS = [
            'noha.radwan@tempo.fit',
            'rashad.mohamed@tempo.fit',
            'emad.mohamed@tempo.fit'
        ];

        function getAgentTeam(emailStr) {
            const email = String(emailStr).trim().toLowerCase();
            if (TEAM_ORDER_SUPPORT.includes(email)) return 'Order Support';
            if (TEAM_MENTORS.includes(email)) return 'Mentors';
            return 'MX';
        }

        // Global State
        let globalDataMap = new Map(); 
        let uniqueReasons = new Set();
        let excludedReasons = new Set();
        let charts = { trend: null, status: null, topReasons: null, agentReason: null, channel: null, prevention: null, requestTypes: null };
        let currentActiveTab = 'overview';
        let selectedAgentForSnapshot = null;
        let currentAgentSpecificTickets = []; 

        // Upload Conflict State
        let uploadConflicts = [];
        let uploadReady = [];
        let currentConflictIdx = 0;

        // Pagination State
        let dataManagerCurrentPage = 1;
        const dataManagerRowsPerPage = 100;

        // Firebase Auth Variables
        let app, auth, db, user = null;
        
        const appId = 'order-support-retention'; 
        const firebaseConfig = {
            apiKey: "AIzaSyAdEiz5ZHa8T6qgReekxYCtjHppPZ66kA8",
            authDomain: "order-support-retention.firebaseapp.com",
            projectId: "order-support-retention",
            storageBucket: "order-support-retention.firebasestorage.app",
            messagingSenderId: "930779552737",
            appId: "1:930779552737:web:857e66b4307e647d9e50a0"
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            setupUIControls();
            
            if (firebaseConfig) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                try {
                    await signInAnonymously(auth);
                } catch (err) {
                    console.error("Auth Error", err);
                    showEmptyState("Authentication Failed", "Could not connect to the database. Refresh to try again.", "ph-warning-circle text-red-500");
                }

                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        setupRealtimeListener();
                    }
                });
            } else {
                showEmptyState("Database Not Found", "Firebase configuration is missing in this environment.", "ph-database text-red-500");
            }
        });

        function setupRealtimeListener() {
            const dataRef = collection(db, 'artifacts', appId, 'public', 'data', 'retention_records');
            onSnapshot(dataRef, (snapshot) => {
                globalDataMap.clear();
                uniqueReasons.clear();
                
                snapshot.forEach(docSnap => {
                    const row = docSnap.data();
                    row._parsedDate = new Date(row._timestamp || row['Created date']);
                    globalDataMap.set(docSnap.id, row);
                    uniqueReasons.add(row._cleanReason);
                });
                
                updateFilterSidebar();
                updateUIState();
                refreshDashboard();
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                showEmptyState("Connection Error", "Lost connection to the database. Trying to reconnect...", "ph-wifi-slash text-red-500");
            });
        }

        // --- UI & Utility Hooks ---
        function setupUIControls() {
            window.switchTab = function(tabId) {
                currentActiveTab = tabId;
                document.querySelectorAll('#navTabs button').forEach(btn => {
                    btn.className = btn.dataset.tab === tabId ? 'tab-active pb-1 px-1 transition-colors outline-none' : 'tab-inactive pb-1 px-1 transition-colors outline-none';
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.add('hidden'); pane.classList.remove('flex');
                });
                if (globalDataMap.size > 0) {
                    const activePane = document.getElementById(`tab-${tabId}`);
                    if (activePane) {
                        activePane.classList.remove('hidden'); 
                        activePane.classList.add('flex');
                    }
                    refreshDashboard();
                }
            };

            window.backToLeaderboard = function() {
                selectedAgentForSnapshot = null;
                document.getElementById('agentProfileView')?.classList.add('hidden');
                document.getElementById('agentProfileView')?.classList.remove('flex');
                document.getElementById('agentLeaderboardView')?.classList.remove('hidden');
                document.getElementById('agentLeaderboardView')?.classList.add('flex');
                
                const tbody = document.getElementById('agentTableBody');
                if (tbody) {
                    Array.from(tbody.children).forEach(r => r.classList.remove('bg-blue-50'));
                }
            };

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('csvFileInput');
            if (dropZone && fileInput) {
                dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-active'); });
                ['dragleave', 'dragend'].forEach(type => dropZone.addEventListener(type, () => dropZone.classList.remove('drag-active')));
                dropZone.addEventListener('drop', e => {
                    e.preventDefault(); dropZone.classList.remove('drag-active');
                    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
                });
                fileInput.addEventListener('change', e => {
                    if (e.target.files.length) handleFile(e.target.files[0]);
                    fileInput.value = ''; 
                });
            }

            document.getElementById('startDateFilter')?.addEventListener('change', refreshDashboard);
            document.getElementById('endDateFilter')?.addEventListener('change', refreshDashboard);
            document.getElementById('teamFilter')?.addEventListener('change', refreshDashboard);
            
            document.getElementById('dataManagerStatusFilter')?.addEventListener('change', () => {
                dataManagerCurrentPage = 1;
                renderDataTable(getFilteredData());
            });

            document.getElementById('dataManagerSearch')?.addEventListener('input', () => {
                dataManagerCurrentPage = 1;
                renderDataTable(getFilteredData());
            });

            window.clearDateFilters = function() {
                const start = document.getElementById('startDateFilter');
                const end = document.getElementById('endDateFilter');
                if (start) start.value = '';
                if (end) end.value = '';
                refreshDashboard();
            };

            window.changeDataManagerPage = function(delta) {
                dataManagerCurrentPage += delta;
                renderDataTable(getFilteredData());
            };

            window.openAddRecordModal = function() {
                document.getElementById('recordForm')?.reset();
                if (document.getElementById('modalTitle')) document.getElementById('modalTitle').textContent = 'Add Database Record';
                if (document.getElementById('formTicketId')) document.getElementById('formTicketId').disabled = false;
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                if (document.getElementById('formDate')) document.getElementById('formDate').value = now.toISOString().slice(0,16);
                document.getElementById('recordModal')?.classList.remove('hidden');
                setTimeout(() => { document.getElementById('recordModalContent')?.classList.add('modal-enter-active'); }, 10);
            };
            window.closeModal = function() {
                document.getElementById('recordModalContent')?.classList.remove('modal-enter-active');
                setTimeout(() => { document.getElementById('recordModal')?.classList.add('hidden'); }, 200);
            };

            window.renderAgentTicketsList = function() {
                const filterEl = document.getElementById('agentTicketFilter');
                if (!filterEl) return;
                const filterVal = filterEl.value;
                const tbody = document.getElementById('agentTicketsBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                let filtered = currentAgentSpecificTickets;
                if (filterVal === 'true') filtered = filtered.filter(t => t._isSaved && !t._isPending);
                else if (filterVal === 'false') filtered = filtered.filter(t => !t._isSaved && !t._isPending);
                else if (filterVal === 'pending') filtered = filtered.filter(t => t._isPending);
                
                const countEl = document.getElementById('ticketListCount');
                if (countEl) countEl.textContent = `${filtered.length} records`;
                
                filtered.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-blue-50 transition-colors";
                    
                    let savedBadge = '';
                    if(t._isPending) savedBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold">Pending</span>';
                    else if(t._isSaved) savedBadge = '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold">Yes</span>';
                    else savedBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold">No</span>';

                    tr.innerHTML = `
                        <td class="py-3 px-4 border-b border-gray-100">
                            <div class="font-mono text-[11px] text-gray-800 font-medium">TKT: ${t['Ticket ID']}</div>
                            <div class="font-mono text-[10px] text-gray-400 mt-1" title="Freshchat Conv ID">FC: ${t['Freshchat Conversation ID'] || '-'}</div>
                        </td>
                        <td class="py-3 px-4 border-b border-gray-100 font-mono text-[11px] text-gray-600">
                            ${t['Order ID'] || '-'}
                        </td>
                        <td class="py-3 px-4 border-b border-gray-100 text-right">
                            ${savedBadge}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            };
        }

        function showEmptyState(title, desc, iconClass) {
            document.getElementById('emptyState')?.classList.remove('hidden');
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            
            const iconEl = document.getElementById('emptyStateIcon');
            const titleEl = document.getElementById('emptyStateTitle');
            const descEl = document.getElementById('emptyStateDesc');
            
            if(iconEl) iconEl.className = `ph ${iconClass} text-4xl`;
            if(titleEl) titleEl.textContent = title;
            if(descEl) descEl.textContent = desc;
            
            if(title === "Database Connected. Awaiting Data.") {
                 if(!document.getElementById('btnUploadStart')) {
                     const btn = document.createElement('button');
                     btn.id = 'btnUploadStart';
                     btn.className = "bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors w-full mt-4 flex justify-center items-center gap-2";
                     btn.innerHTML = `<i class="ph ph-cloud-arrow-up text-xl"></i> Upload Data to Start`;
                     btn.onclick = () => document.getElementById('csvFileInput').click();
                     document.getElementById('emptyStateBox')?.appendChild(btn);
                 }
            } else {
                const btn = document.getElementById('btnUploadStart');
                if(btn) btn.remove();
            }
        }

        function updateUIState() {
            if (globalDataMap.size === 0) {
                showEmptyState("Database Connected. Awaiting Data.", "Upload your CSV/XLSX. Duplicates will be safely updated based on Ticket ID.", "ph-database text-blue-500");
            } else {
                document.getElementById('emptyState')?.classList.add('hidden');
                const activePane = document.getElementById(`tab-${currentActiveTab}`);
                if (activePane) {
                    activePane.classList.remove('hidden');
                    activePane.classList.add('flex');
                }
            }
            const count = getFilteredData().length;
            const badge = document.getElementById('recordCountBadge');
            if(badge) badge.textContent = `${count} Records`;
        }

        // --- File Upload & Firebase Batch Sync with Conflict Resolution ---
        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                alert('Please upload a valid CSV or Excel file.');
                return;
            }

            if (fileName.endsWith('.csv')) {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: results => processUpload(results.data, file.name), error: err => alert('CSV Error: ' + err.message) });
            } else {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                        const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false});
                        processUpload(data, file.name);
                    } catch (err) { alert('Excel Error: ' + err.message); }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        function processUpload(dataArray, originalFileName) {
            if (!user) { alert("Not authenticated to database yet. Please wait."); return; }
            showEmptyState("Analyzing Upload...", "Checking for duplicates against live data.", "ph-spinner animate-spin text-blue-500");

            const batchId = 'BATCH_' + Date.now();
            const batchDate = new Date().toISOString();
            
            // Build Map for Order IDs mapping to their existing Ticket IDs for conflict checks
            const existingOrderMap = new Map();
            globalDataMap.forEach(row => {
                if(row['Order ID'] && row['Order ID'].trim() !== '') {
                    existingOrderMap.set(row['Order ID'].trim(), row);
                }
            });

            // Deduplicate incoming array by Ticket ID initially
            const incomingMap = new Map();
            dataArray.forEach(rawRow => {
                if(!rawRow['Submitted By'] || rawRow['Submitted By'].trim() === '') return;

                let tId = rawRow['Ticket ID'] || rawRow['ticket_id'] || rawRow['Freshchat Conversation ID'];
                if (!tId || String(tId).trim() === '') { tId = 'TKT-' + Math.random().toString(36).substr(2, 9).toUpperCase(); }
                tId = String(tId).trim();

                const pStr = String(rawRow['New Request Prevented'] || '').trim().toLowerCase();
                const isPending = (pStr === 'pending');
                const isSaved = (pStr === 'true' || pStr === 'yes' || pStr === '1');

                let parsedDate = new Date(rawRow['Created date'] || new Date());
                if (isNaN(parsedDate.getTime())) parsedDate = new Date();
                
                let cleanReason = (rawRow['Cancellation & Return Reason'] || 'Unspecified').trim();
                if(cleanReason === '') cleanReason = 'Unspecified';

                const orderId = String(rawRow['Order ID'] || rawRow['order_id'] || '').trim();
                const fcId = String(rawRow['Freshchat Conversation ID'] || rawRow['freshchat_conversation_id'] || '').trim();
                
                const channel = String(rawRow['Order Request Channel'] || rawRow['Source'] || 'Unknown').trim();
                const prevReason = String(rawRow['New Prevention Reason'] || '').trim();

                let reqTypeRaw = String(rawRow['Order Request Type'] || 'Unknown').trim();
                let lowerReqType = reqTypeRaw.toLowerCase();
                if (['membership cancellation', 'mnca', 'account deletion', 'byod - membership cancellation'].includes(lowerReqType)) {
                    reqTypeRaw = 'Membership Cancellation';
                }

                incomingMap.set(tId, {
                    'Ticket ID': tId,
                    'Submitted By': rawRow['Submitted By'].trim(),
                    'Created date': parsedDate.toISOString(),
                    'Order ID': orderId,
                    'Freshchat Conversation ID': fcId,
                    'Cancellation & Return Reason': cleanReason,
                    'New Prevention Reason': prevReason,
                    'Order Request Channel': channel,
                    'Order Request Type': reqTypeRaw,
                    'Status': rawRow['Status'] || '',
                    'New Request Prevented': rawRow['New Request Prevented'] || '',
                    '_isSaved': isSaved,
                    '_isPending': isPending,
                    '_cleanReason': cleanReason,
                    '_preventionReason': prevReason,
                    '_channel': channel,
                    '_requestType': reqTypeRaw,
                    '_timestamp': parsedDate.getTime(),
                    '_batchId': batchId,
                    '_batchName': originalFileName,
                    '_batchDate': batchDate
                });
            });

            uploadReady = [];
            uploadConflicts = [];
            currentConflictIdx = 0;

            for (const [tId, inRow] of incomingMap.entries()) {
                let hasConflict = false;
                let conflictObj = { incoming: inRow, type: null, existing: null };

                if (globalDataMap.has(tId)) {
                    hasConflict = true;
                    conflictObj.type = 'Ticket ID';
                    conflictObj.existing = globalDataMap.get(tId);
                } else if (inRow['Order ID'] && existingOrderMap.has(inRow['Order ID'])) {
                    hasConflict = true;
                    conflictObj.type = 'Order ID';
                    conflictObj.existing = existingOrderMap.get(inRow['Order ID']);
                }

                if (hasConflict) uploadConflicts.push(conflictObj);
                else uploadReady.push(inRow);
            }

            if (uploadConflicts.length > 0) {
                // Remove checkbox setting if it was set previously
                const cb = document.getElementById('conflictApplyAll');
                if (cb) cb.checked = false;
                showConflictModal();
            } else {
                finalizeUploadBatch();
            }
        }

        function showConflictModal() {
            const conflict = uploadConflicts[currentConflictIdx];
            document.getElementById('conflictProgress').textContent = `${currentConflictIdx + 1} of ${uploadConflicts.length}`;
            document.getElementById('conflictTypeBadge').textContent = `Duplicate ${conflict.type}`;
            
            const formatRow = (row) => {
                let savedHtml = row._isPending ? '<span class="text-yellow-600 font-bold">Pending</span>' : (row._isSaved ? '<span class="text-green-600 font-bold">Yes (Saved)</span>' : '<span class="text-gray-600 font-bold">No (Unsaved)</span>');
                return `
                <div class="grid grid-cols-[100px_1fr] gap-x-2 gap-y-3">
                    <span class="text-gray-500 text-xs font-semibold uppercase self-center">Ticket ID:</span> <span class="font-mono font-medium">${row['Ticket ID']}</span>
                    <span class="text-gray-500 text-xs font-semibold uppercase self-center">Order ID:</span> <span class="font-mono">${row['Order ID'] || '-'}</span>
                    <span class="text-gray-500 text-xs font-semibold uppercase self-center">Date:</span> <span>${new Date(row._timestamp).toLocaleString()}</span>
                    <span class="text-gray-500 text-xs font-semibold uppercase self-center">Agent:</span> <span>${row['Submitted By']}</span>
                    <span class="text-gray-500 text-xs font-semibold uppercase self-center">Status:</span> <span>${row['Status']}</span>
                    <span class="text-gray-500 text-xs font-semibold uppercase self-center">Prevented:</span> <span>${savedHtml}</span>
                    <span class="text-gray-500 text-xs font-semibold uppercase self-start mt-0.5">Reason:</span> <span class="leading-snug">${row._cleanReason}</span>
                    <span class="text-gray-500 text-xs font-semibold uppercase self-start mt-0.5">Prevention:</span> <span class="leading-snug text-green-700">${row._preventionReason || '-'}</span>
                </div>
            `};

            document.getElementById('conflictExistingContent').innerHTML = formatRow(conflict.existing);
            document.getElementById('conflictIncomingContent').innerHTML = formatRow(conflict.incoming);

            document.getElementById('conflictModal').classList.remove('hidden');
            setTimeout(() => { document.getElementById('conflictModalContent').classList.add('modal-enter-active'); }, 10);
        }

        window.resolveConflict = function(decision) {
            const applyToAll = document.getElementById('conflictApplyAll').checked;

            if (applyToAll) {
                while (currentConflictIdx < uploadConflicts.length) {
                    processConflict(uploadConflicts[currentConflictIdx], decision);
                    currentConflictIdx++;
                }
            } else {
                processConflict(uploadConflicts[currentConflictIdx], decision);
                currentConflictIdx++;
            }

            if (currentConflictIdx < uploadConflicts.length) {
                showConflictModal();
            } else {
                // Done with conflicts
                document.getElementById('conflictModalContent').classList.remove('modal-enter-active');
                setTimeout(() => { 
                    document.getElementById('conflictModal').classList.add('hidden'); 
                    finalizeUploadBatch();
                }, 200);
            }
        };

        function processConflict(conflict, decision) {
            const inRow = {...conflict.incoming}; 
            const exRow = conflict.existing;

            if (decision === 'keep_existing') {
                // Discard incoming, do nothing
            } else if (decision === 'keep_both') {
                // Modify Ticket ID to prevent overwrite
                if (conflict.type === 'Ticket ID' || inRow['Ticket ID'] === exRow['Ticket ID']) {
                    inRow['Ticket ID'] = inRow['Ticket ID'] + '-DUP-' + Math.floor(Math.random()*10000);
                }
                uploadReady.push(inRow);
            } else if (decision === 'update') {
                // Replace logic
                if (conflict.type === 'Order ID' && inRow['Ticket ID'] !== exRow['Ticket ID']) {
                    // Mark old row for deletion during batch commit
                    inRow._deleteOldId = exRow['Ticket ID'];
                } else {
                    // Force overwrite existing Ticket ID document
                    inRow['Ticket ID'] = exRow['Ticket ID']; 
                }
                uploadReady.push(inRow);
            }
        }

        window.abortUpload = function() {
            uploadReady = [];
            uploadConflicts = [];
            document.getElementById('conflictModalContent').classList.remove('modal-enter-active');
            setTimeout(() => { 
                document.getElementById('conflictModal').classList.add('hidden'); 
                updateUIState();
            }, 200);
        }

        async function finalizeUploadBatch() {
            if (uploadReady.length === 0) {
                updateUIState();
                return; // Nothing to upload
            }

            showEmptyState("Syncing to Cloud Database...", `Uploading ${uploadReady.length} records to database.`, "ph-spinner animate-spin text-blue-500");
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'retention_records');
            let firestoreBatch = writeBatch(db);
            let count = 0;

            try {
                for (const rowData of uploadReady) {
                    // If we resolved an Order ID conflict by updating, delete the old mismatched Ticket ID
                    if (rowData._deleteOldId) {
                        const safeOldId = rowData._deleteOldId.replace(/[^a-zA-Z0-9_-]/g, '_');
                        firestoreBatch.delete(doc(collectionRef, safeOldId));
                        count++;
                    }
                    
                    const safeTId = rowData['Ticket ID'].replace(/[^a-zA-Z0-9_-]/g, '_'); 
                    const docRef = doc(collectionRef, safeTId);
                    
                    // Clean up temp field before sending to Firebase
                    const finalRowData = {...rowData};
                    delete finalRowData._deleteOldId;

                    firestoreBatch.set(docRef, finalRowData); 
                    count++;

                    if (count >= 490) { 
                        await firestoreBatch.commit();
                        firestoreBatch = writeBatch(db);
                        count = 0;
                    }
                }
                if (count > 0) await firestoreBatch.commit();
            } catch (err) {
                console.error("Batch Sync Error:", err);
                alert("An error occurred while saving to the database. Check console.");
            } finally {
                updateUIState();
            }
        }

        // --- Manual Database Writes ---
        window.editRecord = function(ticketId) {
            const record = globalDataMap.get(ticketId);
            if(!record) return;
            
            if (document.getElementById('modalTitle')) document.getElementById('modalTitle').textContent = 'Edit Database Record';
            if (document.getElementById('formTicketId')) {
                document.getElementById('formTicketId').value = record['Ticket ID'];
                document.getElementById('formTicketId').disabled = true; 
            }
            
            const localDate = new Date(record._timestamp);
            localDate.setMinutes(localDate.getMinutes() - localDate.getTimezoneOffset());
            if (document.getElementById('formDate')) document.getElementById('formDate').value = localDate.toISOString().slice(0,16);
            
            if (document.getElementById('formAgent')) document.getElementById('formAgent').value = record['Submitted By'];
            if (document.getElementById('formReason')) document.getElementById('formReason').value = record['Cancellation & Return Reason'];
            if (document.getElementById('formPreventionReason')) document.getElementById('formPreventionReason').value = record['New Prevention Reason'] || '';
            if (document.getElementById('formStatus')) document.getElementById('formStatus').value = record['Status'];
            
            // Set Channel
            const chan = record['_channel'] || 'Unknown';
            const chanEl = document.getElementById('formChannel');
            if (chanEl) {
                let selChan = Array.from(chanEl.options).find(o => o.value.toLowerCase() === chan.toLowerCase());
                if(selChan) chanEl.value = selChan.value;
                else chanEl.value = 'Unknown';
            }
            
            if (document.getElementById('formRequestType')) document.getElementById('formRequestType').value = record['_requestType'] || '';
            
            let prevVal = "False";
            if (record._isPending) prevVal = "Pending";
            else if (record._isSaved) prevVal = "True";
            if (document.getElementById('formPrevented')) document.getElementById('formPrevented').value = prevVal;
            
            if (document.getElementById('formOrderId')) document.getElementById('formOrderId').value = record['Order ID'] || '';
            if (document.getElementById('formFreshchatId')) document.getElementById('formFreshchatId').value = record['Freshchat Conversation ID'] || '';

            document.getElementById('recordModal')?.classList.remove('hidden');
            setTimeout(() => { document.getElementById('recordModalContent')?.classList.add('modal-enter-active'); }, 10);
        };

        window.saveRecord = async function() {
            if (!user) return;
            
            let tId = document.getElementById('formTicketId')?.value.trim();
            if(!tId && !document.getElementById('formTicketId')?.disabled) {
                tId = 'MANUAL-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            }
            
            const agent = document.getElementById('formAgent')?.value.trim();
            const dateStr = document.getElementById('formDate')?.value;
            const reason = document.getElementById('formReason')?.value.trim() || 'Unspecified';
            const prevReason = document.getElementById('formPreventionReason')?.value.trim();
            const channel = document.getElementById('formChannel')?.value;
            let reqTypeRaw = document.getElementById('formRequestType')?.value.trim() || 'Unknown';
            const status = document.getElementById('formStatus')?.value;
            const preventedRaw = document.getElementById('formPrevented')?.value;
            
            const orderId = document.getElementById('formOrderId')?.value.trim();
            const fcId = document.getElementById('formFreshchatId')?.value.trim();

            if(!agent || !dateStr) { alert("Agent and Date are required."); return; }
            
            // Re-enforce Normalization on Manual Save
            if (['membership cancellation', 'mnca', 'account deletion', 'byod - membership cancellation'].includes(reqTypeRaw.toLowerCase())) {
                reqTypeRaw = 'Membership Cancellation';
            }

            const isPending = (preventedRaw.toLowerCase() === 'pending');
            const isSaved = (preventedRaw.toLowerCase() === 'true' || preventedRaw.toLowerCase() === 'yes');

            const existingRecord = globalDataMap.get(tId);

            const row = {
                'Ticket ID': tId,
                'Submitted By': agent,
                'Created date': new Date(dateStr).toISOString(),
                'Order ID': orderId,
                'Freshchat Conversation ID': fcId,
                'Cancellation & Return Reason': reason,
                'New Prevention Reason': prevReason,
                'Order Request Channel': channel,
                'Order Request Type': reqTypeRaw,
                'Status': status,
                'New Request Prevented': preventedRaw,
                '_isSaved': isSaved,
                '_isPending': isPending,
                '_cleanReason': reason,
                '_preventionReason': prevReason,
                '_channel': channel,
                '_requestType': reqTypeRaw,
                '_timestamp': new Date(dateStr).getTime(),
                '_batchId': existingRecord ? existingRecord._batchId : null,
                '_batchName': existingRecord ? existingRecord._batchName : 'Manual Entry',
                '_batchDate': existingRecord ? existingRecord._batchDate : null
            };

            try {
                const safeTId = tId.replace(/[^a-zA-Z0-9_-]/g, '_');
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'retention_records', safeTId);
                await setDoc(docRef, row);
                window.closeModal();
            } catch(err) { console.error(err); alert("Failed to sync record manually."); }
        };

        window.deleteRecord = async function(ticketId) {
            if (!user) return;
            if(confirm('Delete this record permanently from the database? Everyone will lose access to it.')) {
                try {
                    const safeTId = ticketId.replace(/[^a-zA-Z0-9_-]/g, '_');
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'retention_records', safeTId);
                    await deleteDoc(docRef);
                } catch(err) { console.error(err); alert("Failed to delete record."); }
            }
        };

        window.deleteBatch = async function(batchId) {
            if (!user) return;
            if(confirm('Are you sure you want to completely delete all tickets that were last updated by this specific file upload? This cannot be undone.')) {
                showEmptyState("Removing Uploaded File...", "Deleting associated records from the database.", "ph-spinner animate-spin text-red-500");
                try {
                    let firestoreBatch = writeBatch(db);
                    let count = 0;
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'retention_records');
                    
                    for (const [id, row] of globalDataMap.entries()) {
                        if (row._batchId === batchId) {
                            const docRef = doc(colRef, id);
                            firestoreBatch.delete(docRef);
                            count++;
                            if (count === 490) {
                                await firestoreBatch.commit();
                                firestoreBatch = writeBatch(db);
                                count = 0;
                            }
                        }
                    }
                    if (count > 0) await firestoreBatch.commit();
                    
                } catch (err) { console.error(err); alert("Failed to delete the uploaded file."); updateUIState(); }
            }
        };

        window.clearAllData = async function() {
            if (!user) return;
            if(confirm('DANGER: This will PERMANENTLY erase all data in the database for the entire team. Are you completely sure?')) {
                try {
                    showEmptyState("Erasing Database...", "Cleaning up all team records.", "ph-spinner animate-spin text-red-500");
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'retention_records');
                    const snapshot = await getDocs(colRef);
                    let batch = writeBatch(db);
                    let count = 0;
                    for (const docSnap of snapshot.docs) {
                        batch.delete(docSnap.ref);
                        count++;
                        if(count === 490) {
                            await batch.commit();
                            batch = writeBatch(db);
                            count = 0;
                        }
                    }
                    if(count > 0) await batch.commit();
                    
                    if (document.getElementById('startDateFilter')) document.getElementById('startDateFilter').value = '';
                    if (document.getElementById('endDateFilter')) document.getElementById('endDateFilter').value = '';
                    excludedReasons.clear();
                } catch (err) { console.error(err); alert("Failed to erase database."); }
            }
        };

        // --- Filtering Engine ---
        function updateFilterSidebar() {
            const container = document.getElementById('reasonFilterContainer');
            const dataList = document.getElementById('reasonSuggestions');
            if(!container || !dataList) return;
            
            container.innerHTML = ''; dataList.innerHTML = '';
            
            Array.from(uniqueReasons).sort().forEach(reason => {
                const opt = document.createElement('option'); opt.value = reason; dataList.appendChild(opt);

                const id = `chk_${Math.random().toString(36).substr(2, 9)}`;
                const isChecked = !excludedReasons.has(reason);
                const div = document.createElement('div');
                div.className = 'flex items-start gap-2 py-1.5 border-b border-gray-50 last:border-0 hover:bg-gray-50 rounded px-1';
                div.innerHTML = `
                    <input type="checkbox" id="${id}" value="${reason.replace(/"/g, '&quot;')}" class="mt-0.5 w-3.5 h-3.5 text-blue-600 rounded cursor-pointer" ${isChecked ? 'checked' : ''}>
                    <label for="${id}" class="text-xs text-gray-700 cursor-pointer flex-1 truncate select-none" title="${reason}">${reason}</label>
                `;
                div.querySelector('input').addEventListener('change', (e) => {
                    if (e.target.checked) excludedReasons.delete(e.target.value);
                    else excludedReasons.add(e.target.value);
                    refreshDashboard();
                });
                container.appendChild(div);
            });

            const selectAllBtn = document.getElementById('selectAllBtn');
            if (selectAllBtn) {
                selectAllBtn.onclick = () => {
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                    checkboxes.forEach(cb => {
                        cb.checked = !allChecked;
                        if(cb.checked) excludedReasons.delete(cb.value); else excludedReasons.add(cb.value);
                    });
                    refreshDashboard();
                };
            }
        }

        function getFilteredData() {
            const startDateStr = document.getElementById('startDateFilter')?.value;
            const endDateStr = document.getElementById('endDateFilter')?.value;
            const teamFilter = document.getElementById('teamFilter')?.value || 'all';

            let start = startDateStr ? new Date(startDateStr) : null;
            let end = endDateStr ? new Date(endDateStr) : null;
            if(end) end.setHours(23, 59, 59, 999);

            let result = [];
            globalDataMap.forEach(row => {
                // Date Filter
                if (start && row._parsedDate < start) return;
                if (end && row._parsedDate > end) return;
                
                // Reason Exclusions
                if (excludedReasons.has(row._cleanReason)) return;

                // Team Filter
                if (teamFilter !== 'all') {
                    const agentTeam = getAgentTeam(row['Submitted By']);
                    if (teamFilter === 'order_support' && agentTeam !== 'Order Support') return;
                    if (teamFilter === 'mentors' && agentTeam !== 'Mentors') return;
                    if (teamFilter === 'mx' && agentTeam !== 'MX') return;
                }

                result.push(row);
            });
            
            const badge = document.getElementById('recordCountBadge');
            if(badge) badge.textContent = `${result.length} Records`;
            return result.sort((a,b) => b._parsedDate - a._parsedDate);
        }

        // --- Core Rendering Logic ---
        function refreshDashboard() {
            const data = getFilteredData();
            if(globalDataMap.size === 0) return;
            
            let total = data.length;
            let saved = data.filter(d => d._isSaved).length;
            let pending = data.filter(d => d._isPending).length;
            let resolvedCases = total - pending; 
            let rate = resolvedCases > 0 ? ((saved / resolvedCases) * 100).toFixed(1) : '0.0';
            
            if (document.getElementById('kpiTotalCases')) document.getElementById('kpiTotalCases').textContent = total.toLocaleString();
            if (document.getElementById('kpiSavedCases')) document.getElementById('kpiSavedCases').textContent = saved.toLocaleString();
            if (document.getElementById('kpiPendingCases')) document.getElementById('kpiPendingCases').textContent = pending.toLocaleString();
            if (document.getElementById('kpiRetentionRate')) document.getElementById('kpiRetentionRate').textContent = `${rate}%`;
            
            // Render specific tab
            if(currentActiveTab === 'overview') renderOverview(data);
            if(currentActiveTab === 'agents') renderAgents(data);
            if(currentActiveTab === 'insights') renderInsights(data);
            if(currentActiveTab === 'types') renderTypes(data);
            if(currentActiveTab === 'data') renderDataTable(data);
            if(currentActiveTab === 'uploads') renderUploads();
        }

        function formatAgentName(emailStr) {
            let name = String(emailStr).split('@')[0].replace('.', ' ');
            return name.replace(/\b\w/g, l => l.toUpperCase());
        }

        function getTeamBadge(teamName) {
            if(teamName === 'Order Support') return '<span class="bg-blue-100 text-blue-700 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">Order Support</span>';
            if(teamName === 'Mentors') return '<span class="bg-purple-100 text-purple-700 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">Mentors</span>';
            return '<span class="bg-gray-100 text-gray-600 text-[9px] px-1.5 py-0.5 rounded font-bold ml-2">MX</span>';
        }

        // --- TAB 1: Overview Render ---
        function renderOverview(data) {
            const timelineMap = {};
            const statusMap = {};

            data.forEach(row => {
                const dayKey = row._parsedDate.toISOString().split('T')[0];
                if(!timelineMap[dayKey]) timelineMap[dayKey] = { total: 0, saved: 0, pending: 0 };
                timelineMap[dayKey].total++;
                if(row._isSaved) timelineMap[dayKey].saved++;
                if(row._isPending) timelineMap[dayKey].pending++;

                let stat = (row['Status'] || 'Unknown').trim();
                if (stat.toLowerCase() === 'closed' || stat.toLowerCase() === 'resolved') {
                    stat = 'Resolved / Closed';
                }
                
                statusMap[stat] = (statusMap[stat] || 0) + 1;
            });

            const sortedDays = Object.keys(timelineMap).sort();
            if(charts.trend) charts.trend.destroy();
            
            const trendCtx = document.getElementById('trendChart')?.getContext('2d');
            if (trendCtx) {
                charts.trend = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: sortedDays,
                        datasets: [
                            { label: 'Total Cases', data: sortedDays.map(d => timelineMap[d].total), borderColor: '#94a3b8', backgroundColor: 'transparent', borderDash: [5,5], tension: 0.3 },
                            { label: 'Saved Cases', data: sortedDays.map(d => timelineMap[d].saved), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
                });
            }

            if(charts.status) charts.status.destroy();
            const statusCtx = document.getElementById('statusChart')?.getContext('2d');
            if (statusCtx) {
                charts.status = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusMap),
                        datasets: [{ data: Object.values(statusMap), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{boxWidth:12, font:{size:10}} } } }
                });
            }
        }

        // --- TAB 2: Agents Render ---
        function renderAgents(data) {
            const agentStats = {};
            data.forEach(row => {
                const ag = row['Submitted By'];
                if(!agentStats[ag]) agentStats[ag] = { total: 0, saved: 0, pending: 0, reasons: {} };
                agentStats[ag].total++;
                
                if(row._isPending) agentStats[ag].pending++;
                else if(row._isSaved) agentStats[ag].saved++;
                
                const r = row._cleanReason;
                agentStats[ag].reasons[r] = (agentStats[ag].reasons[r] || 0) + 1;
            });

            let leaderboard = Object.keys(agentStats).map(ag => {
                const resolved = agentStats[ag].total - agentStats[ag].pending;
                return { 
                    agent: ag, 
                    team: getAgentTeam(ag),
                    total: agentStats[ag].total, 
                    saved: agentStats[ag].saved,
                    pending: agentStats[ag].pending,
                    resolved: resolved,
                    rate: resolved > 0 ? (agentStats[ag].saved / resolved)*100 : 0,
                    reasons: agentStats[ag].reasons
                };
            }).sort((a,b) => b.rate !== a.rate ? b.rate - a.rate : b.resolved - a.resolved);

            const tbody = document.getElementById('agentTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            leaderboard.forEach((entry, idx) => {
                const tr = document.createElement('tr');
                tr.className = `hover:bg-blue-50 cursor-pointer transition-colors border-b border-gray-50 ${selectedAgentForSnapshot === entry.agent ? 'bg-blue-50' : ''}`;
                tr.onclick = () => {
                    selectedAgentForSnapshot = entry.agent;
                    
                    document.getElementById('agentLeaderboardView')?.classList.add('hidden');
                    document.getElementById('agentLeaderboardView')?.classList.remove('flex');
                    document.getElementById('agentProfileView')?.classList.remove('hidden');
                    document.getElementById('agentProfileView')?.classList.add('flex');
                    
                    renderAgentSnapshot(entry, data);
                    
                    Array.from(tbody.children).forEach(r => r.classList.remove('bg-blue-50'));
                    tr.classList.add('bg-blue-50');
                };

                let medal = idx === 0 ? '' : idx === 1 ? '' : idx === 2 ? '' : '';
                tr.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap">
                        <div class="font-medium text-gray-900 flex items-center">${medal} ${formatAgentName(entry.agent)} ${getTeamBadge(entry.team)}</div>
                        <div class="text-[11px] text-gray-400 mt-0.5 ml-${medal ? '6' : '0'}">${entry.agent}</div>
                    </td>
                    <td class="py-4 px-6 text-center text-base">${entry.total}</td>
                    <td class="py-4 px-6 text-center text-base font-medium text-green-600">${entry.saved}</td>
                    <td class="py-4 px-6 text-center text-base font-medium text-yellow-600">${entry.pending}</td>
                    <td class="py-4 px-6">
                        <div class="flex items-center justify-end gap-3">
                            <div class="w-24 bg-gray-200 rounded-full h-2"><div class="bg-blue-600 h-2 rounded-full" style="width:${entry.rate}%"></div></div>
                            <span class="text-sm font-bold w-12 text-right">${entry.rate.toFixed(1)}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            if (selectedAgentForSnapshot) {
                const currentEntry = leaderboard.find(l => l.agent === selectedAgentForSnapshot);
                if (currentEntry) renderAgentSnapshot(currentEntry, data);
                else window.backToLeaderboard();
            } else {
                document.getElementById('agentProfileView')?.classList.add('hidden');
                document.getElementById('agentProfileView')?.classList.remove('flex');
                document.getElementById('agentLeaderboardView')?.classList.remove('hidden');
                document.getElementById('agentLeaderboardView')?.classList.add('flex');
            }
        }

        function renderAgentSnapshot(agentData, allFilteredData) {
            if (document.getElementById('selectedAgentTitle')) document.getElementById('selectedAgentTitle').innerHTML = `${formatAgentName(agentData.agent)} ${getTeamBadge(agentData.team)}`;
            if (document.getElementById('snapRate')) document.getElementById('snapRate').textContent = `${agentData.rate.toFixed(1)}%`;
            if (document.getElementById('snapVol')) document.getElementById('snapVol').textContent = agentData.resolved;

            const reasonsArr = Object.entries(agentData.reasons).map(([k,v]) => ({reason: k, count: v})).sort((a,b) => b.count - a.count).slice(0,5);
            
            if(charts.agentReason) charts.agentReason.destroy();
            const arCtx = document.getElementById('agentReasonChart')?.getContext('2d');
            if (arCtx) {
                charts.agentReason = new Chart(arCtx, {
                    type: 'bar',
                    data: {
                        labels: reasonsArr.map(r => r.reason.length > 25 ? r.reason.substring(0,25)+'...' : r.reason),
                        datasets: [{ label: 'Cases', data: reasonsArr.map(r => r.count), backgroundColor: '#8b5cf6', borderRadius: 4 }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, ticks:{stepSize:1} } }
                    }
                });
            }

            currentAgentSpecificTickets = allFilteredData.filter(d => d['Submitted By'] === agentData.agent);
            window.renderAgentTicketsList();
        }

        // --- TAB 3: Insights & Channels Render ---
        function renderInsights(data) {
            const reasonCounts = {};
            const prevCounts = {};
            const channelStats = {};

            data.forEach(row => {
                // Cancellation Reasons
                const r = row._cleanReason;
                if(!reasonCounts[r]) reasonCounts[r] = {total: 0, saved: 0, pending: 0};
                reasonCounts[r].total++;
                if(row._isSaved) reasonCounts[r].saved++;
                if(row._isPending) reasonCounts[r].pending++;

                // Prevention Reasons (Saved Cases Only)
                if(row._isSaved) {
                    const pr = row._preventionReason || 'Not Specified';
                    prevCounts[pr] = (prevCounts[pr] || 0) + 1;
                }

                // Channels
                const ch = row._channel || 'Unknown';
                if(!channelStats[ch]) channelStats[ch] = {total: 0, saved: 0, pending: 0};
                channelStats[ch].total++;
                if(row._isSaved) channelStats[ch].saved++;
                if(row._isPending) channelStats[ch].pending++;
            });

            // 1. Render Top Cancellation Reasons Chart
            const sortedReasons = Object.keys(reasonCounts)
                .map(k => ({reason: k, ...reasonCounts[k]}))
                .sort((a,b) => b.total - a.total).slice(0, 15);

            if(charts.topReasons) charts.topReasons.destroy();
            const trCtx = document.getElementById('topReasonsChart')?.getContext('2d');
            if (trCtx) {
                charts.topReasons = new Chart(trCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedReasons.map(s => s.reason),
                        datasets: [
                            { label: 'Unsaved', data: sortedReasons.map(s => s.total - s.saved - s.pending), backgroundColor: '#cbd5e1', stacked: true },
                            { label: 'Saved', data: sortedReasons.map(s => s.saved), backgroundColor: '#3b82f6', stacked: true },
                            { label: 'Pending', data: sortedReasons.map(s => s.pending), backgroundColor: '#facc15', stacked: true }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { tooltip: { mode: 'index', intersect: false } },
                        scales: {
                            x: { stacked: true, ticks: { maxRotation: 45, minRotation: 45 } },
                            y: { stacked: true, beginAtZero: true }
                        }
                    }
                });
            }

            // 2. Render Prevention Strategies Chart
            const sortedPreventions = Object.keys(prevCounts)
                .map(k => ({reason: k, count: prevCounts[k]}))
                .sort((a,b) => b.count - a.count).slice(0, 10);

            if(charts.prevention) charts.prevention.destroy();
            const prevCtx = document.getElementById('preventionChart')?.getContext('2d');
            if (prevCtx) {
                charts.prevention = new Chart(prevCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedPreventions.map(s => s.reason),
                        datasets: [{ label: 'Times Saved', data: sortedPreventions.map(s => s.count), backgroundColor: '#10b981', borderRadius: 4 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { ticks: { maxRotation: 45, minRotation: 45 } },
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // 3. Render Channels
            const sortedChannels = Object.keys(channelStats).map(ch => {
                const stats = channelStats[ch];
                const resolved = stats.total - stats.pending;
                const rate = resolved > 0 ? (stats.saved / resolved) * 100 : 0;
                return { channel: ch, ...stats, resolved, rate };
            }).sort((a,b) => b.total - a.total);

            const cBody = document.getElementById('channelTableBody');
            if (cBody) {
                cBody.innerHTML = '';
                sortedChannels.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="py-3 px-5 border-b border-gray-100 font-medium text-gray-800">${c.channel}</td>
                        <td class="py-3 px-5 border-b border-gray-100 text-center">${c.total}</td>
                        <td class="py-3 px-5 border-b border-gray-100 text-center text-green-600 font-medium">${c.saved}</td>
                        <td class="py-3 px-5 border-b border-gray-100 text-right font-bold">${c.rate.toFixed(1)}%</td>
                    `;
                    cBody.appendChild(tr);
                });
            }

            if(charts.channel) charts.channel.destroy();
            const chanCtx = document.getElementById('channelChart')?.getContext('2d');
            if (chanCtx) {
                charts.channel = new Chart(chanCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedChannels.map(c => c.channel),
                        datasets: [{ label: 'Retention Rate %', data: sortedChannels.map(c => c.rate), backgroundColor: '#3b82f6', borderRadius: 4 }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
                    }
                });
            }
        }

        // --- TAB 3.5: Request Types Render ---
        function renderTypes(data) {
            const typeStats = {};
            const agentTypeStats = {};

            data.forEach(row => {
                const rt = row._requestType || 'Unknown';
                const ag = row['Submitted By'];
                
                // Overall Type Stats
                if(!typeStats[rt]) typeStats[rt] = { total: 0, saved: 0, pending: 0 };
                typeStats[rt].total++;
                if(row._isSaved) typeStats[rt].saved++;
                if(row._isPending) typeStats[rt].pending++;

                // Agent Type Breakdown
                if(!agentTypeStats[rt]) agentTypeStats[rt] = {};
                if(!agentTypeStats[rt][ag]) agentTypeStats[rt][ag] = { total: 0, saved: 0, pending: 0 };
                agentTypeStats[rt][ag].total++;
                if(row._isSaved) agentTypeStats[rt][ag].saved++;
                if(row._isPending) agentTypeStats[rt][ag].pending++;
            });

            // 1. Render Top Level Types Table & Chart
            const sortedTypes = Object.keys(typeStats).map(rt => {
                const stats = typeStats[rt];
                const resolved = stats.total - stats.pending;
                const rate = resolved > 0 ? (stats.saved / resolved) * 100 : 0;
                return { type: rt, ...stats, resolved, rate };
            }).sort((a,b) => b.total - a.total);

            const tBody = document.getElementById('typesTableBody');
            if (tBody) {
                tBody.innerHTML = '';
                sortedTypes.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="py-3 px-5 border-b border-gray-100 font-medium text-gray-800">${t.type}</td>
                        <td class="py-3 px-5 border-b border-gray-100 text-center">${t.total}</td>
                        <td class="py-3 px-5 border-b border-gray-100 text-center text-green-600 font-medium">${t.saved}</td>
                        <td class="py-3 px-5 border-b border-gray-100 text-right font-bold">${t.rate.toFixed(1)}%</td>
                    `;
                    tBody.appendChild(tr);
                });
            }

            if(charts.requestTypes) charts.requestTypes.destroy();
            const rtCtx = document.getElementById('typesChart')?.getContext('2d');
            if (rtCtx) {
                charts.requestTypes = new Chart(rtCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedTypes.map(t => t.type),
                        datasets: [{ label: 'Total Volume', data: sortedTypes.map(t => t.total), backgroundColor: '#8b5cf6', borderRadius: 4 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true }, x: { ticks: { maxRotation: 45, minRotation: 45 } } }
                    }
                });
            }

            // 2. Render Agent Breakdown Table
            const atBody = document.getElementById('agentTypeTableBody');
            if (atBody) {
                atBody.innerHTML = '';
                
                sortedTypes.forEach(typeObj => {
                    const rt = typeObj.type;
                    const agentsForType = Object.keys(agentTypeStats[rt]).map(ag => {
                        const stats = agentTypeStats[rt][ag];
                        const resolved = stats.total - stats.pending;
                        const rate = resolved > 0 ? (stats.saved / resolved) * 100 : 0;
                        return { agent: ag, team: getAgentTeam(ag), ...stats, resolved, rate };
                    }).sort((a,b) => b.rate !== a.rate ? b.rate - a.rate : b.resolved - a.resolved);

                    // Section Header for Request Type
                    const headerTr = document.createElement('tr');
                    headerTr.className = "bg-gray-100/80";
                    headerTr.innerHTML = `<td colspan="5" class="py-2.5 px-5 text-xs font-bold text-gray-700 uppercase tracking-wider border-y border-gray-200"> ${rt} Breakdown</td>`;
                    atBody.appendChild(headerTr);

                    agentsForType.forEach(agObj => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-blue-50 transition-colors';
                        tr.innerHTML = `
                            <td class="py-3 px-5 border-b border-gray-50 pl-8 font-medium text-gray-800">
                                <div class="flex items-center">${formatAgentName(agObj.agent)} ${getTeamBadge(agObj.team)}</div>
                                <div class="text-[10px] text-gray-400 mt-0.5">${agObj.agent}</div>
                            </td>
                            <td class="py-3 px-5 border-b border-gray-50 text-center">${agObj.total}</td>
                            <td class="py-3 px-5 border-b border-gray-50 text-center text-green-600 font-medium">${agObj.saved}</td>
                            <td class="py-3 px-5 border-b border-gray-50 text-center text-yellow-600 font-medium">${agObj.pending}</td>
                            <td class="py-3 px-5 border-b border-gray-50 font-bold text-right">
                                ${agObj.rate.toFixed(1)}%
                            </td>
                        `;
                        atBody.appendChild(tr);
                    });
                });
            }
        }

        // --- TAB 4: Data Table Render ---
        function renderDataTable(data) {
            const tbody = document.getElementById('rawDataTableBody');
            if (!tbody) return; // FIX: Prevents "Cannot set properties of null" error
            tbody.innerHTML = '';
            
            const filterVal = document.getElementById('dataManagerStatusFilter')?.value || 'all';
            const searchVal = document.getElementById('dataManagerSearch')?.value.trim().toLowerCase() || '';

            let filteredData = data;
            
            // Apply Status Filter
            if (filterVal === 'true') filteredData = filteredData.filter(t => t._isSaved && !t._isPending);
            else if (filterVal === 'false') filteredData = filteredData.filter(t => !t._isSaved && !t._isPending);
            else if (filterVal === 'pending') filteredData = filteredData.filter(t => t._isPending);
            
            // Apply Search Filter (Order ID or Ticket ID)
            if (searchVal) {
                filteredData = filteredData.filter(t => {
                    const orderId = String(t['Order ID'] || '').toLowerCase();
                    const ticketId = String(t['Ticket ID'] || '').toLowerCase();
                    return orderId.includes(searchVal) || ticketId.includes(searchVal);
                });
            }

            const totalPages = Math.ceil(filteredData.length / dataManagerRowsPerPage) || 1;
            if (dataManagerCurrentPage > totalPages) dataManagerCurrentPage = totalPages;
            if (dataManagerCurrentPage < 1) dataManagerCurrentPage = 1;

            const startIndex = (dataManagerCurrentPage - 1) * dataManagerRowsPerPage;
            const endIndex = Math.min(startIndex + dataManagerRowsPerPage, filteredData.length);
            
            const displayData = filteredData.slice(startIndex, endIndex);

            displayData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 group';
                
                const dStr = row._parsedDate.toLocaleString([], {year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
                const teamBadge = getTeamBadge(getAgentTeam(row['Submitted By']));

                let savedBadge = '';
                if(row._isPending) savedBadge = '<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded text-[10px] font-bold">Pending</span>';
                else if(row._isSaved) savedBadge = '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold">Yes</span>';
                else savedBadge = '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[10px] font-bold">No</span>';
                
                const sourceFileName = row._batchName ? row._batchName : 'Manual Entry';
                
                let displayReason = row._cleanReason;
                if (row._isSaved && row._preventionReason) {
                    displayReason = `<span class="text-green-600 font-medium">Saved via:</span> ${row._preventionReason}`;
                }

                tr.innerHTML = `
                    <td class="py-2 px-4 border-b border-gray-100 whitespace-nowrap">${dStr}</td>
                    <td class="py-2 px-4 border-b border-gray-100 font-mono text-[10px] text-gray-500">
                        <div class="font-bold text-gray-800" title="Ticket ID">TKT: ${row['Ticket ID']}</div>
                        <div class="text-gray-400 mt-0.5" title="Order ID">ORD: ${row['Order ID'] || '-'}</div>
                    </td>
                    <td class="py-2 px-4 border-b border-gray-100 truncate max-w-[150px]" title="${row['Submitted By']}">
                        <div class="flex items-center">${formatAgentName(row['Submitted By'])} ${teamBadge}</div>
                    </td>
                    <td class="py-2 px-4 border-b border-gray-100">${row._channel || '-'}</td>
                    <td class="py-2 px-4 border-b border-gray-100 truncate max-w-[150px]" title="${row._requestType || '-'}">${row._requestType || '-'}</td>
                    <td class="py-2 px-4 border-b border-gray-100 truncate max-w-[200px]" title="${row._cleanReason}">${displayReason}</td>
                    <td class="py-2 px-4 border-b border-gray-100">${row['Status'] || ''}</td>
                    <td class="py-2 px-4 border-b border-gray-100">${savedBadge}</td>
                    <td class="py-2 px-4 border-b border-gray-100 text-right opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editRecord('${row['Ticket ID']}')" class="text-blue-500 hover:text-blue-700 mr-3" title="Edit Record"><i class="ph ph-pencil-simple text-base"></i></button>
                        <button onclick="deleteRecord('${row['Ticket ID']}')" class="text-red-400 hover:text-red-600" title="Delete Record"><i class="ph ph-trash text-base"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const pageInfo = document.getElementById('dataManagerPaginationInfo');
            const btnPrev = document.getElementById('btnPrevPage');
            const btnNext = document.getElementById('btnNextPage');

            if (pageInfo) {
                if (filteredData.length === 0) pageInfo.textContent = 'No records found.';
                else pageInfo.textContent = `Showing ${startIndex + 1} to ${endIndex} of ${filteredData.length.toLocaleString()} records`;
            }
            if (btnPrev) btnPrev.disabled = (dataManagerCurrentPage === 1);
            if (btnNext) btnNext.disabled = (dataManagerCurrentPage === totalPages || filteredData.length === 0);
        }

        // --- TAB 5: Uploads Render ---
        function renderUploads() {
            const batchesMap = {};
            
            globalDataMap.forEach(row => {
                if (!row._batchId) return; 
                
                if (!batchesMap[row._batchId]) {
                    batchesMap[row._batchId] = { id: row._batchId, name: row._batchName, date: row._batchDate, count: 0 };
                }
                batchesMap[row._batchId].count++;
            });

            const batchArray = Object.values(batchesMap).sort((a, b) => new Date(b.date) - new Date(a.date));
            const tbody = document.getElementById('uploadsTableBody');
            if (!tbody) return; // Prevent Null Error
            tbody.innerHTML = '';

            if(batchArray.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="py-8 text-center text-gray-400 italic">No tracked uploads found.</td></tr>`;
                return;
            }

            batchArray.forEach(b => {
                const dStr = new Date(b.date).toLocaleString([], {year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                tr.innerHTML = `
                    <td class="py-3 px-5 border-b border-gray-100 whitespace-nowrap">${dStr}</td>
                    <td class="py-3 px-5 border-b border-gray-100 font-medium text-gray-800">${b.name}</td>
                    <td class="py-3 px-5 border-b border-gray-100 text-center"><span class="bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs font-bold">${b.count} tickets</span></td>
                    <td class="py-3 px-5 border-b border-gray-100 text-right">
                        <button onclick="deleteBatch('${b.id}')" class="text-xs text-red-600 hover:text-red-800 border border-red-200 hover:bg-red-50 px-2 py-1 rounded transition-colors flex items-center gap-1 ml-auto">
                            <i class="ph ph-trash"></i> Delete File Data
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
