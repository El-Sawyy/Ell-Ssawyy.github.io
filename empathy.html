<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Service Empathy Simulator for Kindly!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Unique font for the brand name -->
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for the unique brand font */
        .brand-font {
            font-family: 'Pacifico', cursive;
            /* Adding a subtle text shadow to make it pop */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .feedback-card, .suggestion-card, .history-item {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- App Loader -->
    <div id="app-loader" class="flex justify-center items-center h-screen">
        <div class="loader"></div>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div id="app-content" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
             <header class="text-center mb-8 flex flex-col items-center">
                <h1 class="text-5xl sm:text-6xl font-bold brand-font bg-gradient-to-r from-blue-600 to-teal-500 bg-clip-text text-transparent py-2">Kindly!</h1>
                <div class="mt-4">
                    <div id="logged-out-header">
                        <p id="header-subtitle" class="text-lg text-gray-600">Practice real-world <span class="bg-yellow-300 text-gray-800 font-semibold rounded-md px-2 py-1">Kindly!</span> customer scenarios.</p>
                    </div>
                    <div id="logged-in-header" class="hidden">
                         <p id="welcome-message" class="text-md text-gray-500"></p>
                         <button id="logout-btn" class="mt-1 text-sm text-red-600 hover:text-red-800 font-semibold">Logout</button>
                    </div>
                </div>
            </header>

            <!-- Auth View -->
            <div id="auth-view" class="bg-white p-8 rounded-2xl shadow-lg max-w-md mx-auto">
                <div id="login-form">
                    <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-3 mb-4 border rounded">
                    <input type="password" id="login-password" placeholder="Password" class="w-full p-3 mb-4 border rounded">
                    <button id="login-btn" class="w-full bg-blue-500 text-white p-3 rounded">Login</button>
                    <p class="text-center mt-4">Don't have an account? <a href="#" id="show-register" class="text-blue-500">Register</a></p>
                </div>
                <div id="register-form" class="hidden">
                    <div id="register-inputs">
                        <h2 class="text-2xl font-bold mb-4 text-center">Register</h2>
                        <input type="email" id="register-email" placeholder="Email" class="w-full p-3 mb-4 border rounded">
                        <input type="password" id="register-password" placeholder="Password" class="w-full p-3 mb-4 border rounded">
                        <button id="register-btn" class="w-full bg-green-500 text-white p-3 rounded">Register</button>
                    </div>
                    <div id="register-success" class="hidden text-center mt-4 p-4 bg-green-100 border border-green-300 rounded-lg">
                        <h3 class="font-bold text-green-800">Registration Successful!</h3>
                        <p class="text-green-700">Please check your email for a confirmation link to activate your account before logging in.</p>
                    </div>
                    <p class="text-center mt-4">Already have an account? <a href="#" id="show-login" class="text-blue-500">Login</a></p>
                </div>
                 <p id="auth-error" class="text-red-500 text-center mt-4"></p>
            </div>

            <!-- Main Menu View -->
            <div id="main-menu" class="hidden text-center">
                <div id="user-dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <button data-action="weekly-challenge" class="card bg-yellow-500 text-white p-6 rounded-lg cursor-pointer text-left col-span-1 md:col-span-2">
                         <h3 class="text-xl font-bold mb-2">üèÜ Weekly Challenge Scenario</h3>
                         <p>Compete with other agents for the top score on this week's featured scenario!</p>
                     </button>
                     <button data-action="assigned" class="card bg-white p-6 rounded-lg cursor-pointer text-left">
                         <h3 class="text-xl font-bold mb-2 text-gray-800">üìù My Assigned Scenarios</h3>
                         <p class="text-gray-600">Practice scenarios assigned to you by an admin.</p>
                     </button>
                    <button data-action="practice" class="card bg-white p-6 rounded-lg cursor-pointer text-left">
                        <h3 class="text-xl font-bold mb-2 text-gray-800">üöÄ Practice Random Scenarios</h3>
                        <p class="text-gray-600">Jump into a random multi-step simulation.</p>
                    </button>
                    <button data-action="quick-fire" class="card bg-white p-6 rounded-lg cursor-pointer text-left">
                        <h3 class="text-xl font-bold mb-2 text-gray-800">‚ö° AI Quick-Fire Round</h3>
                        <p class="text-gray-600">Face unique, AI-generated single-step problems.</p>
                    </button>
                    <button data-action="create" class="card bg-white p-6 rounded-lg cursor-pointer text-left">
                        <h3 class="text-xl font-bold mb-2 text-gray-800">‚úçÔ∏è Create a Scenario</h3>
                        <p class="text-gray-600">Design a new custom scenario for your own practice.</p>
                    </button>
                     <button data-action="history" class="card bg-white p-6 rounded-lg cursor-pointer text-left">
                         <h3 class="text-xl font-bold mb-2 text-gray-800">üìà View My History</h3>
                         <p class="text-gray-600">Review your past performance, feedback, and ideal responses.</p>
                     </button>
                    <button data-action="rephrase-tool" class="card bg-green-500 text-white p-6 rounded-lg cursor-pointer text-left">
                        <h3 class="text-xl font-bold mb-2">‚úçÔ∏è Help Me Rephrase</h3>
                        <p>Get AI-powered suggestions to make your response more empathetic and professional.</p>
                    </button>
                     <button data-action="email-crafter" class="card bg-orange-500 text-white p-6 rounded-lg cursor-pointer text-left">
                         <h3 class="text-xl font-bold mb-2">‚úâÔ∏è AI Email Crafter</h3>
                         <p>Craft the perfect customer response email based on the situation and desired resolution.</p>
                     </button>
                    <button data-action="saved-emails" class="card bg-teal-500 text-white p-6 rounded-lg cursor-pointer text-left">
                        <h3 class="text-xl font-bold mb-2">üìö My Saved Emails</h3>
                        <p>Access your personal collection of saved, highly effective email templates.</p>
                    </button>
                    <button data-action="empathy-help" class="card bg-purple-600 text-white p-6 rounded-lg cursor-pointer text-left col-span-1 md:col-span-2">
                        <h3 class="text-xl font-bold mb-2">üß† AI Empathy Coach</h3>
                        <p>Get intelligent, empathetic guidance for a tough customer situation you're facing now.</p>
                    </button>
                </div>
                 <button id="admin-dashboard-btn" class="hidden mt-6 card bg-indigo-600 text-white p-4 rounded-lg w-full md:w-1-2 mx-auto">
                     <h3 class="text-xl font-bold">üëë Admin Dashboard</h3>
                 </button>
            </div>

            <!-- Rephrase Tool View -->
            <div id="rephrase-tool-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <h2 class="text-2xl font-bold mb-4">‚úçÔ∏è AI Rephrasing Tool</h2>
                <p class="text-gray-600 mb-6">Enter the customer's message and your draft response. The AI will provide alternative, more empathetic phrasings.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="rephrase-customer-statement" class="block text-sm font-medium text-gray-700">Customer's Statement</label>
                        <textarea id="rephrase-customer-statement" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" rows="4" placeholder="e.g., My Kindly! device stopped working mid-workout and I'm really frustrated!"></textarea>
                    </div>
                    <div>
                        <label for="rephrase-agent-draft" class="block text-sm font-medium text-gray-700">Your Draft Response</label>
                        <textarea id="rephrase-agent-draft" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" rows="4" placeholder="e.g., Sorry about that. Did you try restarting it?"></textarea>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="get-rephrase-tool-suggestions-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">Get Suggestions</button>
                </div>
                
                <div id="rephrase-tool-loading" class="hidden flex-col items-center justify-center mt-4">
                     <div class="loader"></div>
                     <p class="text-gray-600 mt-2">AI is thinking of new phrases...</p>
                 </div>

                <div id="rephrase-tool-suggestions-container" class="hidden mt-6"></div>
            </div>

            <!-- Empathy Assistant View -->
            <div id="empathy-assistant-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <h2 class="text-2xl font-bold mb-4">üß† AI Empathy Coach</h2>
                <p class="text-gray-600 mb-4">Describe the tough customer situation you're facing. The AI will analyze the core emotion and provide an intelligence-powered empathy report to help you respond effectively.</p>
                <label for="situation-description" class="block text-sm font-medium text-gray-700">Customer Situation</label>
                <textarea id="situation-description" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" rows="4" placeholder="e.g., The customer is angry because their delivery was delayed and missed a birthday."></textarea>
                <div class="mt-6 flex justify-end">
                    <button id="get-empathy-help-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700">Get Empathy Report</button>
                </div>
                <div id="empathy-help-loading" class="hidden flex-col items-center justify-center mt-4">
                     <div class="loader"></div>
                     <p class="text-gray-600 mt-2">Your empathy coach is thinking...</p>
                 </div>
                <div id="empathy-response-container" class="mt-6 hidden"></div>
            </div>
            
            <!-- AI Email Crafter View -->
            <div id="email-crafter-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <h2 class="text-2xl font-bold mb-4">‚úâÔ∏è AI Email Crafter</h2>
                <p class="text-gray-600 mb-6">Provide the necessary details, and the AI will generate a professional, empathetic email ready to be sent to your customer.</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="customer-email-input" class="block text-sm font-medium text-gray-700">Original Customer Email</label>
                        <textarea id="customer-email-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" rows="5" placeholder="Paste the customer's full email here..."></textarea>
                    </div>
                    <div>
                        <label for="resolution-input" class="block text-sm font-medium text-gray-700">Resolution / Key Information to Convey</label>
                        <textarea id="resolution-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" rows="3" placeholder="e.g., The replacement order has been shipped via overnight delivery. Tracking number is X."></textarea>
                    </div>
                    <div>
                        <label for="alternatives-input" class="block text-sm font-medium text-gray-700">Alternatives or Extra Details (Optional)</label>
                        <textarea id="alternatives-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" rows="2" placeholder="e.g., We've also added a $20 credit to their account for the inconvenience."></textarea>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                    <button id="craft-email-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">Craft Email</button>
                </div>
                
                <div id="email-craft-loading" class="hidden flex-col items-center justify-center mt-4">
                     <div class="loader"></div>
                     <p class="text-gray-600 mt-2">AI is crafting your email...</p>
                 </div>

                <div id="crafted-email-container" class="hidden mt-6 text-left p-4 bg-gray-50 border rounded-lg">
                     <div class="flex justify-between items-center mb-2">
                         <h3 class="text-lg font-bold text-gray-800">Generated Email Draft</h3>
                    </div>
                     <div class="bg-white p-2 border rounded">
                          <p class="text-sm font-semibold text-gray-600">Subject:</p>
                          <input id="crafted-email-subject" type="text" class="w-full p-1 border-0 focus:ring-0">
                     </div>
                     <div class="bg-white p-2 border rounded mt-2">
                         <p class="text-sm font-semibold text-gray-600">Body:</p>
                        <textarea id="crafted-email-body" class="w-full p-1 border-0 focus:ring-0" rows="10"></textarea>
                    </div>
                     <div class="mt-4 flex justify-end space-x-2">
                        <button id="recraft-email-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm transition-colors">Recraft</button>
                        <div class="flex-grow"></div>
                        <input type="text" id="email-category-input" placeholder="Category (e.g., Billing)" class="p-2 border rounded-md text-sm">
                        <button id="save-email-btn" class="bg-teal-500 hover:bg-teal-600 text-white px-4 py-2 rounded text-sm transition-colors">Save to My Emails</button>
                    </div>
                    <!-- NEW: Feedback section for recrafting -->
                    <div id="recraft-feedback-container" class="hidden mt-4 p-4 bg-gray-100 rounded-lg border">
                        <label for="recraft-feedback-input" class="block text-sm font-medium text-gray-700 mb-1">How should the AI improve this email?</label>
                        <textarea id="recraft-feedback-input" class="w-full p-2 border border-gray-300 rounded-md" rows="2" placeholder="e.g., Be more apologetic, make it shorter, add details about the new tracking number..."></textarea>
                        <div class="mt-2 flex justify-end">
                            <button id="submit-recraft-btn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded text-sm">Submit & Recraft</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saved Emails View -->
            <div id="saved-emails-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-3xl font-bold">üìö My Saved Emails</h2>
                     <div>
                        <label for="category-filter" class="text-sm font-medium text-gray-700 mr-2">Filter by category:</label>
                        <select id="category-filter" class="rounded-md border-gray-300 shadow-sm"></select>
                    </div>
                </div>
                <div id="saved-emails-container" class="space-y-4"></div>
            </div>

            <!-- Assigned Scenarios View -->
            <div id="assigned-scenarios-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <h2 class="text-3xl font-bold mb-4 text-center">My Assigned Scenarios</h2>
                <div id="assigned-scenarios-container" class="space-y-4"></div>
            </div>

            <!-- Create Scenario View -->
            <div id="create-scenario-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <h2 class="text-2xl font-bold mb-4">‚ú® Create a Custom Scenario</h2>
                <p class="text-gray-600 mb-4">Describe a customer service situation. The AI will generate a title, description, persona, and a 3-step dialogue tree for it.</p>
                <label for="scenario-topic" class="block text-sm font-medium text-gray-700">Scenario Topic</label>
                <input type="text" id="scenario-topic" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder="e.g., A customer's weights are not being recognized by the AI">
                <div id="modal-loading" class="hidden flex-col items-center justify-center mt-4">
                    <div class="loader"></div>
                    <p class="text-gray-600 mt-2">Generating your custom scenario...</p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="generate-scenario-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Generate & Save</button>
                </div>
            </div>

            <!-- History List View -->
            <div id="history-list-view" class="hidden">
                 <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <h2 class="text-3xl font-bold mb-4 text-center">My Session History</h2>
                <div id="history-list-container" class="space-y-4"></div>
            </div>

            <!-- History Detail View -->
            <div id="history-detail-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button id="back-to-history-list-btn" class="mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to History</button>
                <h2 id="history-detail-title" class="text-2xl font-bold mb-2"></h2>
                <p class="text-lg font-semibold mb-4">Final Empathy Score: <span id="history-detail-score" class="text-blue-600"></span></p>
                <button id="get-summary-btn" class="w-full mb-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">‚ú® Get Summary & Tip</button>
                <div id="history-summary-container" class="hidden mb-4 p-4 bg-indigo-50 rounded-lg"></div>
                <div id="history-detail-interactions" class="space-y-6"></div>
            </div>

            <!-- Simulator View -->
            <div id="simulator" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
                <div id="scenario-title" class="text-2xl font-bold mb-2 text-gray-900"></div>
                <div id="customer-persona" class="text-sm text-gray-500 mb-4 italic"></div>
                <div class="h-4 bg-gray-200 rounded-full mb-4 overflow-hidden">
                    <div id="empathy-meter" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 50%;"></div>
                </div>
                <p class="text-right text-sm text-gray-500 mb-4">Empathy Meter</p>
                <div id="dialogue-container" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px]">
                    <p class="font-semibold text-gray-600 mb-2 flex items-center">
                        Customer says:
                        <button id="play-audio-btn" class="ml-2 text-xl cursor-pointer hover:scale-110 transition-transform">üîä</button>
                        <span id="audio-loader" class="hidden ml-2 h-5 w-5 border-t-2 border-b-2 border-gray-900 rounded-full animate-spin"></span>
                    </p>
                    <p id="customer-dialogue" class="text-gray-800"></p>
                </div>
                <div id="response-area">
                    <div class="flex justify-between items-center mb-2">
                        <label for="user-response" class="block font-semibold text-gray-700">Your Response:</label>
                        <div>
                            <button id="analyze-tone-btn" class="text-sm text-indigo-600 hover:text-indigo-800 font-semibold mr-4">‚ú® Analyze Tone</button>
                            <button id="get-suggestions-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold">‚ú® Get Suggestions</button>
                        </div>
                    </div>
                    <div id="tone-analysis-container" class="mb-4 hidden"></div>
                    <div id="suggestions-container" class="mb-4 hidden"></div>
                    <textarea id="user-response" class="w-full p-3 border border-gray-300 rounded-lg" rows="4" placeholder="Type your empathetic response here..."></textarea>
                    <button id="submit-response-btn" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Submit for Feedback</button>
                </div>
                <div id="loading-indicator" class="hidden flex-col items-center justify-center mt-4">
                    <div class="loader"></div><p class="text-gray-600 mt-2">AI coach is thinking...</p>
                </div>
                <div id="feedback-container" class="mt-6 hidden"></div>
                <div class="mt-6 flex justify-between items-center">
                     <button class="back-to-menu-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Back to Menu</button>
                     <button id="next-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg hidden">Next Step</button>
                </div>
            </div>
            
            <!-- Completion Screen -->
            <div id="completion-screen" class="hidden text-center bg-white p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-green-600 mb-4">Scenario Complete!</h2>
                <p id="final-feedback" class="text-lg text-gray-700 mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="restart-scenario-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg">Try Again</button>
                    <button id="choose-another-scenario-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg">Another Random Scenario</button>
                </div>
                 <!-- NEW FEATURE START -->
                <div class="mt-8 border-t pt-6">
                     <button id="draft-email-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">‚ú® Draft Follow-up Email</button>
                </div>
                <div id="email-draft-container" class="hidden mt-6 text-left p-4 bg-gray-50 border rounded-lg">
                    <div id="email-draft-loading" class="hidden flex flex-col items-center justify-center py-8">
                        <div class="loader"></div>
                        <p class="text-gray-600 mt-2">Drafting email...</p>
                    </div>
                    <div id="email-draft-content" class="hidden">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-gray-800">Generated Email Draft</h3>
                            <button id="copy-email-btn" class="bg-gray-700 hover:bg-gray-800 text-white px-3 py-1 rounded text-sm transition-colors">Copy</button>
                        </div>
                        <div class="bg-white p-2 border rounded">
                            <p class="text-sm font-semibold text-gray-600">Subject:</p>
                            <input id="email-subject" type="text" class="w-full p-1 border-0 focus:ring-0" readonly>
                        </div>
                        <div class="bg-white p-2 border rounded mt-2">
                             <p class="text-sm font-semibold text-gray-600">Body:</p>
                            <textarea id="email-body" class="w-full p-1 border-0 focus:ring-0" rows="8" readonly></textarea>
                        </div>
                    </div>
                </div>
                <!-- NEW FEATURE END -->
            </div>

            <!-- Admin Dashboard View -->
            <div id="admin-dashboard-view" class="hidden">
                 <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <h2 class="text-3xl font-bold mb-4 text-center">üëë Admin Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button data-action="admin-users" class="card bg-white p-6 rounded-lg cursor-pointer text-left">
                        <h3 class="text-xl font-bold mb-2 text-gray-800">Manage Users & Roles</h3>
                        <p class="text-gray-600">Grant/revoke admin access and delete users.</p>
                    </button>
                    <button data-action="admin-assign-scenarios" class="card bg-white p-6 rounded-lg cursor-pointer text-left">
                        <h3 class="text-xl font-bold mb-2 text-gray-800">Assign Scenarios</h3>
                        <p class="text-gray-600">Assign specific training scenarios to users.</p>
                    </button>
                    <button data-action="admin-sessions" class="card bg-white p-6 rounded-lg cursor-pointer text-left">
                        <h3 class="text-xl font-bold mb-2 text-gray-800">Audit Sessions</h3>
                        <p class="text-gray-600">Review and manually edit feedback for all completed user sessions.</p>
                    </button>
                     <button data-action="admin-weekly-challenge" class="card bg-yellow-400 p-6 rounded-lg cursor-pointer text-left">
                         <h3 class="text-xl font-bold mb-2 text-gray-800">Manage Weekly Challenge</h3>
                         <p class="text-gray-700">Set or create a new challenge for the current week.</p>
                     </button>
                </div>
            </div>

            <!-- Weekly Challenge View -->
            <div id="weekly-challenge-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-menu-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Menu</button>
                <h2 class="text-3xl font-bold mb-4 text-center">üèÜ Weekly Challenge</h2>
                
                <!-- Scenario Details -->
                <div id="weekly-scenario-container" class="mb-6">
                    <!-- JS will render content here -->
                </div>

                <!-- Leaderboard -->
                <hr class="my-6">
                <h3 class="text-2xl font-bold mb-4 text-center">This Week's Leaderboard</h3>
                <div id="weekly-leaderboard-container">
                    <!-- JS will render content here -->
                </div>
            </div>

            <div id="admin-user-list-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                 <button class="back-to-admin-dash-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Admin</button>
                 <h2 class="text-3xl font-bold mb-4 text-center">Manage Users</h2>
                 <div id="admin-user-list-container" class="space-y-2"></div>
            </div>
            
            <!-- NEW VIEW for Assigning Scenarios -->
            <div id="admin-assign-scenarios-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                 <button class="back-to-admin-dash-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Admin</button>
                 <h2 class="text-3xl font-bold mb-4 text-center">Assign Scenario to User</h2>
                 <div id="admin-assign-list-container" class="space-y-2"></div>
            </div>


            <!-- Admin Weekly Challenge View -->
            <div id="admin-weekly-challenge-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-admin-dash-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Admin</button>
                <h2 class="text-3xl font-bold mb-4 text-center">Manage Weekly Challenge</h2>
            
                <!-- Display current challenge -->
                <div class="mb-6 border-b pb-6">
                    <h3 class="text-xl font-semibold mb-2">Current Active Challenge</h3>
                    <div id="current-weekly-challenge-container" class="p-4 bg-gray-50 rounded-lg">
                        <!-- JS will populate this -->
                    </div>
                </div>
            
                <!-- Form to create a new one -->
                <div class="mb-6 border-b pb-6">
                    <h3 class="text-xl font-semibold mb-2">Set New Weekly Challenge</h3>
                    <p class="text-gray-600 mb-4">Fill out the details below. Saving will deactivate the current challenge and set this one as active for the current week.</p>
                    <div class="space-y-4">
                        <div><label for="new-challenge-title" class="block text-sm font-medium text-gray-700">Title</label><input id="new-challenge-title" type="text" class="w-full p-2 border rounded-md"></div>
                        <div><label for="new-challenge-description" class="block text-sm font-medium text-gray-700">Description</label><input id="new-challenge-description" type="text" class="w-full p-2 border rounded-md"></div>
                        <div><label for="new-challenge-persona" class="block text-sm font-medium text-gray-700">Persona</label><textarea id="new-challenge-persona" class="w-full p-2 border rounded-md" rows="2"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700">Dialogue Step 1</label><textarea class="w-full p-2 border rounded-md new-challenge-dialogue" rows="2"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700">Dialogue Step 2</label><textarea class="w-full p-2 border rounded-md new-challenge-dialogue" rows="2"></textarea></div>
                        <div><label class="block text-sm font-medium text-gray-700">Dialogue Step 3</label><textarea class="w-full p-2 border rounded-md new-challenge-dialogue" rows="2"></textarea></div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="set-new-challenge-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Save & Set Active</button>
                    </div>
                </div>
                 <!-- NEW: Challenge History -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-2">Challenge History & Completion</h3>
                    <p class="text-gray-600 mb-4">Select a challenge to view completion status for all users.</p>
                    <div id="all-challenges-list-container" class="space-y-2">
                        <!-- JS will populate this list -->
                    </div>
                </div>
            </div>

            <!-- Admin Challenge Completion View -->
            <div id="admin-challenge-completion-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button id="back-to-weekly-admin-btn" class="mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Challenge Management</button>
                <h2 id="completion-view-title" class="text-3xl font-bold mb-4 text-center"></h2>
                <div id="completion-list-container" class="space-y-2">
                    <!-- JS will populate the user list here -->
                </div>
            </div>
            
            <div id="admin-session-list-view" class="hidden bg-white p-8 rounded-2xl shadow-lg">
                <button class="back-to-admin-dash-btn mb-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">‚Üê Back to Admin</button>
                <h2 class="text-3xl font-bold mb-4 text-center">Audit User Sessions</h2>
                <div id="admin-session-list-container" class="space-y-4"></div>
            </div>

            <div id="assign-scenario-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"></div>
            
            <!-- General Purpose Modal -->
            <div id="app-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                    <div class="mt-3 text-center">
                        <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900"></h3>
                        <div class="mt-2 px-7 py-3">
                            <p id="modal-message" class="text-sm text-gray-500"></p>
                        </div>
                        <div id="modal-actions" class="items-center px-4 py-3">
                            <!-- Buttons will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        const { createClient } = supabase;
        const supabaseUrl = 'https://camonkvcskqeemsfsjea.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhbW9ua3Zjc2txZWVtc2ZzamVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxNTg1MTAsImV4cCI6MjA3MTczNDUxMH0.McthjvqNtUHfGhm5zAwicGwkt1CcsbVWjh_mohAPPDE';
        const db = createClient(supabaseUrl, supabaseKey);

        let userId;
        let isAdmin = false;

        const defaultScenarios = [
            { id: 'default-0', title: "Kindly! Move Connection Issue", isDefault: true, description: "A customer is frustrated because their Kindly! Move won't connect to their TV.", persona: "Customer: Mark, a new user who was excited to start his first class. He's now annoyed and feels like the product is too complicated.", dialogue_tree: [{ customer: "I've been trying for 30 minutes and my Kindly! Move just won't show up on my TV! I'm about to miss my scheduled class. This is so frustrating." }, { customer: "I've tried restarting everything already. My iPhone is plugged into the Core, and the HDMI is in the TV. What else could it be?" }, { customer: "Okay, I checked and the TV is on the right HDMI input. It's working now! Thank you for walking me through that." }] },
            { id: 'default-1', title: "30-Day Trial & Return Question", isDefault: true, description: "A customer is nearing the end of their 30-day trial and is considering a return.", persona: "Customer: Jessica, who likes the workouts but isn't sure if it's worth the price. She's anxious about getting stuck in a contract.", dialogue_tree: [{ customer: "Hi, my 30-day trial is ending soon. I like Kindly!, but I'm not sure I can commit. What's the process if I decide to return it? I'm worried about hidden fees." }, { customer: "So as long as I have the original box, there's no restocking fee? That's good to know. Can I pause my membership instead of canceling?" }, { customer: "A membership pause is a great option. I think I'll do that and decide in a month. Thanks for explaining everything so clearly." }] },
            { id: 'default-2', title: "AI Form Feedback Complaint", isDefault: true, description: "A long-time user is upset because they feel the AI form feedback is inaccurate.", persona: "Customer: Alex, an experienced lifter who has been using Kindly! for 6 months. They are starting to question the value of the AI technology.", dialogue_tree: [{ customer: "I have to say, I'm getting really disappointed with the form feedback. It keeps telling me my squat depth is wrong, but I know my form is solid. It's making me question the whole system." }, { customer: "I've already checked the lighting and made sure the area is clear. It feels like the AI just isn't as smart as it's supposed to be. Is there a way to recalibrate it?" }, { customer: "I didn't know you could submit a video for review. That's actually really helpful. I'll do that after my next workout. I appreciate you offering a real solution." }] }
        ];
        
        let currentScenario = null;
        let lastPlayedScenarioId = null;
        let currentStep = 0;
        let empathyScore = 50;
        let sessionInteractions = [];
        let currentWeeklyChallenge = null;
        let authReady = false;

        const views = {
            auth: document.getElementById('auth-view'),
            mainMenu: document.getElementById('main-menu'),
            createScenario: document.getElementById('create-scenario-view'),
            historyList: document.getElementById('history-list-view'),
            historyDetail: document.getElementById('history-detail-view'),
            simulator: document.getElementById('simulator'),
            completion: document.getElementById('completion-screen'),
            adminDashboard: document.getElementById('admin-dashboard-view'),
            adminUserList: document.getElementById('admin-user-list-view'),
            adminAssignScenarios: document.getElementById('admin-assign-scenarios-view'), // New view
            adminSessionList: document.getElementById('admin-session-list-view'),
            adminWeeklyChallenge: document.getElementById('admin-weekly-challenge-view'),
            adminChallengeCompletion: document.getElementById('admin-challenge-completion-view'),
            assignedScenarios: document.getElementById('assigned-scenarios-view'),
            empathyAssistant: document.getElementById('empathy-assistant-view'),
            emailCrafter: document.getElementById('email-crafter-view'),
            savedEmails: document.getElementById('saved-emails-view'),
            rephraseTool: document.getElementById('rephrase-tool-view'),
            weeklyChallenge: document.getElementById('weekly-challenge-view'),
        };

        function showView(viewName) {
            Object.values(views).forEach(view => view && view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            if (viewName !== 'simulator') {
                saveCurrentViewState(viewName);
            }
        }

        // --- NEW MODAL FUNCTIONS ---
        function showModal(title, message, buttons = [{ text: 'OK', class: 'bg-blue-500', action: hideModal }]) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            const actionsContainer = document.getElementById('modal-actions');
            actionsContainer.innerHTML = '';
            buttons.forEach(btnInfo => {
                const button = document.createElement('button');
                button.textContent = btnInfo.text;
                button.className = `px-4 py-2 text-white text-base font-medium rounded-md w-full shadow-sm hover:opacity-80 focus:outline-none focus:ring-2 focus:ring-offset-2 ${btnInfo.class} mb-2`;
                button.onclick = btnInfo.action;
                actionsContainer.appendChild(button);
            });
            document.getElementById('app-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('app-modal').classList.add('hidden');
        }


        async function getFromAI(prompt, schema = null) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const modalLoading = document.getElementById('modal-loading');
            const empathyHelpLoading = document.getElementById('empathy-help-loading');
            const emailCraftLoading = document.getElementById('email-craft-loading');
            const rephraseToolLoading = document.getElementById('rephrase-tool-loading');
            
            if(loadingIndicator) loadingIndicator.classList.remove('hidden');
            if (modalLoading) modalLoading.classList.remove('hidden');
            if (empathyHelpLoading) empathyHelpLoading.classList.remove('hidden');
            if (emailCraftLoading) emailCraftLoading.classList.remove('hidden');
            if (rephraseToolLoading) rephraseToolLoading.classList.remove('hidden');
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }
            
            // NOTE: This key is for demonstration purposes. In a real application,
            // this should be handled securely on a server.
            const apiKey = "AIzaSyAhYDpHKXbTYQeGW3A-3g47XXDMGyB8NU0";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const rawJson = result.candidates[0].content.parts[0].text;
                    // Robust JSON parsing
                    try {
                        return JSON.parse(rawJson.replace(/```json/g, '').replace(/```/g, '').trim());
                    } catch (parseError) {
                        console.error("Failed to parse JSON from AI response:", parseError);
                        console.error("Raw AI response:", rawJson);
                        return null;
                    }
                } else {
                     console.error("Invalid API response structure:", result);
                     if (result.promptFeedback) {
                         console.error("Prompt Feedback:", result.promptFeedback);
                     }
                    return null;
                }
            } catch (error) {
                console.error("Error with AI call:", error);
                return null;
            } finally {
                if(loadingIndicator) loadingIndicator.classList.add('hidden');
                if (modalLoading) modalLoading.classList.add('hidden');
                if (empathyHelpLoading) empathyHelpLoading.classList.add('hidden');
                if (emailCraftLoading) emailCraftLoading.classList.add('hidden');
                if (rephraseToolLoading) rephraseToolLoading.classList.add('hidden');
            }
        }

        // --- TTS Functions ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.length * 2;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        async function getAudioFromAI(text, persona) {
            const audioBtn = document.getElementById('play-audio-btn');
            const audioLoader = document.getElementById('audio-loader');
            audioBtn.classList.add('hidden');
            audioLoader.classList.remove('hidden');

            const emotions = ["frustrated", "annoyed", "anxious", "confused", "excited", "happy", "disappointed", "upset"];
            let foundEmotion = "neutral";
            for (const emotion of emotions) {
                if (persona.toLowerCase().includes(emotion)) {
                    foundEmotion = emotion;
                    break;
                }
            }
            
            const prompt = `Say in a ${foundEmotion} tone: ${text}`;
            
            const payload = {
                model: "gemini-2.5-flash-preview-tts",
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                }
            };

            const apiKey = "AIzaSyAhYDpHKXbTYQeGW3A-3g47XXDMGyB8NU0";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error("Could not parse sample rate from mime type.");
                    
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    new Audio(audioUrl).play();
                } else {
                    console.error("Audio data not found in response", result);
                }

            } catch (error) {
                console.error("Error generating or playing audio:", error);
            } finally {
                audioLoader.classList.add('hidden');
                audioBtn.classList.remove('hidden');
            }
        }


        function saveSessionState() {
            if (!currentScenario) return;
            const state = { 
                currentScenario, 
                currentStep, 
                empathyScore, 
                sessionInteractions,
                responseText: document.getElementById('user-response').value 
            };
            sessionStorage.setItem('inProgressSession', JSON.stringify(state));
        }

        function clearSessionState() {
            sessionStorage.removeItem('inProgressSession');
            currentScenario = null;
        }

        // --- New General State Saving Functions ---
        function saveCurrentViewState(viewName) {
             const state = { currentView: viewName, data: {} };
             switch (viewName) {
                 case 'empathyAssistant':
                       state.data.situation = document.getElementById('situation-description').value;
                       break;
                 case 'emailCrafter':
                       state.data.customerEmail = document.getElementById('customer-email-input').value;
                       state.data.resolution = document.getElementById('resolution-input').value;
                       state.data.alternatives = document.getElementById('alternatives-input').value;
                       break;
                 case 'createScenario':
                       state.data.topic = document.getElementById('scenario-topic').value;
                       break;
                 case 'rephraseTool':
                       state.data.customerStatement = document.getElementById('rephrase-customer-statement').value;
                       state.data.agentDraft = document.getElementById('rephrase-agent-draft').value;
                       break;
             }
             sessionStorage.setItem('lastViewState', JSON.stringify(state));
        }

        function loadLastViewState() {
            const savedStateJSON = sessionStorage.getItem('lastViewState');
            if (!savedStateJSON) return false;

            try {
                const savedState = JSON.parse(savedStateJSON);
                if (savedState && savedState.currentView && views[savedState.currentView]) {
                    showView(savedState.currentView);
                    // Restore data
                    switch (savedState.currentView) {
                        case 'empathyAssistant':
                             document.getElementById('situation-description').value = savedState.data.situation || '';
                             break;
                        case 'emailCrafter':
                             document.getElementById('customer-email-input').value = savedState.data.customerEmail || '';
                             document.getElementById('resolution-input').value = savedState.data.resolution || '';
                             document.getElementById('alternatives-input').value = savedState.data.alternatives || '';
                             break;
                        case 'createScenario':
                             document.getElementById('scenario-topic').value = savedState.data.topic || '';
                             break;
                        case 'rephraseTool':
                             document.getElementById('rephrase-customer-statement').value = savedState.data.customerStatement || '';
                             document.getElementById('rephrase-agent-draft').value = savedState.data.agentDraft || '';
                             break;
                    }
                    return true;
                }
            } catch (e) {
                console.error("Failed to parse last view state:", e);
                sessionStorage.removeItem('lastViewState');
                return false;
            }
            return false;
        }

        function clearAllState() {
            clearSessionState();
            sessionStorage.removeItem('lastViewState');
        }
        // --- End of New Functions ---

        function loadSessionState() {
            const savedStateJSON = sessionStorage.getItem('inProgressSession');
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    // **** START FIX ****
                    // Add validation to ensure the loaded state is usable
                    if (!savedState || !savedState.currentScenario || !savedState.currentScenario.dialogue_tree) {
                        console.error("Incomplete session state found in sessionStorage.", savedState);
                        clearSessionState();
                        return false;
                    }
                    // **** END FIX ****

                    currentScenario = savedState.currentScenario;
                    currentStep = savedState.currentStep;
                    empathyScore = savedState.empathyScore;
                    sessionInteractions = savedState.sessionInteractions || []; // Ensure interactions is an array
                    showView('simulator');
                    loadStep();
                    document.getElementById('user-response').value = savedState.responseText || '';
                    return true;
                } catch (e) {
                    console.error("Failed to parse or process saved session state:", e);
                    clearSessionState();
                    return false;
                }
            }
            return false;
        }

        async function getAllScenarios() {
            let scenarios = [...defaultScenarios];
            const { data, error: scenariosError } = await db.from('scenarios').select();
            if (scenariosError) {
                console.error("Could not load user-created scenarios:", scenariosError.message);
            } else {
                scenarios = scenarios.concat(data);
            }
            return scenarios;
        }

        async function startRandomScenario() {
            showView('simulator');
            document.getElementById('scenario-title').textContent = "Finding a scenario...";
            document.getElementById('customer-persona').textContent = "";
            document.getElementById('customer-dialogue').innerHTML = '<div class="loader mx-auto"></div>';
            document.getElementById('response-area').classList.add('hidden');
            
            const scenarios = await getAllScenarios();
            let availableScenarios = scenarios.filter(s => s.id !== lastPlayedScenarioId);
            if (availableScenarios.length === 0) availableScenarios = scenarios;
            if (availableScenarios.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableScenarios.length);
                const chosenScenario = availableScenarios[randomIndex];
                lastPlayedScenarioId = chosenScenario.id;
                startScenario(chosenScenario);
            } else {
                document.getElementById('scenario-title').textContent = "Error";
                document.getElementById('customer-dialogue').textContent = "No scenarios found. Please create one first.";
            }
        }

        function startScenario(scenarioData, challengeId = null) {
            currentScenario = { ...scenarioData, weekly_challenge_id: challengeId };
            currentStep = 0;
            empathyScore = 50;
            sessionInteractions = [];
            showView('simulator');
            loadStep();
            saveSessionState();
        }

        function loadStep() {
            const feedbackContainer = document.getElementById('feedback-container');
            const suggestionsContainer = document.getElementById('suggestions-container');
            const toneAnalysisContainer = document.getElementById('tone-analysis-container');
            const nextBtn = document.getElementById('next-btn');
            const responseArea = document.getElementById('response-area');
            const userResponse = document.getElementById('user-response');

            feedbackContainer.classList.add('hidden');
            suggestionsContainer.classList.add('hidden');
            toneAnalysisContainer.classList.add('hidden');
            nextBtn.classList.add('hidden');
            responseArea.classList.remove('hidden');
            userResponse.value = '';
            
            const stepData = currentScenario.dialogue_tree[currentStep];
            if (!stepData) {
                showCompletionScreen();
                return;
            }

            document.getElementById('scenario-title').textContent = currentScenario.title;
            document.getElementById('customer-persona').textContent = currentScenario.persona;
            document.getElementById('customer-dialogue').textContent = stepData.customer;
            
            document.getElementById('play-audio-btn').onclick = () => getAudioFromAI(stepData.customer, currentScenario.persona);

            updateEmpathyMeter();
        }

        async function handleSubmitResponse() {
            const userResponse = document.getElementById('user-response');
            const responseText = userResponse.value.trim();
            if (!responseText) return;
            document.getElementById('response-area').classList.add('hidden');
            const feedbackPrompt = `You are an expert customer service training coach for Kindly!. Evaluate a user's response. **Scenario:** ${currentScenario.title} | **Customer's Statement:** "${currentScenario.dialogue_tree[currentStep].customer}" | **User's Response:** "${responseText}". Provide your evaluation as a JSON object: { "score": <integer 0-100>, "feedback": "<concise, constructive feedback>" }`;
            const feedbackSchema = { type: "OBJECT", properties: { "score": { "type": "INTEGER" }, "feedback": { "type": "STRING" } }, required: ["score", "feedback"] };
            const bestAnswerPrompt = `You are a customer service expert for Kindly!. **Scenario:** ${currentScenario.title} | **Customer's Statement:** "${currentScenario.dialogue_tree[currentStep].customer}". Provide three distinct, ideal, and empathetic responses a top-tier agent would give. Return a JSON object: { "ideal_responses": ["<response 1>", "<response 2>", "<response 3>"] }`;
            const bestAnswerSchema = { type: "OBJECT", properties: { "ideal_responses": { "type": "ARRAY", "items": { "type": "STRING" } } }, required: ["ideal_responses"] };
            const [feedbackResult, bestAnswerResult] = await Promise.all([ getFromAI(feedbackPrompt, feedbackSchema), getFromAI(bestAnswerPrompt, bestAnswerSchema) ]);
            handleAIResponse(responseText, feedbackResult, bestAnswerResult);
        }

        function handleAIResponse(userResp, feedback, bestAnswers) {
            const score = feedback?.score ?? 50;
            const feedbackText = feedback?.feedback ?? "Sorry, there was an error getting feedback.";
            const idealResponses = bestAnswers?.ideal_responses ?? ["Could not generate ideal responses."];
            sessionInteractions.push({ customerSays: currentScenario.dialogue_tree[currentStep].customer, userResponse: userResp, aiFeedback: feedbackText, aiScore: score, idealResponses: idealResponses });
            let feedbackHTML = `<div class="feedback-card border border-gray-200 rounded-lg p-4"><h4 class="font-bold text-lg mb-2">AI Coach Feedback:</h4><p class="text-gray-700">${feedbackText}</p><p class="font-bold text-right mt-2">Score: ${score}/100</p></div>`;
            if (score < 100) {
                feedbackHTML += `<div class="mt-4 p-4 bg-green-50 rounded-lg"><strong class="text-green-700">Here are a few examples of highly empathetic responses:</strong><ul class="list-disc list-inside mt-2 text-sm text-green-800">${idealResponses.map(r => `<li>${r}</li>`).join('')}</ul></div>`;
            }
            const feedbackContainer = document.getElementById('feedback-container');
            feedbackContainer.innerHTML = feedbackHTML;
            feedbackContainer.classList.remove('hidden');
            const scoreChange = (score - 50) / 2;
            empathyScore = Math.max(0, Math.min(100, empathyScore + scoreChange));
            updateEmpathyMeter();
            currentStep++;
            saveSessionState();
            const nextBtn = document.getElementById('next-btn');
            if (currentScenario.title.includes("AI Quick-Fire")) {
                // It's a single-step scenario, so we save it immediately.
                saveCompletedSession(currentScenario, empathyScore, sessionInteractions);
                
                nextBtn.textContent = "Next AI Problem";
                nextBtn.onclick = startAIQuickFireRound;
                nextBtn.classList.remove('hidden');
            } else if (currentScenario.dialogue_tree[currentStep]) {
                nextBtn.textContent = "Next Step";
                nextBtn.onclick = loadStep;
                nextBtn.classList.remove('hidden');
            } else {
                setTimeout(showCompletionScreen, 1500);
            }
        }

        function updateEmpathyMeter() {
            document.getElementById('empathy-meter').style.width = `${empathyScore}%`;
        }

        async function showCompletionScreen() {
            // Capture the state before clearing it
            const scenarioToSave = currentScenario;
            const scoreToSave = empathyScore;
            const interactionsToSave = [...sessionInteractions];

            clearSessionState();
            document.getElementById('email-draft-container').classList.add('hidden');
            document.getElementById('email-draft-content').classList.add('hidden');
            document.getElementById('email-draft-loading').classList.add('hidden');
            const finalFeedback = document.getElementById('final-feedback');
            if (empathyScore > 75) finalFeedback.textContent = "Outstanding! You consistently demonstrated strong empathy and effective communication.";
            else if (empathyScore > 40) finalFeedback.textContent = "Good work. You navigated the conversation well. Continue to focus on consistently validating feelings.";
            else finalFeedback.textContent = "That was a challenging scenario. Remember to always start by acknowledging the customer's emotions. Give it another try!";
            showView('completion');
            await saveCompletedSession(scenarioToSave, scoreToSave, interactionsToSave);
        }

        async function saveCompletedSession(scenario, score, interactions) {
            if (!userId || !scenario || interactions.length === 0) return;

            // Calculate the average score from the AI coach feedback.
            const totalAiScore = interactions.reduce((sum, interaction) => sum + (interaction.aiScore || 0), 0);
            const averageScore = Math.round(totalAiScore / interactions.length);

            const sessionPayload = { 
                user_id: userId, 
                scenario_title: scenario.title, 
                final_empathy_score: averageScore, // Use the new average score
                interactions: interactions
            };

            if (scenario.weekly_challenge_id) {
                sessionPayload.weekly_challenge_id = scenario.weekly_challenge_id;
            }

            const { error: saveError } = await db.from('sessions').insert(sessionPayload);
            if (saveError) console.error("Error saving session:", saveError.message);
        }
        
        async function showHistoryList() {
            showView('historyList');
            const container = document.getElementById('history-list-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            if (!userId) { container.innerHTML = '<p>Please log in to see your history.</p>'; return; }
            
            const { data, error: historyError } = await db.from('sessions').select('*').eq('user_id', userId).order('completed_at', { ascending: false });

            if (historyError) {
                console.error("Error fetching history:", historyError.message);
                container.innerHTML = '<p class="text-red-500">Could not load history.</p>';
                return;
            }

            container.innerHTML = '';
            if (data.length === 0) { container.innerHTML = '<p class="text-center text-gray-500">You haven\'t completed any scenarios yet.</p>'; return; }
            
            data.forEach(session => {
                const item = document.createElement('div');
                item.className = 'history-item bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md';
                item.innerHTML = `<div class="flex justify-between items-center"><div><h4 class="font-bold">${session.scenario_title}</h4><p class="text-sm text-gray-500">Completed: ${new Date(session.completed_at).toLocaleDateString()}</p></div><div class="text-lg font-bold text-blue-600">Score: ${session.final_empathy_score}</div></div>`;
                item.addEventListener('click', () => showHistoryDetail(session.id));
                container.appendChild(item);
            });
        }

        async function showHistoryDetail(sessionId, fromAdmin = false) {
            showView('historyDetail');
            const container = document.getElementById('history-detail-interactions');
            container.innerHTML = '<div class="loader mx-auto"></div>';

            const { data: sessionData, error: sessionError } = await db.from('sessions')
                .select('*')
                .eq('id', sessionId)
                .single();

            if (sessionError || !sessionData) {
                console.error("Error fetching session details:", sessionError?.message);
                container.innerHTML = '<p class="text-red-500">Could not load session details.</p>';
                return;
            }

            document.getElementById('history-detail-title').textContent = sessionData.scenario_title;
            document.getElementById('history-detail-score').textContent = sessionData.final_empathy_score;
            document.getElementById('history-summary-container').classList.add('hidden');
            document.getElementById('history-summary-container').innerHTML = '';
            document.getElementById('back-to-history-list-btn').onclick = fromAdmin ? showAdminSessionList : showHistoryList;
            
            container.innerHTML = '';

            sessionData.interactions.forEach((interaction, index) => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'border-t pt-4';

                let coachFeedbackHTML = '';
                const coachFeedback = interaction.coach_feedback || '';

                if (fromAdmin) {
                    coachFeedbackHTML = `
                        <div id="coach-feedback-container-${sessionData.id}-${index}" class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div id="coach-feedback-view-${sessionData.id}-${index}">
                                <div class="flex justify-between items-center mb-1">
                                    <strong class="text-yellow-800">Coach Feedback:</strong>
                                    <button data-session-id="${sessionData.id}" data-interaction-index="${index}" class="edit-coach-feedback-btn text-sm text-blue-600 hover:text-blue-800 font-semibold">
                                        ${coachFeedback ? 'Edit Feedback' : 'Add Feedback'}
                                    </button>
                                </div>
                                <p class="text-yellow-700 italic">${coachFeedback || 'No feedback added yet.'}</p>
                            </div>
                        </div>
                    `;
                } else {
                     coachFeedbackHTML = `
                         <div class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                             <strong class="text-yellow-800">Coach Feedback:</strong>
                             <p class="text-yellow-700 italic">${coachFeedback || 'No feedback has been added by a coach yet.'}</p>
                         </div>
                     `;
                }

                stepDiv.innerHTML = `
                    <p class="mb-2"><strong class="text-gray-500">Customer said:</strong> "${interaction.customerSays}"</p>
                    <p class="mb-2 p-2 bg-blue-50 rounded"><strong class="text-blue-700">User's response:</strong> "${interaction.userResponse}"</p>
                    <div class="mb-2 p-2 bg-gray-50 rounded">
                        <p><strong class="text-gray-700">AI Feedback (Score: ${interaction.aiScore}):</strong> ${interaction.aiFeedback}</p>
                    </div>
                    <div class="p-2 bg-green-50 rounded"><strong class="text-green-700">Ideal Responses:</strong><ul class="list-disc list-inside mt-1 text-sm text-green-800">${interaction.idealResponses.map(r => `<li>${r}</li>`).join('')}</ul></div>
                    ${coachFeedbackHTML}
                `;
                container.appendChild(stepDiv);
            });
            
            document.getElementById('get-summary-btn').onclick = () => getHistorySummaryFromAI(sessionData);

            if (fromAdmin) {
                container.querySelectorAll('.edit-coach-feedback-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const button = e.target;
                        const index = button.dataset.interactionIndex;
                        const sessionId = button.dataset.sessionId;
                        const feedbackContainer = document.getElementById(`coach-feedback-container-${sessionId}-${index}`);
                        const currentFeedback = sessionData.interactions[index].coach_feedback || '';

                        feedbackContainer.innerHTML = `
                            <strong class="text-yellow-800">Coach Feedback:</strong>
                            <textarea class="w-full border rounded p-2 text-sm mt-1">${currentFeedback}</textarea>
                            <div class="flex justify-end space-x-2 mt-2">
                                <button class="cancel-coach-feedback-btn text-sm bg-gray-200 px-3 py-1 rounded-md">Cancel</button>
                                <button class="save-coach-feedback-btn text-sm bg-green-500 text-white px-3 py-1 rounded-md">Save</button>
                            </div>
                        `;

                        feedbackContainer.querySelector('.save-coach-feedback-btn').addEventListener('click', async () => {
                            const saveButton = feedbackContainer.querySelector('.save-coach-feedback-btn');
                            saveButton.textContent = 'Saving...';
                            saveButton.disabled = true;
                            const newFeedback = feedbackContainer.querySelector('textarea').value;
                            const newInteractions = [...sessionData.interactions];
                            newInteractions[index] = { ...newInteractions[index], coach_feedback: newFeedback };
                            const { error: updateError } = await db.from('sessions')
                                .update({ interactions: newInteractions })
                                .eq('id', sessionId);
                            if (updateError) {
                                console.error("Failed to save coach feedback:", updateError.message);
                                showModal('Error', `Save Failed: ${updateError.message}. This is likely a database security rule issue.`, [{ text: 'OK', class: 'bg-red-500', action: hideModal }]);
                                showHistoryDetail(sessionId, true);
                            } else {
                                showHistoryDetail(sessionId, true);
                            }
                        });
                        
                        feedbackContainer.querySelector('.cancel-coach-feedback-btn').addEventListener('click', () => {
                             showHistoryDetail(sessionId, true);
                        });
                    });
                });
            }
        }
        
        async function getToneAnalysisFromAI() {
            const userResponse = document.getElementById('user-response');
            const toneAnalysisContainer = document.getElementById('tone-analysis-container');
            const responseText = userResponse.value.trim();
            if (!responseText) {
                userResponse.classList.add('border-red-500', 'placeholder-red-500');
                userResponse.placeholder = "Please write a response before analyzing the tone.";
                setTimeout(() => {
                    userResponse.classList.remove('border-red-500', 'placeholder-red-500');
                    userResponse.placeholder = "Type your empathetic response here...";
                }, 3000);
                return;
            }
            const prompt = `As a customer service coach, analyze the tone of this agent's response. Customer says: "${currentScenario.dialogue_tree[currentStep].customer}". Agent's draft response: "${responseText}". Provide a one-sentence tone analysis and a one-sentence suggestion for improvement if needed. Return a JSON object: { "analysis": "<string>", "suggestion": "<string>" }`;
            const schema = { type: "OBJECT", properties: { "analysis": { "type": "STRING" }, "suggestion": { "type": "STRING" } }, required: ["analysis", "suggestion"] };
            const result = await getFromAI(prompt, schema);
            toneAnalysisContainer.innerHTML = result ? `<div class="p-2 bg-indigo-50 border border-indigo-200 rounded-md text-sm"><p><strong>Tone Analysis:</strong> ${result.analysis}</p><p><strong>Suggestion:</strong> ${result.suggestion}</p></div>` : `<p class="text-sm text-red-500">Could not analyze tone.</p>`;
            toneAnalysisContainer.classList.remove('hidden');
        }

        async function getSuggestionsFromAI() {
            const userResponse = document.getElementById('user-response');
            const suggestionsContainer = document.getElementById('suggestions-container');
            const responseText = userResponse.value.trim();
            if (!responseText) {
                userResponse.classList.add('border-red-500', 'placeholder-red-500');
                userResponse.placeholder = "Please write a response to get suggestions.";
                setTimeout(() => {
                    userResponse.classList.remove('border-red-500', 'placeholder-red-500');
                    userResponse.placeholder = "Type your empathetic response here...";
                }, 3000);
                return;
            }
            const prompt = `You are a customer service expert for Kindly!. The customer said: "${currentScenario.dialogue_tree[currentStep].customer}". The agent has drafted this response: "${responseText}". Provide three distinct, alternative empathetic phrases or opening lines the agent could use. Return a JSON object: { "suggestions": ["<suggestion 1>", "<suggestion 2>", "<suggestion 3>"] }`;
            const schema = { type: "OBJECT", properties: { "suggestions": { "type": "ARRAY", "items": { "type": "STRING" } } }, required: ["suggestions"] };
            const result = await getFromAI(prompt, schema);
            if (result && result.suggestions) {
                 suggestionsContainer.innerHTML = `<div class="p-2 bg-blue-50 border border-blue-200 rounded-md text-sm">
                     <strong>Suggestions:</strong>
                     <ul class="list-disc list-inside mt-1">
                         ${result.suggestions.map(s => `<li>${s}</li>`).join('')}
                     </ul>
                 </div>`;
            } else {
                suggestionsContainer.innerHTML = `<p class="text-sm text-red-500">Could not get suggestions.</p>`;
            }
            suggestionsContainer.classList.remove('hidden');
        }

        async function getHistorySummaryFromAI(sessionData) {
            const summaryContainer = document.getElementById('history-summary-container');
            summaryContainer.innerHTML = '<div class="loader mx-auto"></div>';
            summaryContainer.classList.remove('hidden');
            const interactionsText = sessionData.interactions.map(i => `Customer: "${i.customerSays}"\nYour Response: "${i.userResponse}" (Score: ${i.aiScore})\n`).join('\n');
            const prompt = `As a customer service coach, review this entire conversation from a Kindly! support simulation. Scenario: ${sessionData.scenario_title}. Conversation History: ${interactionsText}. Provide a concise summary of the agent's performance and one actionable tip for improvement. Return a JSON object: { "summary": "<string>", "tip": "<string>" }`;
            const schema = { type: "OBJECT", properties: { "summary": { "type": "STRING" }, "tip": { "type": "STRING" } }, required: ["summary", "tip"] };
            const result = await getFromAI(prompt, schema);
            summaryContainer.innerHTML = result ? `<p><strong>Summary:</strong> ${result.summary}</p><p><strong>Actionable Tip:</strong> ${result.tip}</p>` : `<p class="text-red-500">Could not generate a summary.</p>`;
        }

        async function getRephraseSuggestionsFromTool() {
            const customerStatement = document.getElementById('rephrase-customer-statement').value.trim();
            const agentDraft = document.getElementById('rephrase-agent-draft').value.trim();
            const suggestionsContainer = document.getElementById('rephrase-tool-suggestions-container');
            const loading = document.getElementById('rephrase-tool-loading');

            if (!customerStatement || !agentDraft) {
                showModal('Input Required', 'Please fill in both the customer\'s statement and your draft response.');
                return;
            }

            loading.classList.remove('hidden');
            suggestionsContainer.classList.add('hidden');

            const prompt = `You are an expert customer service writing coach for Kindly!. An agent needs help rephrasing their response.
            Customer's statement: "${customerStatement}"
            Agent's current draft: "${agentDraft}"
            Provide three distinct, improved versions of the agent's response. The new versions should be more empathetic and professional. Focus on improving the phrasing, not adding new information. Return a JSON object: { "rephrased_suggestions": ["<suggestion 1>", "<suggestion 2>", "<suggestion 3>"] }`;
            
            const schema = { type: "OBJECT", properties: { "rephrased_suggestions": { "type": "ARRAY", "items": { "type": "STRING" } } }, required: ["rephrased_suggestions"] };
            
            const result = await getFromAI(prompt, schema);
            
            loading.classList.add('hidden');
            suggestionsContainer.classList.remove('hidden');

            if (result && result.rephrased_suggestions) {
                 suggestionsContainer.innerHTML = `<div class="p-4 bg-green-50 border border-green-200 rounded-md text-sm">
                      <strong class="text-green-800">Rephrasing Suggestions:</strong>
                      <ul class="mt-2 space-y-2">
                          ${result.rephrased_suggestions.map(s => `<li class="p-3 rounded-md bg-white hover:bg-green-100 flex justify-between items-center"><span>${s}</span><button class="copy-rephrase-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded">Copy</button></li>`).join('')}
                      </ul>
                 </div>`;
                 
                 suggestionsContainer.querySelectorAll('.copy-rephrase-btn').forEach(btn => {
                     btn.addEventListener('click', (e) => {
                         const textToCopy = e.target.previousElementSibling.textContent;
                         navigator.clipboard.writeText(textToCopy).then(() => {
                             e.target.textContent = 'Copied!';
                             setTimeout(() => { e.target.textContent = 'Copy'; }, 2000);
                         });
                     });
                 });

            } else {
                suggestionsContainer.innerHTML = `<p class="text-sm text-red-500 p-2">Could not get rephrasing suggestions at this time.</p>`;
            }
        }

        async function getEmpathyHelpFromAI() {
            const situationDescription = document.getElementById('situation-description').value.trim();
            const responseContainer = document.getElementById('empathy-response-container');
            if (!situationDescription) {
                responseContainer.innerHTML = `<p class="text-red-500">Please describe the situation first.</p>`;
                responseContainer.classList.remove('hidden');
                return;
            }
            responseContainer.classList.add('hidden');

            const prompt = `You are an expert empathy coach for customer service agents at Kindly!. An agent is facing a tough situation: "${situationDescription}".
            Your task is to provide a detailed, intelligence-powered empathy report to help the agent handle this with maximum emotional intelligence. Do not provide solutions.
            Analyze the situation and return a JSON object with the following structure:
            1.  "key_emotion": A single word or short phrase identifying the customer's core emotion (e.g., "Frustration", "Feeling unheard", "Disappointment").
            2.  "empathetic_phrases": An array of three distinct, professional, and highly empathetic phrases the agent can use throughout the conversation to validate the customer's feelings.
            3.  "assurance_statement": A single, powerful statement that validates their feeling and assures them you're there to help, without promising a specific outcome.
            4.  "coach_tip": A brief, actionable tip for the agent on the mindset they should adopt for this specific interaction.`;
            
            const schema = { 
                type: "OBJECT", 
                properties: { 
                    "key_emotion": { "type": "STRING" }, 
                    "empathetic_phrases": { "type": "ARRAY", "items": { "type": "STRING" } },
                    "assurance_statement": { "type": "STRING" },
                    "coach_tip": { "type": "STRING" }
                }, 
                required: ["key_emotion", "empathetic_phrases", "assurance_statement", "coach_tip"] 
            };
            
            const result = await getFromAI(prompt, schema);

            if (result) {
                responseContainer.innerHTML = `
                    <div class="p-4 bg-purple-50 rounded-lg border border-purple-200">
                        <h3 class="text-lg font-bold text-purple-800 mb-3">AI Empathy Coach Report</h3>
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700">Core Customer Emotion:</p>
                            <p class="text-purple-700 italic">${result.key_emotion}</p>
                        </div>
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700">Ways to Show Empathy:</p>
                            <ul class="list-disc list-inside text-purple-700 space-y-1 mt-1">
                                ${result.empathetic_phrases.map(line => `<li>${line}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700">Core Assurance Statement:</p>
                            <p class="text-purple-700">"${result.assurance_statement}"</p>
                        </div>
                        <div class="p-3 bg-indigo-100 rounded">
                            <p class="font-semibold text-indigo-800">üí° Coach's Tip for You:</p>
                            <p class="text-indigo-700">${result.coach_tip}</p>
                        </div>
                    </div>
                `;
            } else {
                 responseContainer.innerHTML = `<p class="text-red-500">Sorry, I couldn't generate a response. Please try re-phrasing your situation.</p>`;
            }
            responseContainer.classList.remove('hidden');
        }

        async function startAIQuickFireRound() {
            showView('simulator');
            document.getElementById('scenario-title').textContent = "AI is thinking of a problem...";
            document.getElementById('customer-persona').textContent = "";
            document.getElementById('customer-dialogue').innerHTML = '<div class="loader mx-auto"></div>';
            document.getElementById('response-area').classList.add('hidden');

            const prompt = `You are a Kindly! customer with a problem. In one sentence, state your problem clearly and with some emotion (e.g., frustration, confusion, excitement). Also, provide a brief one-sentence persona for yourself. Return a JSON object with keys "persona" and "customer_problem".`;
            const schema = { type: "OBJECT", properties: { "persona": { "type": "STRING" }, "customer_problem": { "type": "STRING" } }, required: ["persona", "customer_problem"] };
            const result = await getFromAI(prompt, schema);

            if (result) {
                const quickFireScenario = {
                    id: 'ai-quick-fire-' + Date.now(),
                    title: "‚ö° AI Quick-Fire Round",
                    persona: result.persona,
                    dialogue_tree: [{ customer: result.customer_problem }]
                };
                startScenario(quickFireScenario);
            } else {
                document.getElementById('scenario-title').textContent = "Error";
                document.getElementById('customer-dialogue').textContent = "Could not generate an AI problem. Please try again.";
            }
        }
        
        async function showAssignedScenarios() {
            showView('assignedScenarios');
            const container = document.getElementById('assigned-scenarios-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            if (!userId) { container.innerHTML = '<p>Could not identify user.</p>'; return; }
            
            const { data, error: assignedError } = await db.from('assigned_scenarios').select('scenario_data').eq('user_id', userId);
            
            if (assignedError) { console.error(assignedError); container.innerHTML = '<p>Could not load assigned scenarios.</p>'; return; }

            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">You have no assigned scenarios.</p>';
                return;
            }
            data.forEach(item => {
                const scenario = item.scenario_data;
                const card = document.createElement('div');
                card.className = 'card bg-white p-6 rounded-lg cursor-pointer';
                card.innerHTML = `<h3 class="text-xl font-bold mb-2 text-gray-800">${scenario.title}</h3><p class="text-gray-600">${scenario.description}</p>`;
                card.addEventListener('click', () => startScenario(scenario));
                container.appendChild(card);
            });
        }
        
        // --- NEW/MODIFIED ADMIN FUNCTIONS ---

        async function showAdminUserList() {
            showView('adminUserList');
            const container = document.getElementById('admin-user-list-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            
            const { data, error: usersError } = await db.from('users').select('id, email, role');

            if (usersError) { console.error(usersError); container.innerHTML = '<p>Could not load users.</p>'; return; }

            container.innerHTML = '';
            data.forEach(user => {
                const item = document.createElement('div');
                item.className = 'bg-white p-3 rounded-lg shadow-sm flex items-center justify-between space-x-4';
                item.dataset.userId = user.id;
                
                const userRole = user.role || 'agent';

                item.innerHTML = `
                    <div class="flex-grow">
                        <p class="user-email font-semibold">${user.email || user.id}</p>
                        <p class="text-sm text-gray-500">Role: <span class="font-medium ${userRole === 'admin' ? 'text-indigo-600' : 'text-gray-600'}">${userRole}</span></p>
                    </div>
                    <div class="flex space-x-2">
                        <button data-uid="${user.id}" data-current-role="${userRole}" class="toggle-admin-btn text-sm ${userRole === 'admin' ? 'bg-gray-500 hover:bg-gray-600' : 'bg-indigo-500 hover:bg-indigo-600'} text-white px-3 py-1 rounded-md">
                            ${userRole === 'admin' ? 'Remove Admin' : 'Make Admin'}
                        </button>
                        <button data-uid="${user.id}" class="delete-user-btn text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md">Delete</button>
                    </div>
                `;
                container.appendChild(item);
            });

            container.querySelectorAll('.toggle-admin-btn').forEach(btn => btn.addEventListener('click', handleToggleAdmin));
            container.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', handleDeleteUser));
        }

        async function showAssignScenariosAdminView() {
            showView('adminAssignScenarios');
            const container = document.getElementById('admin-assign-list-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';

            const { data, error: usersError } = await db.from('users').select('id, email');
            if (usersError) { console.error(usersError); container.innerHTML = '<p>Could not load users.</p>'; return; }

            container.innerHTML = ' ';
            data.forEach(user => {
                 const item = document.createElement('div');
                item.className = 'bg-white p-3 rounded-lg shadow-sm flex items-center justify-between space-x-4';
                item.dataset.userId = user.id;

                 item.innerHTML = `
                     <p class="user-email font-semibold">${user.email || user.id}</p>
                     <button data-uid="${user.id}" class="assign-scenario-btn text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md">Assign Scenario</button>
                 `;
                container.appendChild(item);
            });
            container.querySelectorAll('.assign-scenario-btn').forEach(btn => btn.addEventListener('click', (e) => openAssignScenarioModal(e.target.dataset.uid)));
        }
        
        function handleToggleAdmin(e) {
            const button = e.target;
            const targetUserId = button.dataset.uid;
            const currentRole = button.dataset.currentRole;
            const newRole = currentRole === 'admin' ? 'agent' : 'admin';
            const userEmail = button.closest('[data-user-id]').querySelector('.user-email').textContent;

            showModal(
                `Confirm Role Change`,
                `Are you sure you want to change ${userEmail}'s role to "${newRole}"?`,
                [
                    {
                        text: `Yes, change to ${newRole}`,
                        class: 'bg-indigo-600',
                        action: async () => {
                            button.textContent = 'Updating...';
                            button.disabled = true;
                            const { error: updateError } = await db.from('users').update({ role: newRole }).eq('id', targetUserId);
                            hideModal();
                            if (updateError) {
                                console.error("Error updating user role:", updateError.message);
                                showModal('Error', `Failed to update role: ${updateError.message}. Please ensure your Supabase RLS policies are set up correctly.`);
                            }
                            showAdminUserList(); // Refresh the list
                        }
                    },
                    { text: 'Cancel', class: 'bg-gray-300 text-gray-800', action: hideModal }
                ]
            );
        }

        function handleDeleteUser(e) {
            const button = e.target;
            const targetUserId = button.dataset.uid;

            showModal('Confirm Deletion', 'Are you sure you want to delete this user? This action is irreversible.', [
                {
                    text: 'Yes, Delete',
                    class: 'bg-red-600',
                    action: async () => {
                        const { error: deleteUserError } = await db.from('users').delete().eq('id', targetUserId);
                        hideModal();
                        if (deleteUserError) {
                            console.error("Error deleting user:", deleteUserError.message);
                            showModal('Error', `Failed to delete user: ${deleteUserError.message}. Please check your Supabase RLS policies.`);
                        } else {
                            const userRow = button.closest('[data-user-id]');
                            if (userRow) {
                                userRow.style.opacity = '0';
                                setTimeout(() => userRow.remove(), 300);
                            }
                        }
                    }
                },
                {
                    text: 'Cancel',
                    class: 'bg-gray-300 text-gray-800',
                    action: hideModal
                }
            ]);
        }

        async function openAssignScenarioModal(targetUserId) {
            const modal = document.getElementById('assign-scenario-modal');
            modal.classList.remove('hidden');
            
            modal.innerHTML = `
                <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                    <h3 class="text-lg font-medium">Create and Assign New Scenario</h3>
                    <p class="text-sm text-gray-500 mb-4">For User ID: ${targetUserId.substring(0,8)}...</p>
                    <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <div><label class="block text-sm">Title</label><input id="assign-title" type="text" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm">Description</label><input id="assign-description" type="text" class="w-full p-2 border rounded"></div>
                        <div><label class="block text-sm">Persona</label><textarea id="assign-persona" class="w-full p-2 border rounded" rows="2"></textarea></div>
                        <div><label class="block text-sm">Dialogue Step 1</label><textarea class="w-full p-2 border rounded assign-dialogue-step" rows="2"></textarea></div>
                        <div><label class="block text-sm">Dialogue Step 2</label><textarea class="w-full p-2 border rounded assign-dialogue-step" rows="2"></textarea></div>
                        <div><label class="block text-sm">Dialogue Step 3</label><textarea class="w-full p-2 border rounded assign-dialogue-step" rows="2"></textarea></div>
                    </div>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button onclick="document.getElementById('assign-scenario-modal').classList.add('hidden')" class="bg-gray-200 p-2 rounded">Cancel</button>
                        <button id="save-and-assign-btn" class="bg-blue-500 text-white p-2 rounded">Save and Assign</button>
                    </div>
                </div>`;

            document.getElementById('save-and-assign-btn').addEventListener('click', async (e) => {
                const button = e.target;
                button.textContent = 'Saving...';
                button.disabled = true;

                const newScenarioData = {
                    title: document.getElementById('assign-title').value,
                    description: document.getElementById('assign-description').value,
                    persona: document.getElementById('assign-persona').value,
                    dialogue_tree: Array.from(document.querySelectorAll('.assign-dialogue-step')).map(textarea => ({ customer: textarea.value })),
                    author_id: userId
                };

                const { data: newScenario, error: insertError } = await db.from('scenarios').insert(newScenarioData).select().single();

                if (insertError) {
                    console.error("Error saving new scenario:", insertError.message);
                    button.textContent = 'Save Failed!';
                    setTimeout(() => { button.textContent = 'Save and Assign'; button.disabled = false; }, 2000);
                    return;
                }

                const { error: assignError } = await db.from('assigned_scenarios').insert({
                    user_id: targetUserId,
                    scenario_id: newScenario.id,
                    scenario_data: newScenario
                });

                if (assignError) {
                    console.error("Error assigning scenario:", assignError.message);
                    button.textContent = 'Assign Failed!';
                    setTimeout(() => { button.textContent = 'Save and Assign'; button.disabled = false; }, 2000);
                } else {
                    button.textContent = 'Assigned!';
                    setTimeout(() => {
                        document.getElementById('assign-scenario-modal').classList.add('hidden');
                    }, 1500);
                }
            });
        }
        
        async function showAdminSessionList() {
            showView('adminSessionList');
            const container = document.getElementById('admin-session-list-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            
            const { data, error: sessionsError } = await db.from('sessions').select(`
                *,
                users (email)
            `).order('completed_at', { ascending: false });
            
            if (sessionsError) { 
                console.error(sessionsError); 
                container.innerHTML = `<p class="text-red-500">Could not load sessions. Error: ${sessionsError.message}</p>`; 
                return; 
            }

            container.innerHTML = '';
            if (data.length === 0) { 
                container.innerHTML = '<p class="text-center">No user sessions found.</p>'; 
                return; 
            }
            data.forEach(session => {
                const item = document.createElement('div');
                item.className = 'history-item bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md';
                item.innerHTML = `<div class="flex justify-between items-center"><div><h4 class="font-bold">${session.scenario_title}</h4><p class="text-sm text-gray-500">User: ${session.users ? session.users.email : session.user_id.substring(0,8)+'...'} | Completed: ${new Date(session.completed_at).toLocaleDateString()}</p></div><div class="text-lg font-bold text-blue-600">Score: ${session.final_empathy_score}</div></div>`;
                item.addEventListener('click', () => showHistoryDetail(session.id, true));
                 container.appendChild(item);
            });
        }
        
        async function craftFollowUpEmailFromTool() {
            const customerEmail = document.getElementById('customer-email-input').value.trim();
            const resolution = document.getElementById('resolution-input').value.trim();
            const alternatives = document.getElementById('alternatives-input').value.trim();
            const outputContainer = document.getElementById('crafted-email-container');

            if (!customerEmail || !resolution) {
                showModal('Input Required', 'Please provide the original customer email and the resolution details.');
                return;
            }
            
            outputContainer.classList.add('hidden');

            const prompt = `You are a professional and empathetic customer support agent for Kindly! named Alex. Craft a follow-up email based on the following information.

            **Original Customer Email (for context on their tone and problem):**
            "${customerEmail}"

            **Your Goal / Key Information to Convey:**
            "${resolution}"

            **Alternative Solutions or Extra Details to Include (if any):**
            "${alternatives}"

            **Instructions for the email body:**
            1.  **Structure:** Organize the email into clear paragraphs with proper spacing. It should not be one block of text.
            2.  **Tone:** Analyze the customer's email to determine their tone. If they are frustrated, be extra empathetic. If they are asking a simple question, be welcoming and clear.
            3.  **Standard Opening:** Start the email with "Hi [Customer Name]," (extract their name from their email if possible, otherwise use "Hi there,"), followed by a new paragraph: "Thank you for reaching out to Kindly! Support. My name is Alex."
            4.  **Content:** Address their issue directly, provide the resolution, and include any alternatives clearly.
            5.  **Standard Closing:** End the email with the following lines, each on a new line: "Please let us know if you have any further questions; we would be happy to assist you.", "Thank you for contacting us!", "Kindly! Support Team".

            Return the email as a JSON object with "subject" and "body" keys. The body should be plain text, well-formatted with line breaks for paragraphs.`;

            const schema = { 
                type: "OBJECT", 
                properties: { 
                    "subject": { "type": "STRING" }, 
                    "body": { "type": "STRING" } 
                }, 
                required: ["subject", "body"] 
            };

            const result = await getFromAI(prompt, schema);
            
            if (result && result.subject && result.body) {
                document.getElementById('crafted-email-subject').value = result.subject;
                document.getElementById('crafted-email-body').value = result.body;
                outputContainer.classList.remove('hidden');
            } else {
                showModal('Error', 'Sorry, the AI could not craft an email. Please try again.');
            }
        }

        async function recraftEmail() {
            const customerEmail = document.getElementById('customer-email-input').value.trim();
            const resolution = document.getElementById('resolution-input').value.trim();
            const alternatives = document.getElementById('alternatives-input').value.trim();
            const previousDraft = document.getElementById('crafted-email-body').value;
            const feedback = document.getElementById('recraft-feedback-input').value.trim();
            const outputContainer = document.getElementById('crafted-email-container');
            const feedbackContainer = document.getElementById('recraft-feedback-container');

            if (!feedback) {
                showModal('Input Required', 'Please provide feedback for the recraft.');
                return;
            }

            feedbackContainer.classList.add('hidden'); // Hide feedback form while processing

            const prompt = `You are a professional and empathetic customer support agent for Kindly! named Alex. You are revising an email draft based on feedback.

            **Original Customer Email (for context):**
            "${customerEmail}"

            **Original Goal / Key Information to Convey:**
            "${resolution}"

            **Alternative Solutions or Extra Details (if any):**
            "${alternatives}"

            **Previous Draft You Wrote:**
            "${previousDraft}"

            **Feedback for Revision:**
            "${feedback}"

            **Your Task:**
            Rewrite the email. Incorporate the feedback while strictly following all instructions below.

            **Instructions for the email body:**
            1.  **Structure:** Organize the email into clear paragraphs with proper spacing. It must not be one block of text.
            2.  **Tone:** Analyze the customer's original email and your previous draft to set the correct tone. Apply the user's feedback (e.g., "be more apologetic").
            3.  **Standard Opening:** Start the email with "Hi [Customer Name]," (extract their name from their email if possible, otherwise use "Hi there,"), followed by a new paragraph: "Thank you for reaching out to Kindly! Support. My name is Alex."
            4.  **Content:** Address their issue directly, provide the resolution, and include any alternatives clearly.
            5.  **Standard Closing:** End the email with the following lines, each on a new line: "Please let us know if you have any further questions; we would be happy to assist you.", "Thank you for contacting us!", "Kindly! Support Team".

            Return the revised email as a JSON object with "subject" and "body" keys. The body must be plain text, well-formatted with line breaks for paragraphs.`;
            
            const schema = { 
                type: "OBJECT", 
                properties: { "subject": { "type": "STRING" }, "body": { "type": "STRING" } }, 
                required: ["subject", "body"] 
            };

            const result = await getFromAI(prompt, schema);
            
            if (result && result.subject && result.body) {
                document.getElementById('crafted-email-subject').value = result.subject;
                document.getElementById('crafted-email-body').value = result.body;
            } else {
                showModal('Error', 'Sorry, the AI could not recraft the email. Please try again.');
            }
        }

        async function saveCraftedEmail() {
            const subject = document.getElementById('crafted-email-subject').value;
            const body = document.getElementById('crafted-email-body').value;
            const category = document.getElementById('email-category-input').value.trim();
            const saveBtn = document.getElementById('save-email-btn');

            if (!userId || !subject || !body) return;

            const { error: saveEmailError } = await db.from('saved_emails').insert({
                user_id: userId,
                subject: subject,
                body: body,
                category: category || null // Save as null if empty
            });

            if (saveEmailError) {
                console.error("Error saving email:", saveEmailError.message);
                saveBtn.textContent = "Save Failed";
            } else {
                saveBtn.textContent = "Saved!";
            }

            setTimeout(() => {
                saveBtn.textContent = "Save to My Emails";
            }, 2000);
        }

        async function showSavedEmails() {
            showView('savedEmails');
            const container = document.getElementById('saved-emails-container');
            const filterDropdown = document.getElementById('category-filter');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            if (!userId) { container.innerHTML = '<p>Please log in to see your saved emails.</p>'; return; }
            
            const { data: emails, error: fetchEmailsError } = await db.from('saved_emails').select('*').eq('user_id', userId).order('created_at', { ascending: false });

            if (fetchEmailsError) {
                console.error("Error fetching saved emails:", fetchEmailsError.message);
                container.innerHTML = '<p class="text-red-500">Could not load your saved emails.</p>';
                return;
            }
            
            // Populate category filter
            const categories = [...new Set(emails.map(e => e.category).filter(Boolean))];
            filterDropdown.innerHTML = '<option value="all">All Categories</option>';
            categories.sort().forEach(cat => {
                filterDropdown.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            filterDropdown.onchange = () => renderSavedEmails(emails, filterDropdown.value);

            renderSavedEmails(emails, 'all');
        }

        function renderSavedEmails(emails, categoryFilter) {
            const container = document.getElementById('saved-emails-container');
            container.innerHTML = '';

            const filteredEmails = categoryFilter === 'all' 
                ? emails 
                : emails.filter(e => e.category === categoryFilter);

            if (filteredEmails.length === 0) { 
                container.innerHTML = '<p class="text-center text-gray-500">You haven\'t saved any emails in this category yet.</p>'; 
                return; 
            }
            
            filteredEmails.forEach(email => {
                const item = document.createElement('div');
                item.className = 'history-item bg-white p-4 rounded-lg shadow-sm';
                item.dataset.emailId = email.id;
                
                const categoryBadge = email.category ? `<span class="ml-2 text-xs font-semibold bg-teal-100 text-teal-800 px-2 py-1 rounded-full">${email.category}</span>` : '';

                item.innerHTML = `
                    <div id="view-${email.id}">
                        <details>
                            <summary class="font-bold cursor-pointer hover:text-teal-600 flex items-center">${email.subject}${categoryBadge}</summary>
                            <div class="mt-4 p-4 bg-gray-50 border rounded-md whitespace-pre-wrap">${email.body}</div>
                        </details>
                        <div class="flex justify-end space-x-2 mt-2">
                            <button class="edit-email-btn text-sm text-blue-600 hover:text-blue-800">Edit</button>
                            <button class="delete-email-btn text-sm text-red-600 hover:text-red-800">Delete</button>
                        </div>
                    </div>
                    <div id="edit-${email.id}" class="hidden space-y-2">
                         <input type="text" value="${email.subject}" class="font-bold w-full p-2 border rounded-md" placeholder="Subject">
                         <input type="text" value="${email.category || ''}" class="text-sm w-full p-2 border rounded-md" placeholder="Category">
                         <textarea class="w-full p-2 border rounded-md" rows="8" placeholder="Email body">${email.body}</textarea>
                         <div class="flex justify-end space-x-2 mt-2">
                            <button class="cancel-edit-btn text-sm bg-gray-200 px-3 py-1 rounded-md">Cancel</button>
                            <button class="save-changes-btn text-sm bg-green-500 text-white px-3 py-1 rounded-md">Save Changes</button>
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });

            // Add event listeners
            container.querySelectorAll('.delete-email-btn').forEach(btn => btn.addEventListener('click', handleDeleteEmail));
            container.querySelectorAll('.edit-email-btn').forEach(btn => btn.addEventListener('click', handleEditEmail));
            container.querySelectorAll('.cancel-edit-btn').forEach(btn => btn.addEventListener('click', handleCancelEdit));
            container.querySelectorAll('.save-changes-btn').forEach(btn => btn.addEventListener('click', handleSaveChanges));
        }
        
        function handleEditEmail(e) {
            const item = e.target.closest('[data-email-id]');
            const id = item.dataset.emailId;
            item.querySelector(`#view-${id}`).classList.add('hidden');
            item.querySelector(`#edit-${id}`).classList.remove('hidden');
        }

        function handleCancelEdit(e) {
            const item = e.target.closest('[data-email-id]');
            const id = item.dataset.emailId;
            item.querySelector(`#view-${id}`).classList.remove('hidden');
            item.querySelector(`#edit-${id}`).classList.add('hidden');
        }

        async function handleSaveChanges(e) {
            const button = e.target;
            const item = button.closest('[data-email-id]');
            const id = item.dataset.emailId;
            const editContainer = item.querySelector(`#edit-${id}`);
            
            const newSubject = editContainer.children[0].value;
            const newCategory = editContainer.children[1].value.trim();
            const newBody = editContainer.children[2].value;

            button.textContent = 'Saving...';
            button.disabled = true;

            const { error: updateEmailError } = await db.from('saved_emails')
                .update({ subject: newSubject, body: newBody, category: newCategory || null })
                .eq('id', id);

            if (updateEmailError) {
                console.error("Error updating email:", updateEmailError.message);
                showModal('Error', 'Could not save changes. Please try again.');
                button.textContent = 'Save Changes';
                button.disabled = false;
            } else {
                // Refresh the list to show changes
                showSavedEmails();
            }
        }
        
        function handleDeleteEmail(e) {
            const button = e.target;
            const item = button.closest('[data-email-id]');
            const id = item.dataset.emailId;

            showModal('Confirm Deletion', 'Are you sure you want to delete this saved email?', [
                {
                    text: 'Yes, Delete',
                    class: 'bg-red-600',
                    action: async () => {
                        const { error: deleteEmailError } = await db.from('saved_emails').delete().eq('id', id);
                        if (deleteEmailError) {
                             hideModal();
                             showModal('Error', 'Could not delete the email. Please try again.');
                             console.error("Error deleting email:", deleteEmailError.message);
                        } else {
                            item.style.opacity = '0';
                            setTimeout(() => item.remove(), 300);
                            hideModal();
                        }
                    }
                },
                {
                    text: 'Cancel',
                    class: 'bg-gray-300 text-gray-800',
                    action: hideModal
                }
            ]);
        }

        async function draftFollowUpEmail() {
            const emailContainer = document.getElementById('email-draft-container');
            const emailLoading = document.getElementById('email-draft-loading');
            const emailContent = document.getElementById('email-draft-content');
            
            emailContainer.classList.remove('hidden');
            emailContent.classList.add('hidden');
            emailLoading.classList.remove('hidden');
            emailLoading.classList.add('flex');
            emailLoading.classList.remove('hidden');

            const conversationHistory = sessionInteractions.map(interaction => 
                `Customer: "${interaction.customerSays}"\nAgent: "${interaction.userResponse}"`
            ).join('\n\n');

            const prompt = `You are a professional and empathetic customer support agent for Kindly! named Alex. Based on the following scenario and conversation, write a concise follow-up email to the customer. The email should confirm the resolution and reinforce a positive relationship.
            
            **Scenario Title:** ${currentScenario.title}
            **Customer Persona (for context on their tone and name):** ${currentScenario.persona}
            
            **Conversation History:**
            ${conversationHistory}
            
            **Instructions for the email body:**
            1.  **Structure:** Organize the email into clear, well-spaced paragraphs.
            2.  **Tone:** The conversation ended positively, so the tone should be friendly and reassuring.
            3.  **Standard Opening:** Start the email with "Hi [Customer Name]," (extract their name from the persona, e.g., "Hi Mark,"), followed by a new paragraph: "Thank you for reaching out to Kindly! Support. My name is Alex."
            4.  **Content:** Briefly recap the positive resolution and express happiness that the issue is solved.
            5.  **Standard Closing:** End the email with the following lines, each on a new line: "Please let us know if you have any further questions; we would be happy to assist you.", "Thank you for contacting us!", "Kindly! Support Team".
            
            Return the email as a JSON object with "subject" and "body" keys. The body should be plain text, well-formatted with line breaks for paragraphs.`;
            
            const schema = { 
                type: "OBJECT", 
                properties: { 
                    "subject": { "type": "STRING" }, 
                    "body": { "type": "STRING" } 
                }, 
                required: ["subject", "body"] 
            };

            const result = await getFromAI(prompt, schema);

            emailLoading.classList.add('hidden');
            emailLoading.classList.remove('flex');
            emailContent.classList.remove('hidden');

            if (result && result.subject && result.body) {
                document.getElementById('email-subject').value = result.subject;
                document.getElementById('email-body').value = result.body;
            } else {
                document.getElementById('email-subject').value = "Error";
                document.getElementById('email-body').value = "Could not generate an email draft. Please try again.";
            }
        }

        function copyEmailToClipboard() {
            const subject = document.getElementById('email-subject').value;
            const body = document.getElementById('email-body').value;
            const fullEmailText = `Subject: ${subject}\n\n${body}`;
            const copyBtn = document.getElementById('copy-email-btn');
            
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = fullEmailText;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            tempTextArea.setSelectionRange(0, 99999);

            try {
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
            } catch (err) {
                console.error('Oops, unable to copy', err);
                copyBtn.textContent = 'Error!';
                 setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
            }

            document.body.removeChild(tempTextArea);
        }

        // --- NEW WEEKLY CHALLENGE FUNCTIONS ---
        async function showWeeklyChallenge() {
            showView('weeklyChallenge');
            const scenarioContainer = document.getElementById('weekly-scenario-container');
            const leaderboardContainer = document.getElementById('weekly-leaderboard-container');
            scenarioContainer.innerHTML = '<div class="loader mx-auto"></div>';
            leaderboardContainer.innerHTML = '<div class="loader mx-auto"></div>';

            const { data: challenge, error: challengeError } = await db.from('weekly_challenges').select('*').eq('is_active', true).single();
            
            if (challengeError || !challenge) {
                console.warn("Could not fetch weekly challenge from DB:", challengeError?.message);
                scenarioContainer.innerHTML = '<p class="text-center text-gray-500">No active weekly challenge has been set by an admin yet. Please check back later!</p>';
                leaderboardContainer.innerHTML = '';
                return;
            } 
            
            currentWeeklyChallenge = challenge;
            
            let hasCompleted = false;
            if (userId) {
                const { data: existingSession, error: sessionCheckError } = await db.from('sessions')
                    .select('id')
                    .eq('user_id', userId)
                    .eq('weekly_challenge_id', currentWeeklyChallenge.id)
                    .limit(1);

                if (sessionCheckError) {
                    console.error("Error checking for existing session:", sessionCheckError);
                } else if (existingSession && existingSession.length > 0) {
                    hasCompleted = true;
                }
            }

            const scenario = currentWeeklyChallenge.scenario_data;
            scenarioContainer.innerHTML = `
                <div class="p-4 border rounded-lg bg-gray-50 text-left">
                    <h3 class="text-2xl font-bold text-gray-800">${scenario.title}</h3>
                    <p class="text-sm text-gray-500 my-2 italic">${scenario.persona}</p>
                    <p class="text-gray-700 mb-4">${scenario.description}</p>
                    ${hasCompleted
                        ? `<button class="w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg cursor-not-allowed" disabled>Challenge Already Completed</button>
                           <p class="text-center text-sm text-gray-600 mt-2">You can only complete the weekly challenge once to keep the leaderboard fair.</p>`
                        : `<button id="start-weekly-challenge-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">Start Challenge</button>`
                    }
                </div>
            `;
            
            if (!hasCompleted) {
                document.getElementById('start-weekly-challenge-btn').addEventListener('click', () => {
                    startScenario(currentWeeklyChallenge.scenario_data, currentWeeklyChallenge.id);
                });
            }

            const { data: sessions, error: scoresError } = await db.from('sessions')
                .select('user_id, final_empathy_score, users (email)')
                .eq('weekly_challenge_id', currentWeeklyChallenge.id);

            if (scoresError) {
                console.error("Error fetching leaderboard scores:", scoresError.message);
                leaderboardContainer.innerHTML = '<p class="text-red-500 text-center">Could not load leaderboard data.</p>';
                return;
            }

            const userScores = {};
            sessions.forEach(session => {
                const email = session.users ? session.users.email : `User ${session.user_id.substring(0, 8)}...`;
                if (!userScores[session.user_id] || session.final_empathy_score > userScores[session.user_id].score) {
                    userScores[session.user_id] = {
                        score: session.final_empathy_score,
                        email: email
                    };
                }
            });
            const leaderboard = Object.values(userScores).sort((a, b) => b.score - a.score);

            if (leaderboard.length === 0) {
                leaderboardContainer.innerHTML = '<p class="text-center text-gray-500">No scores have been submitted yet. Be the first!</p>';
            } else {
                leaderboardContainer.innerHTML = `
                    <ol class="space-y-2">
                        ${leaderboard.slice(0, 10).map((entry, index) => `
                            <li class="p-3 rounded-md ${index === 0 ? 'bg-yellow-100 border-yellow-300' : (index === 1 ? 'bg-gray-200 border-gray-300' : (index === 2 ? 'bg-orange-100 border-orange-300' : 'bg-gray-100 border-gray-200'))} border flex justify-between items-center text-left">
                                <span class="font-semibold text-gray-800">${index + 1}. ${entry.email}</span>
                                <span class="font-bold text-lg text-gray-900">${entry.score}</span>
                            </li>
                        `).join('')}
                    </ol>
                `;
            }
        }

        async function showAdminWeeklyChallenge() {
            showView('adminWeeklyChallenge');
            const container = document.getElementById('current-weekly-challenge-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';

            const { data: challenge, error: challengeError } = await db.from('weekly_challenges').select('*').eq('is_active', true).single();

            if (challengeError || !challenge) {
                 container.innerHTML = '<p class="text-gray-500">No weekly challenge is currently active.</p>';
            } else {
                const scenario = challenge.scenario_data;
                container.innerHTML = `
                    <p><strong>Title:</strong> ${scenario.title}</p>
                    <p><strong>Week ID:</strong> ${challenge.week_id}</p>
                    <p><strong>Description:</strong> ${scenario.description}</p>
                `;
            }

            const allChallengesContainer = document.getElementById('all-challenges-list-container');
            allChallengesContainer.innerHTML = '<div class="loader mx-auto"></div>';

            const { data: allChallenges, error: allChallengesError } = await db.from('weekly_challenges')
                .select('*')
                .order('start_date', { ascending: false });
            
            if (allChallengesError) {
                allChallengesContainer.innerHTML = `<p class="text-red-500">Could not load challenge history.</p>`;
                return;
            }

            if (allChallenges.length === 0) {
                allChallengesContainer.innerHTML = `<p class="text-gray-500">No challenges have been created yet.</p>`;
            } else {
                allChallengesContainer.innerHTML = allChallenges.map(challenge => `
                    <div class="p-3 bg-white border rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${challenge.scenario_data.title}</p>
                            <p class="text-sm text-gray-500">Week ID: ${challenge.week_id}</p>
                        </div>
                        <button data-challenge-id="${challenge.id}" data-challenge-title="${challenge.scenario_data.title}" class="view-completion-btn bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-3 rounded-lg">View Completions</button>
                    </div>
                `).join('');
                
                allChallengesContainer.querySelectorAll('.view-completion-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const challengeId = e.currentTarget.dataset.challengeId;
                        const challengeTitle = e.currentTarget.dataset.challengeTitle;
                        showChallengeCompletionDetails(challengeId, challengeTitle);
                    });
                });
            }
            document.getElementById('set-new-challenge-btn').onclick = handleSetNewWeeklyChallenge;
        }

        async function handleSetNewWeeklyChallenge(e) {
            const button = e.target;
            const newScenarioData = {
                id: 'weekly-' + Date.now(),
                title: document.getElementById('new-challenge-title').value.trim(),
                description: document.getElementById('new-challenge-description').value.trim(),
                persona: document.getElementById('new-challenge-persona').value.trim(),
                dialogue_tree: Array.from(document.querySelectorAll('.new-challenge-dialogue')).map(textarea => ({ customer: textarea.value.trim() }))
            };

            if (!newScenarioData.title || !newScenarioData.description || !newScenarioData.persona || newScenarioData.dialogue_tree.some(step => !step.customer)) {
                showModal('Input Required', 'Please fill out all fields for the new challenge.');
                return;
            }

            button.textContent = 'Setting...';
            button.disabled = true;

            const { error: deactivateError } = await db.from('weekly_challenges').update({ is_active: false }).eq('is_active', true);
            if (deactivateError) {
                console.error("Error deactivating old challenge:", deactivateError);
                showModal('Error', `Error: ${deactivateError.message}`);
                button.textContent = 'Save & Set Active';
                button.disabled = false;
                return;
            }
            
            // Robust date calculation
            const today = new Date();
            const year = today.getFullYear();
            const firstDayOfYear = new Date(year, 0, 1);
            const days = Math.floor((today - firstDayOfYear) / (24 * 60 * 60 * 1000));
            const weekNumber = Math.ceil((days + firstDayOfYear.getDay() + 1) / 7);
            const weekId = `${year}-${String(weekNumber).padStart(2, '0')}`;
            
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            const startDate = new Date(today); // Create a copy to avoid mutation
            startDate.setDate(diff);
            startDate.setHours(0, 0, 0, 0);

            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            endDate.setHours(23, 59, 59, 999);
            
            const newChallengePayload = {
                week_id: weekId,
                start_date: startDate.toISOString(),
                end_date: endDate.toISOString(),
                scenario_data: newScenarioData,
                is_active: true
            };

            const { error: insertError } = await db.from('weekly_challenges').upsert(newChallengePayload, { onConflict: 'week_id' });

            if (insertError) {
                console.error("Error setting new challenge:", insertError);
                showModal('Error', `Error: ${insertError.message}`);
                button.textContent = 'Save & Set Active';
                button.disabled = false;
            } else {
                button.textContent = 'Challenge Set!';
                showAdminWeeklyChallenge(); // Refresh the view
                document.getElementById('new-challenge-title').value = '';
                document.getElementById('new-challenge-description').value = '';
                document.getElementById('new-challenge-persona').value = '';
                document.querySelectorAll('.new-challenge-dialogue').forEach(el => el.value = '');
                setTimeout(() => {
                    button.textContent = 'Save & Set Active';
                    button.disabled = false;
                }, 2000);
            }
        }

        async function showChallengeCompletionDetails(challengeId, challengeTitle) {
            showView('adminChallengeCompletion');
            document.getElementById('completion-view-title').textContent = `Completions for: ${challengeTitle}`;
            const container = document.getElementById('completion-list-container');
            container.innerHTML = '<div class="loader mx-auto"></div>';

            const [usersResponse, sessionsResponse] = await Promise.all([
                db.from('users').select('id, email').neq('email', 'admin@kindly.app'),
                db.from('sessions').select('user_id, final_empathy_score').eq('weekly_challenge_id', challengeId)
            ]);

            const { data: allUsers, error: usersError } = usersResponse;
            const { data: completedSessions, error: sessionsError } = sessionsResponse;

            if (usersError || sessionsError) {
                console.error("Error fetching completion data:", usersError || sessionsError);
                container.innerHTML = `<p class="text-red-500">Could not load completion data.</p>`;
                return;
            }

            const userScores = {};
            completedSessions.forEach(session => {
                if (!userScores[session.user_id] || session.final_empathy_score > userScores[session.user_id]) {
                    userScores[session.user_id] = session.final_empathy_score;
                }
            });

            container.innerHTML = allUsers.map(user => {
                const score = userScores[user.id];
                const isCompleted = score !== undefined;

                return `
                    <div class="p-3 bg-gray-50 border rounded-lg flex justify-between items-center">
                        <p class="font-semibold text-gray-800">${user.email}</p>
                        ${isCompleted
                            ? `<span class="font-bold text-green-600">Completed - Score: ${score}</span>`
                            : `<span class="font-semibold text-red-600">Not Completed</span>`
                        }
                    </div>
                `;
            }).join('');
        }

        function setupEventListeners() {
            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    if (action === 'practice') startRandomScenario();
                    else if (action === 'create') showView('createScenario');
                    else if (action === 'history') showHistoryList();
                    else if (action === 'assigned') showAssignedScenarios();
                    else if (action === 'quick-fire') startAIQuickFireRound();
                    else if (action === 'admin-users') showAdminUserList();
                    else if (action === 'admin-assign-scenarios') showAssignScenariosAdminView();
                    else if (action === 'admin-sessions') showAdminSessionList();
                    else if (action === 'admin-weekly-challenge') showAdminWeeklyChallenge();
                    else if (action === 'empathy-help') showView('empathyAssistant');
                    else if (action === 'email-crafter') showView('emailCrafter');
                    else if (action === 'saved-emails') showSavedEmails();
                    else if (action === 'rephrase-tool') showView('rephraseTool');
                    else if (action === 'weekly-challenge') showWeeklyChallenge();
                });
            });
            
            document.querySelectorAll('.back-to-menu-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    clearAllState();
                    showView('mainMenu');
                });
            });
            
            document.querySelectorAll('.back-to-admin-dash-btn').forEach(btn => {
                btn.addEventListener('click', () => showView('adminDashboard'));
            });

            document.getElementById('back-to-weekly-admin-btn').addEventListener('click', showAdminWeeklyChallenge);
            document.getElementById('get-empathy-help-btn').addEventListener('click', getEmpathyHelpFromAI);
            document.getElementById('get-rephrase-tool-suggestions-btn').addEventListener('click', getRephraseSuggestionsFromTool);
            document.getElementById('craft-email-btn').addEventListener('click', craftFollowUpEmailFromTool);
            document.getElementById('recraft-email-btn').addEventListener('click', () => {
                document.getElementById('recraft-feedback-container').classList.toggle('hidden');
            });
            document.getElementById('submit-recraft-btn').addEventListener('click', recraftEmail);
            document.getElementById('save-email-btn').addEventListener('click', saveCraftedEmail);
            document.getElementById('draft-email-btn').addEventListener('click', draftFollowUpEmail);
            document.getElementById('copy-email-btn').addEventListener('click', copyEmailToClipboard);
            document.getElementById('admin-dashboard-btn').addEventListener('click', () => showView('adminDashboard'));
            document.getElementById('back-to-history-list-btn').addEventListener('click', showHistoryList);
            document.getElementById('restart-scenario-btn').addEventListener('click', () => startScenario(currentScenario));
            document.getElementById('choose-another-scenario-btn').addEventListener('click', startRandomScenario);
            document.getElementById('submit-response-btn').addEventListener('click', handleSubmitResponse);
            document.getElementById('next-btn').addEventListener('click', loadStep);
            document.getElementById('analyze-tone-btn').addEventListener('click', getToneAnalysisFromAI);
            document.getElementById('get-suggestions-btn').addEventListener('click', getSuggestionsFromAI);
            document.getElementById('user-response').addEventListener('input', saveSessionState);
            
            document.getElementById('situation-description').addEventListener('input', () => saveCurrentViewState('empathyAssistant'));
            document.getElementById('customer-email-input').addEventListener('input', () => saveCurrentViewState('emailCrafter'));
            document.getElementById('resolution-input').addEventListener('input', () => saveCurrentViewState('emailCrafter'));
            document.getElementById('alternatives-input').addEventListener('input', () => saveCurrentViewState('emailCrafter'));
            document.getElementById('scenario-topic').addEventListener('input', () => saveCurrentViewState('createScenario'));
            document.getElementById('rephrase-customer-statement').addEventListener('input', () => saveCurrentViewState('rephraseTool'));
            document.getElementById('rephrase-agent-draft').addEventListener('input', () => saveCurrentViewState('rephraseTool'));


            document.getElementById('generate-scenario-btn').addEventListener('click', async () => {
                const topic = document.getElementById('scenario-topic').value.trim();
                if (!topic) return;
                const prompt = `Generate a new customer service empathy training scenario for Kindly! based on the topic: "${topic}". The output must be a valid JSON object with: "title", "description", "persona", and a 3-step "dialogue_tree" where the last step is a happy resolution.`;
                const schema = { type: "OBJECT", properties: { "title": { "type": "STRING" }, "description": { "type": "STRING" }, "persona": { "type": "STRING" }, "dialogue_tree": { "type": "ARRAY", "items": { "type": "OBJECT", "properties": { "customer": { "type": "STRING" } } } } }, required: ["title", "description", "persona", "dialogue_tree"] };
                const newScenario = await getFromAI(prompt, schema);
                const generateBtn = document.getElementById('generate-scenario-btn');
                const originalText = generateBtn.textContent;
                if (newScenario && newScenario.dialogue_tree.length >= 3) {
                    const { error: saveScenarioError } = await db.from('scenarios').insert({ ...newScenario, author_id: userId });
                    if (saveScenarioError) {
                        console.error("Error saving new scenario:", saveScenarioError.message);
                        generateBtn.textContent = 'Save Failed!';
                        setTimeout(() => { generateBtn.textContent = originalText; }, 2000);
                    } else {
                        generateBtn.textContent = 'Saved!';
                        setTimeout(() => { generateBtn.textContent = originalText; showView('mainMenu'); }, 1500);
                    }
                } else {
                    generateBtn.textContent = 'Generation Failed!';
                    setTimeout(() => { generateBtn.textContent = originalText; }, 2000);
                }
            });
        }

        // --- AUTHENTICATION ---
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');

        document.getElementById('show-register').addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authError.textContent = '';
            authError.className = 'text-red-500 text-center mt-4';
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            authError.textContent = '';
            authError.className = 'text-red-500 text-center mt-4';
            document.getElementById('register-inputs').classList.remove('hidden');
            document.getElementById('register-success').classList.add('hidden');
        });

        document.getElementById('register-btn').addEventListener('click', async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            authError.textContent = '';
            authError.className = 'text-red-500 text-center mt-4';
            const { data, error: signUpError } = await db.auth.signUp({ email, password });
            if (signUpError) {
                authError.textContent = signUpError.message;
                authError.className = 'text-red-700 text-center mt-4 p-3 bg-red-100 border border-red-300 rounded-lg';
            } else {
                const { error: insertError } = await db.from('users').insert({ id: data.user.id, email: data.user.email });
                if (insertError) console.error("Error creating public user record:", insertError.message);
                
                document.getElementById('register-inputs').classList.add('hidden');
                document.getElementById('register-success').classList.remove('hidden');
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const loginBtn = document.getElementById('login-btn');
            const originalBtnText = loginBtn.textContent;
            loginBtn.textContent = 'Logging in...';
            loginBtn.disabled = true;

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            authError.className = 'text-red-500 text-center mt-4';
            
            const { error: signInError } = await db.auth.signInWithPassword({ email, password });
            
            if (signInError) {
                authError.textContent = signInError.message;
                authError.className = 'text-red-700 text-center mt-4 p-3 bg-red-100 border border-red-300 rounded-lg';
                loginBtn.textContent = originalBtnText;
                loginBtn.disabled = false;
            }
            // On success, onAuthStateChange will handle the UI update.
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            clearAllState(); // Clear session storage immediately for a faster UI response
            const { error: signOutError } = await db.auth.signOut();
            if (signOutError) {
                console.error('Error signing out:', signOutError);
                showModal('Logout Error', 'Could not log you out. Please try again.');
            }
            // onAuthStateChange will also fire to confirm and finalize the logged-out state.
        });

        // **** START FIX ****
        // This function handles all authentication state changes, both on initial load and during the session.
        async function handleAuthStateChange(event, session) {
            const loginBtn = document.getElementById('login-btn');
            const appLoader = document.getElementById('app-loader');
            const appContent = document.getElementById('app-content');

            try {
                if (session && session.user) { // User is logged in or just logged in
                    const isNewLogin = !userId; // Check if this is the first time we're seeing a user

                    if (isNewLogin) {
                        userId = session.user.id;

                        const { data: userData, error: profileError } = await db.from('users')
                            .select('role')
                            .eq('id', userId)
                            .single();
                        
                        if (profileError && profileError.code !== 'PGRST116') {
                            console.error("Error fetching user profile, logging out:", profileError);
                            await db.auth.signOut();
                            return; // Let the subsequent SIGNED_OUT event handle the UI
                        }
                        
                        isAdmin = (userData && userData.role === 'admin') || session.user.email === 'admin@kindly.app';

                        document.getElementById('logged-out-header').classList.add('hidden');
                        const loggedInHeader = document.getElementById('logged-in-header');
                        loggedInHeader.classList.remove('hidden');
                        loggedInHeader.querySelector('#welcome-message').textContent = `Welcome, ${session.user.email}`;
                        document.getElementById('admin-dashboard-btn').classList.toggle('hidden', !isAdmin);
                        
                        if (event === 'INITIAL_SESSION') {
                            if (!loadSessionState() && !loadLastViewState()) {
                                showView('mainMenu');
                            }
                        } else {
                            clearAllState(); 
                            showView('mainMenu');
                        }
                    }

                    if(loginBtn) {
                        loginBtn.textContent = 'Login';
                        loginBtn.disabled = false;
                    }

                } else { // User is logged out
                    userId = null;
                    isAdmin = false;
                    clearAllState();

                    document.getElementById('logged-in-header').classList.add('hidden');
                    document.getElementById('logged-out-header').classList.remove('hidden');
                    document.getElementById('admin-dashboard-btn').classList.add('hidden');
                    
                    showView('auth');

                    if(loginBtn) {
                        loginBtn.textContent = 'Login';
                        loginBtn.disabled = false;
                    }
                }
            } finally {
                if (!authReady) {
                    authReady = true;
                    appLoader.classList.add('hidden');
                    appContent.classList.remove('hidden');
                }
            }
        }

        // Main app initialization function.
        async function initializeApp() {
            // This listener will handle dynamic changes AFTER initial load (e.g., login, logout).
            db.auth.onAuthStateChange(handleAuthStateChange);

            // Actively check the session on startup to prevent getting stuck.
            const { data: { session }, error } = await db.auth.getSession();

            if (error) {
                console.error("Error during initial session fetch:", error);
            }
            
            // `session` will be null if the refresh token was invalid.
            // We call the handler directly to ensure the UI updates immediately.
            handleAuthStateChange('INITIAL_SESSION', session);
        }

        initializeApp();
        // **** END FIX ****

        setupEventListeners();
    </script>
</body>
</html>

