<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Performance Review Tool</title>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF and Autotable for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .app-container {
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-400 */
        }
        /* Spinner animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0ea5e9; /* sky-500 */
            animation: spin 1s linear infinite;
        }
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fade-in-up { animation: fade-in-up 0.2s ease-out forwards; }
    </style>
</head>
<body class="antialiased">
    <div id="app">
        <!-- Main application will be rendered here -->
    </div>

    <script type="module">
        // --- LIVE SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://hsvpxlbesgcmtutansaw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhzdnB4bGJlc2djbXR1dGFuc2F3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMjg4NjQsImV4cCI6MjA3MzgwNDg2NH0.P0N-pPIcj_29FmhUmzBRGJCJz_mmEBrlXupTRlbl02Q';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


        // --- APPLICATION STATE ---
        const AppState = {
            currentUser: null,
            userProfile: null,
            currentPhase: 1,
            users: [],
            reviews: [],
        };

        // --- UI COMPONENTS & RENDERING ---
        const $app = document.getElementById('app');

        const renderSpinner = () => `
            <div class="fixed inset-0 bg-white/70 flex items-center justify-center z-50">
                <div class="spinner"></div>
            </div>
        `;
        
        const renderToast = (message, type = 'success') => {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            toast.className = `fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-xl transform translate-x-full animate-slide-in-out z-[60]`; // Increased z-index
            toast.innerHTML = `<style>
                @keyframes slide-in-out {
                    0% { transform: translateX(100%); opacity: 0; }
                    15% { transform: translateX(0); opacity: 1; }
                    85% { transform: translateX(0); opacity: 1; }
                    100% { transform: translateX(100%); opacity: 0; }
                }
                .animate-slide-in-out { animation: slide-in-out 4s ease-in-out forwards; }
            </style>${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        };

        const renderModal = (title, message, confirmText = 'Confirm', cancelText = 'Cancel', contentHTML = '') => {
            return new Promise((resolve) => {
                const modalId = `modal-${Date.now()}`;
                const modalHTML = `
                    <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full animate-fade-in-up">
                            <div class="p-6">
                                <h3 class="text-lg font-semibold text-slate-800">${title}</h3>
                                <p class="mt-2 text-sm text-slate-600">${message}</p>
                                <div class="mt-4">${contentHTML}</div>
                            </div>
                            <div class="bg-slate-50 px-6 py-3 flex justify-end space-x-3 rounded-b-lg">
                                <button id="${modalId}-cancel" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">${cancelText}</button>
                                <button id="${modalId}-confirm" class="bg-sky-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">${confirmText}</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);

                const modalElement = document.getElementById(modalId);
                const confirmBtn = document.getElementById(`${modalId}-confirm`);
                const cancelBtn = document.getElementById(`${modalId}-cancel`);
                
                const closeModal = (result) => {
                    let resolvedValue;
                    if (result === false) {
                        resolvedValue = false; // User cancelled
                    } else if (contentHTML) {
                        // User confirmed, and there was content
                        const inputElement = modalElement.querySelector('select, input, textarea');
                        resolvedValue = inputElement ? inputElement.value : true; // Get value, or default to true
                    } else {
                        // User confirmed, no content
                        resolvedValue = true;
                    }
                   
                    modalElement.remove();
                    window.removeEventListener('keydown', handleKeyDown); // Clean up listener
                    resolve(resolvedValue);
                };

                confirmBtn.onclick = () => closeModal(true); // Pass true for confirm
                cancelBtn.onclick = () => closeModal(false); // Pass false for cancel

                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        closeModal(false);
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
            });
        };
        
        function renderFullReviewModal(userName, contentHTML) {
            const modalId = `modal-full-review-${Date.now()}`;
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[51] p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full animate-fade-in-up flex flex-col" style="max-height: 90vh;">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold text-slate-800">All Submitted Reviews for ${userName}</h3>
                        </div>
                        <div class="p-6 overflow-y-auto">
                            ${contentHTML}
                        </div>
                        <div class="bg-slate-50 px-6 py-3 flex justify-end rounded-b-lg">
                            <button id="${modalId}-close" class="bg-sky-600 text-white py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium hover:bg-sky-700">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modalElement = document.getElementById(modalId);
            const closeBtn = document.getElementById(`${modalId}-close`);
            closeBtn.onclick = () => modalElement.remove();
        }

        const renderHeader = () => {
            if (!AppState.userProfile) return '';
            const fullName = AppState.userProfile.email.split('@')[0]; // Simple name from email
            // Use role.replace('_', ' ') to make it user-friendly
            const userRole = AppState.userProfile.role.replace('_', ' ');
            return `
                <header class="bg-white shadow-sm">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center h-16">
                            <div class="flex items-center space-x-2">
                                <svg class="h-8 w-8 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" /></svg>
                                <h1 class="text-xl font-bold text-slate-800">Tempo Performance Review</h1>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-slate-600">
                                    Welcome, <strong class="font-semibold capitalize">${fullName}</strong> (${userRole})
                                </span>
                                <button id="logout-btn" class="text-sm font-medium text-sky-600 hover:text-sky-800 transition">Logout</button>
                            </div>
                        </div>
                    </div>
                </header>
            `;
        };

        const renderLogin = () => {
            $app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-slate-50">
                    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
                        <div class="flex items-center justify-center space-x-2 mb-6">
                            <svg class="h-10 w-10 text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.s 0 00-3 0m-9.75 0h9.75" /></svg>
                            <h2 class="text-2xl font-bold text-slate-800">Performance Review Login</h2>
                        </div>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="email" class="block text-sm font-medium text-slate-700">Email Address</label>
                                <input type="email" id="email" name="email" value="ops@tempo.fit" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-sm font-medium text-slate-700">Password</label>
                                <input type="password" id="password" name="password" value="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                            </div>
                            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">
                                Sign In
                            </button>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById('login-form').addEventListener('submit', handleLogin);
        };
        
        const renderDashboard = async () => {
            $app.innerHTML = renderSpinner();
            await fetchData();
            const role = AppState.userProfile.role;
            let dashboardContent = '';

            const phaseNames = ["", "Self & Upward Reviews", "Downward Reviews", "Collaboration & Scoring", "Release"];
            
            const phaseBanner = `
                <div class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-4 rounded-r-lg mb-6">
                    <p class="font-bold">Current Phase: ${phaseNames[AppState.currentPhase]}</p>
                    <p class="text-sm">The review cycle is currently in Phase ${AppState.currentPhase}.</p>
                </div>
            `;

            switch(role) {
                case 'admin': dashboardContent = await renderAdminDashboard(); break;
                case 'ops_manager': dashboardContent = await renderOpsManagerDashboard(); break;
                case 'manager': dashboardContent = await renderManagerDashboard(); break;
                case 'qacoach': dashboardContent = await renderQACoachDashboard(); break;
                case 'agent': dashboardContent = await renderAgentDashboard(); break;
                default: dashboardContent = `<p>Invalid role: ${role}</p>`
            }
            
            $app.innerHTML = `
                ${renderHeader()}
                <main class="py-10">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        ${phaseBanner}
                        ${dashboardContent}
                    </div>
                </main>
            `;
            
            attachDashboardListeners();
        };

        const renderAdminDashboard = () => {
            return `
                <h2 class="text-2xl font-semibold text-slate-900 mb-4">Admin Dashboard</h2>
                 <div id="admin-tabs">
                     <div class="border-b border-slate-200">
                         <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                             <button data-tab="phase" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-sky-500 text-sky-600">Phase Control</button>
                             <button data-tab="status" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">${AppState.currentPhase === 3 ? 'Score Collaboration' : 'Review Status'}</button>
                             <button data-tab="scores" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">Scores Overview</button>
                             <button data-tab="analytics" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">Analytics</button>
                             <button data-tab="export" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300">Data Export</button>
                         </nav>
                     </div>
                     <div class="py-6">
                         <div id="admin-tab-content-phase">${renderAdminPhaseControl()}</div>
                         <div id="admin-tab-content-status" class="hidden">${AppState.currentPhase === 3 ? renderAdminScoreCollaboration() : renderAdminStatusView()}</div>
                         <div id="admin-tab-content-scores" class="hidden">${renderAdminScoresOverview()}</div>
                         <div id="admin-tab-content-analytics" class="hidden">${renderAdminAnalytics()}</div>
                         <div id="admin-tab-content-export" class="hidden">${renderAdminExport()}</div>
                     </div>
                 </div>
            `;
        };
        
        const renderAdminPhaseControl = () => {
            const phaseNames = ["", "Self & Upward", "Downward", "Collaboration", "Release"];
            return `
                <div class="bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">Manage Review Phase</h3>
                     <div class="flex items-center space-x-4">
                         ${[1, 2, 3, 4].map(p => `
                             <div class="flex items-center">
                                 <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold ${AppState.currentPhase >= p ? 'bg-sky-600 text-white' : 'bg-slate-200 text-slate-500'}">
                                     ${p}
                                 </div>
                                 ${ p < 4 ? `<div class="w-16 h-1 ${AppState.currentPhase > p ? 'bg-sky-500' : 'bg-slate-200'}"></div>` : ''}
                             </div>
                         `).join('')}
                     </div>
                     <p class="mt-4 text-sm text-slate-600">Current Phase: <strong>${phaseNames[AppState.currentPhase]}</strong></p>
                     <div class="mt-6">
                         ${AppState.currentPhase < 4 
                             ? `<button id="next-phase-btn" data-next-phase="${AppState.currentPhase + 1}" class="bg-sky-600 text-white px-4 py-2 rounded-md hover:bg-sky-700 transition">Move to Phase ${AppState.currentPhase + 1}</button>`
                             : `<p class="font-semibold text-green-600">Review cycle is complete.</p>`
                         }
                     </div>
                </div>
            `;
        };

        const renderAdminStatusView = () => {
            const managers = AppState.users.filter(u => u.role === 'manager' || u.role === 'ops_manager');
            return `
                 <div class="bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">Review Completion Status (Phase ${AppState.currentPhase})</h3>
                     <div class="mb-4">
                         <label for="manager-filter" class="block text-sm font-medium text-slate-700">Filter by Manager</label>
                         <select id="manager-filter" class="mt-1 block w-full md:w-1/3 pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
                             <option value="all">All Managers</option>
                             ${managers.map(m => `<option value="${m.id}">${m.email}</option>`).join('')}
                         </select>
                     </div>
                     <div class="overflow-x-auto">
                         <table class="min-w-full divide-y divide-slate-200" id="status-table">
                             <thead class="bg-slate-50">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Employee</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Role</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Review Tasks & Status</th>
                                 </tr>
                             </thead>
                             <tbody class="bg-white divide-y divide-slate-200"></tbody>
                         </table>
                     </div>
                 </div>
            `;
        };
        
        const renderAdminScoreCollaboration = () => {
            const managers = AppState.users.filter(u => u.role === 'manager' || u.role === 'ops_manager');
            return `
                 <div class="bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">Score Collaboration & Adjustment</h3>
                     <div class="mb-4">
                         <label for="manager-filter" class="block text-sm font-medium text-slate-700">Filter by Manager</label>
                         <select id="manager-filter" class="mt-1 block w-full md:w-1/3 pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
                             <option value="all">All Managers</option>
                             ${managers.map(m => `<option value="${m.id}">${m.email}</option>`).join('')}
                         </select>
                     </div>
                     <div class="overflow-x-auto">
                         <table class="min-w-full divide-y divide-slate-200" id="score-table">
                             <thead class="bg-slate-50">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Employee</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Scored By</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Current Score</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Actions</th>
                                 </tr>
                             </thead>
                             <tbody class="bg-white divide-y divide-slate-200"></tbody>
                         </table>
                     </div>
                 </div>
            `;
        };

        const renderAdminScoresOverview = () => {
            const roles = [...new Set(AppState.users.map(u => u.role))].filter(r => r !== 'admin').sort();
            return `
                <div class="bg-white p-6 rounded-lg shadow">
                     <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">All Performance Scores</h3>
                     <div class="mb-4">
                         <label for="role-filter" class="block text-sm font-medium text-slate-700">Filter by Role</label>
                         <select id="role-filter" class="mt-1 block w-full md:w-1/3 pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
                             <option value="all">All Roles</option>
                             ${roles.map(r => `<option value="${r}" class="capitalize">${r.replace('_', ' ')}</option>`).join('')}
                         </select>
                     </div>
                     <div class="overflow-x-auto">
                         <table class="min-w-full divide-y divide-slate-200" id="scores-overview-table">
                             <thead class="bg-slate-50">
                                 <tr>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Employee</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Role</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Scored By</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Score</th>
                                 </tr>
                             </thead>
                             <tbody class="bg-white divide-y divide-slate-200"></tbody>
                         </table>
                     </div>
                </div>
            `;
        };

        const renderAdminAnalytics = () => {
             const managers = AppState.users.filter(u => u.role === 'manager' || u.role === 'ops_manager');
             const roles = [...new Set(AppState.users.map(u => u.role))].filter(r => r !== 'admin').sort();
             return `
                 <div>
                      <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mb-6">
                         <!-- Filter by Team -->
                         <div class="flex-1">
                             <label for="analytics-manager-filter" class="block text-sm font-medium text-slate-700">Filter by Team</label>
                             <select id="analytics-manager-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
                                 <option value="all">All Teams</option>
                                 ${managers.map(m => `<option value="${m.id}">${m.email}</option>`).join('')}
                             </select>
                         </div>
                         <!-- Filter by Role -->
                         <div class="flex-1">
                             <label for="analytics-role-filter" class="block text-sm font-medium text-slate-700">Filter by Role</label>
                             <select id="analytics-role-filter" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm rounded-md">
                                 <option value="all">All Roles</option>
                                 ${roles.map(r => `<option value="${r}" class="capitalize">${r.replace('_', ' ')}</option>`).join('')}
                             </select>
                         </div>
                      </div>

                     <!-- Stat Cards -->
                     <div id="stat-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6"></div>

                     <!-- Charts -->
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                         <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                              <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">Average Score by Team</h3>
                             <div class="h-80"><canvas id="team-score-chart"></canvas></div>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow">
                              <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">Score Distribution by Role</h3>
                             <div class="h-80"><canvas id="score-by-role-chart"></canvas></div>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow">
                              <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">Promotion Recommendations</h3>
                             <div class="h-80"><canvas id="promotion-chart"></canvas></div>
                         </div>
                         <div class="bg-white p-6 rounded-lg shadow">
                              <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">Attrition Risk</h3>
                             <div class="h-80"><canvas id="attrition-chart"></canvas></div>
                         </div>
                     </div>
                 </div>
            `;
        };

        const renderAdminExport = () => {
             return `
                 <div class="bg-white p-6 rounded-lg shadow">
                      <h3 class="text-lg font-medium leading-6 text-slate-900 mb-4">Export Full Report</h3>
                      <p class="text-sm text-slate-600 mb-4">Download a complete report of all performance reviews, including all comments and scores.</p>
                      <div class="flex space-x-4">
                         <button id="export-csv-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition">Export as CSV</button>
                         <button id="export-pdf-btn" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition">Export as PDF</button>
                      </div>
                 </div>
            `;
        };

        const renderAgentDashboard = () => {
            let content = '';
            if (AppState.currentPhase === 4) {
                 const selfReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'self');
                 const downwardManagerReview = AppState.reviews.find(r => r.reviewee_id === AppState.currentUser.id && r.review_type === 'downward_manager' && r.submitted_at);
                 const downwardQAReview = AppState.reviews.find(r => r.reviewee_id === AppState.currentUser.id && r.review_type === 'downward_qa' && r.submitted_at);
                 const manager = AppState.users.find(u => u.id === AppState.userProfile.manager_id);
                 const qaCoach = AppState.users.find(u => u.id === AppState.userProfile.qa_coach_id);

                content = `
                      <h3 class="text-xl font-semibold text-slate-800 mb-4">Released Reviews</h3>
                      <div class="space-y-6">
                           ${renderReleasedReview('My Self-Review', selfReview)}
                           ${renderReleasedReview(`Manager Review: ${manager?.email || 'N/A'}`, downwardManagerReview)}
                           ${renderReleasedReview(`QA Coach Review: ${qaCoach?.email || 'N/A'}`, downwardQAReview)}
                      </div>
                `;
            } else {
                const selfReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'self');
                const manager = AppState.users.find(u => u.id === AppState.userProfile.manager_id);
                const qaCoach = AppState.users.find(u => u.id === AppState.userProfile.qa_coach_id);
                const upwardManagerReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'upward_manager');
                const upwardQAReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'upward_qa');

                if (AppState.currentPhase === 1) {
                    content = `
                        <div class="space-y-4">
                            ${renderReviewCard('My Self-Review', 'Complete your personal performance review.', 'self', AppState.currentUser.id, selfReview)}
                            ${manager ? renderReviewCard(`Upward Review: ${manager.email}`, 'Provide feedback for your manager.', 'upward_manager', manager.id, upwardManagerReview) : ''}
                            ${qaCoach ? renderReviewCard(`Upward Review: ${qaCoach.email}`, 'Provide feedback for your QA coach.', 'upward_qa', qaCoach.id, upwardQAReview) : ''}
                        </div>
                    `;
                } else {
                     content = `<p class="text-slate-600">Please wait for the next phase to begin.</p>`;
                }
            }
            return `
                <h2 class="text-2xl font-semibold text-slate-900 mb-4">Agent Dashboard</h2>
                ${content}
            `;
        };
        
        const renderManagerDashboard = () => {
            let content = '';
             if (AppState.currentPhase === 4) {
                 const selfReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'self' && r.submitted_at);
                 const downwardOpsReview = AppState.reviews.find(r => r.reviewee_id === AppState.currentUser.id && r.review_type === 'downward_ops' && r.submitted_at);
                 const upwardReviews = AppState.reviews.filter(r => r.reviewee_id === AppState.currentUser.id && r.review_type === 'upward_manager' && r.submitted_at);
                 const opsManager = AppState.users.find(u => u.id === AppState.userProfile.manager_id);

                content = `
                    <div class="space-y-6">
                        <h3 class="text-xl font-semibold text-slate-800">Your Reviews</h3>
                        ${renderReleasedReview('My Self-Review', selfReview)}
                        ${renderReleasedReview(`Review from your Manager: ${opsManager?.email || 'N/A'}`, downwardOpsReview)}
                        
                        <h3 class="text-xl font-semibold text-slate-800 pt-4 border-t">Anonymous Upward Feedback</h3>
                        ${upwardReviews.length > 0 ? upwardReviews.map((review, index) => renderReleasedReview(`Feedback from Team Member ${index + 1}`, review)).join('') : '<div class="bg-white rounded-lg shadow p-6"><p class="text-slate-500">No upward feedback was submitted for you in this cycle.</p></div>'}
                    </div>
                `;
            } else {
                const selfReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'self');
                const assignedAgents = AppState.users.filter(u => u.manager_id === AppState.currentUser.id);
                const opsManager = AppState.users.find(u => u.id === AppState.userProfile.manager_id);
                const upwardOpsReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'upward_ops');

                if (AppState.currentPhase === 1) {
                    content = `
                        <div class="space-y-4">
                            ${renderReviewCard('My Self-Review', 'Complete your personal performance review.', 'self', AppState.currentUser.id, selfReview)}
                            ${opsManager ? renderReviewCard(`Upward Review: ${opsManager.email}`, 'Provide feedback for your Manager.', 'upward_ops', opsManager.id, upwardOpsReview) : ''}
                        </div>
                    `;
                } else if (AppState.currentPhase === 2) {
                    content = `
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Downward Reviews</h3>
                        <div class="space-y-4">
                            ${assignedAgents.map(agent => {
                                const review = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.reviewee_id === agent.id && r.review_type === 'downward_manager');
                                return renderReviewCard(`Downward Review: ${agent.email}`, 'Provide review for your direct report.', 'downward_manager', agent.id, review);
                            }).join('')}
                        </div>
                    `;
                } else {
                    content = `<p class="text-slate-600">Please wait for the next phase to begin.</p>`;
                }
            }
            return `
                <h2 class="text-2xl font-semibold text-slate-900 mb-4">Manager Dashboard</h2>
                ${content}
            `;
        };

        const renderQACoachDashboard = () => { 
            let content = '';
            if (AppState.currentPhase === 4) {
                 const selfReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'self' && r.submitted_at);
                const downwardOpsReview = AppState.reviews.find(r => r.reviewee_id === AppState.currentUser.id && r.review_type === 'downward_ops' && r.submitted_at);
                const upwardReviews = AppState.reviews.filter(r => r.reviewee_id === AppState.currentUser.id && r.review_type === 'upward_qa' && r.submitted_at);
                const opsManager = AppState.users.find(u => u.id === AppState.userProfile.manager_id);
                content = `
                     <div class="space-y-6">
                         <h3 class="text-xl font-semibold text-slate-800">Your Reviews</h3>
                         ${renderReleasedReview('My Self-Review', selfReview)}
                         ${renderReleasedReview(`Review from your Manager: ${opsManager?.email || 'N/A'}`, downwardOpsReview)}
                        
                         <h3 class="text-xl font-semibold text-slate-800 pt-4 border-t">Anonymous Upward Feedback</h3>
                          ${upwardReviews.length > 0 ? upwardReviews.map((review, index) => renderReleasedReview(`Feedback from Team Member ${index + 1}`, review)).join('') : '<div class="bg-white rounded-lg shadow p-6"><p class="text-slate-500">No upward feedback was submitted for you in this cycle.</p></div>'}
                    </div>
                `;
            } else {
                const selfReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'self');
                const assignedAgents = AppState.users.filter(u => u.qa_coach_id === AppState.currentUser.id);
                const opsManager = AppState.users.find(u => u.id === AppState.userProfile.manager_id);
                const upwardOpsReview = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.review_type === 'upward_ops');

                if (AppState.currentPhase === 1) {
                    content = `
                        <div class="space-y-4">
                            ${renderReviewCard('My Self-Review', 'Complete your personal performance review.', 'self', AppState.currentUser.id, selfReview)}
                            ${opsManager ? renderReviewCard(`Upward Review: ${opsManager.email}`, 'Provide feedback for your Manager.', 'upward_ops', opsManager.id, upwardOpsReview) : ''}
                        </div>
                    `;
                } else if (AppState.currentPhase === 2) {
                    content = `
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Downward Reviews (QA)</h3>
                        <div class="space-y-4">
                            ${assignedAgents.map(agent => {
                                const review = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.reviewee_id === agent.id && r.review_type === 'downward_qa');
                                return renderReviewCard(`QA Downward Review: ${agent.email}`, 'Provide QA review for this agent.', 'downward_qa', agent.id, review);
                            }).join('')}
                        </div>
                    `;
                } else {
                    content = `<p class="text-slate-600">Please wait for the next phase to begin.</p>`;
                }
            }
            return `
                <h2 class="text-2xl font-semibold text-slate-900 mb-4">QA Coach Dashboard</h2>
                ${content}
            `;
        };

        const renderOpsManagerDashboard = () => {
            let content = '';
            const assignedPersonnel = AppState.users.filter(u => u.manager_id === AppState.currentUser.id); 

            if (AppState.currentPhase === 4) {
                 const upwardReviewsForOps = AppState.reviews.filter(r => 
                     r.reviewee_id === AppState.currentUser.id && 
                     r.review_type === 'upward_ops' && 
                     r.submitted_at
                );

                let upwardFeedbackHtml = `
                     <h3 class="text-xl font-semibold text-slate-800">Your Anonymous Upward Feedback</h3>
                     <div class="space-y-6 mt-4">
                         ${upwardReviewsForOps.length > 0 
                             ? upwardReviewsForOps.map((review, index) => renderReleasedReview(`Feedback from Leader ${index + 1}`, review)).join('') 
                             : '<div class="bg-white rounded-lg shadow p-6"><p class="text-slate-500">No upward feedback was submitted for you in this cycle.</p></div>'
                         }
                     </div>
                `;

                let teamViewHtml = `
                     <h3 class="text-xl font-semibold text-slate-800 mt-8 pt-6 border-t">Full Team Review Access</h3>
                     <div class="space-y-6 mt-4">
                         ${assignedPersonnel.map(person => {
                             const agentsOfPerson = AppState.users.filter(agent => 
                                 agent.manager_id === person.id || agent.qa_coach_id === person.id
                             );

                             return `
                                 <div class="bg-white rounded-lg shadow p-6">
                                     <div class="flex justify-between items-center">
                                         <div>
                                             <p class="font-semibold text-slate-800">${person.email}</p>
                                             <p class="text-sm text-slate-500 capitalize">${person.role.replace('_', ' ')}</p>
                                         </div>
                                         <button class="view-full-review-btn bg-sky-100 text-sky-700 hover:bg-sky-200 text-sm font-medium px-4 py-2 rounded-md" data-user-id="${person.id}">View All Reviews</button>
                                     </div>
                                     ${agentsOfPerson.length > 0 ? `
                                     <div class="mt-4 pt-4 border-t border-slate-200 pl-4 space-y-3">
                                         ${agentsOfPerson.map(agent => `
                                             <div class="flex justify-between items-center">
                                                 <div>
                                                     <p class="text-sm text-slate-700">${agent.email}</p>
                                                     <p class="text-xs text-slate-400">Agent</p>
                                                 </div>
                                                 <button class="view-full-review-btn bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs font-medium px-3 py-1 rounded-md" data-user-id="${agent.id}">View All Reviews</button>
                                             </div>
                                         `).join('')}
                                     </div>
                                     ` : ''}
                                 </div>
                             `;
                         }).join('')}
                     </div>
                `;
                content = upwardFeedbackHtml + teamViewHtml;

            } else if (AppState.currentPhase === 2) {
                content = `
                    <h3 class="text-xl font-semibold text-slate-800 mb-4">Downward Reviews for Leaders</h3>
                    <div class="space-y-4">
                        ${assignedPersonnel.map(person => {
                            const review = AppState.reviews.find(r => r.reviewer_id === AppState.currentUser.id && r.reviewee_id === person.id && r.review_type === 'downward_ops');
                            return renderReviewCard(`Downward Review: ${person.email}`, `Provide review for this ${person.role.replace('_', ' ')}.`, 'downward_ops', person.id, review);
                        }).join('')}
                    </div>
                `;
            } else {
                 content = `<p class="text-slate-600">Please wait for the next phase to begin.</p>`;
            }
            
            return `
                 <h2 class="text-2xl font-semibold text-slate-900 mb-4">Manager Dashboard</h2>
                 ${content}
            `;
        };
        
        // --- EVENT HANDLERS & LOGIC ---

        const handleLogin = async (e) => {
            e.preventDefault();
            $app.insertAdjacentHTML('beforeend', renderSpinner());
            const email = e.target.email.value;
            const password = e.target.password.value;

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                renderToast(error.message, 'error');
                const spinner = $app.querySelector('.spinner');
                if (spinner) spinner.parentElement.remove();
            } else {
                AppState.currentUser = data.user;
                await renderDashboard();
            }
        };

        const handleLogout = async () => {
            await supabaseClient.auth.signOut();
            AppState.currentUser = null;
            AppState.userProfile = null;
            renderLogin();
        };

        const checkSession = async () => {
            try {
                $app.innerHTML = renderSpinner();
                const { data } = await supabaseClient.auth.getSession();
                if (data.session && data.session.user) {
                    AppState.currentUser = data.session.user;
                    await renderDashboard();
                } else {
                    renderLogin();
                }
            } catch (error) {
                console.error("Initialization Error:", error);
                renderToast("An error occurred during startup. Please try again.", "error");
                renderLogin(); // Fallback to login screen on any error
            }
        };
        
        const fetchData = async () => {
            if (!AppState.currentUser) return; // Guard clause
            
            const { data: userProfile, error: profileError } = await supabaseClient
                .from('users')
                .select('*')
                .eq('id', AppState.currentUser.id)
                .single();

            if (profileError) {
                renderToast(`Error fetching profile: ${profileError.message}`, 'error');
                handleLogout();
                return;
            }
            AppState.userProfile = userProfile;
            
            const { data: users, error: usersError } = await supabaseClient.from('users').select('*');
            if (usersError) renderToast(`Error fetching users: ${usersError.message}`, 'error');
            else AppState.users = users;
            
            let reviewsQuery = supabaseClient.from('reviews').select('*');
            
            // Role-specific data fetching
            if (AppState.userProfile.role === 'admin') {
                // Admin sees all reviews, so no additional filter is needed on the query.
            } else if (AppState.userProfile.role === 'ops_manager') {
                // Ops Manager needs to see reviews they've written, AND upward reviews for their direct reports.
                const { data: directReports, error: reportsError } = await supabaseClient
                    .from('users')
                    .select('id')
                    .eq('manager_id', AppState.currentUser.id);

                if (reportsError) {
                    renderToast('Could not fetch direct reports for Manager.', 'error');
                } else {
                    const directReportIds = directReports.map(r => r.id);
                    
                    // Also need agents of their direct reports
                    let allTeamIds = [...directReportIds];
                    if (directReportIds.length > 0) {
                        const { data: agentsOfReports, error: agentsError } = await supabaseClient
                            .from('users')
                            .select('id')
                            .or(`manager_id.in.(${directReportIds.join(',')}),qa_coach_id.in.(${directReportIds.join(',')})`);
                        
                        if (agentsError) {
                             renderToast('Could not fetch full team.', 'error');
                        } else {
                            allTeamIds = [...allTeamIds, ...agentsOfReports.map(a => a.id)];
                        }
                    }

                    // We need all reviews WHERE:
                    // 1. The reviewer is the ops_manager OR
                    // 2. The reviewee is the ops_manager OR
                    // 3. The reviewee is one of their direct reports (manager, qacoach) OR
                    // 4. The reviewee is an agent *under* one of their direct reports
                    if (allTeamIds.length > 0) {
                         reviewsQuery = reviewsQuery.or(
                            `reviewer_id.eq.${AppState.currentUser.id},` + // Written by ops
                            `reviewee_id.eq.${AppState.currentUser.id},` + // Written about ops
                            `reviewee_id.in.(${allTeamIds.join(',')})`   // Written about anyone on their team/hierarchy
                        );
                    } else {
                        // Fallback if they have no reports, just fetch their own reviews (written or received)
                        reviewsQuery = reviewsQuery.or(`reviewer_id.eq.${AppState.currentUser.id},reviewee_id.eq.${AppState.currentUser.id}`);
                    }
                }
            } else if (AppState.userProfile.role === 'manager') {
                // Manager needs reviews they wrote, received, AND reviews about their direct reports
                const { data: directReports, error: reportsError } = await supabaseClient
                    .from('users')
                    .select('id')
                    .eq('manager_id', AppState.currentUser.id);
                
                if (reportsError) {
                    renderToast('Could not fetch direct reports.', 'error');
                    reviewsQuery = reviewsQuery.or(`reviewer_id.eq.${AppState.currentUser.id},reviewee_id.eq.${AppState.currentUser.id}`);
                } else {
                    const directReportIds = directReports.map(r => r.id);
                    if (directReportIds.length > 0) {
                        reviewsQuery = reviewsQuery.or(
                            `reviewer_id.eq.${AppState.currentUser.id},` + // Written by manager
                            `reviewee_id.eq.${AppState.currentUser.id},` + // Written about manager (upward)
                            `reviewee_id.in.(${directReportIds.join(',')})` // Written about their agents (self, qa)
                        );
                    } else {
                        // No reports, just fetch their own reviews
                        reviewsQuery = reviewsQuery.or(`reviewer_id.eq.${AppState.currentUser.id},reviewee_id.eq.${AppState.currentUser.id}`);
                    }
                }
            } else {
                // Standard users (Agent, QA Coach) see reviews they wrote or received.
                reviewsQuery = reviewsQuery.or(`reviewer_id.eq.${AppState.currentUser.id},reviewee_id.eq.${AppState.currentUser.id}`);
            }

            const { data: reviews, error: reviewsError } = await reviewsQuery;

            if(reviewsError) renderToast(`Error fetching reviews: ${reviewsError.message}`, 'error');
            else AppState.reviews = reviews || [];
            
            const { data: phases, error: phasesError } = await supabaseClient.from('phases').select('current_phase').eq('id', 'current').single();
            if (phasesError) renderToast(`Error fetching phase: ${phasesError.message}`, 'error');
            else AppState.currentPhase = phases.current_phase;
        };

        // --- Init ---
        // Add a listener for auth changes (like login/logout)
        supabaseClient.auth.onAuthStateChange((event, session) => {
             if (event === 'SIGNED_OUT' || event === 'USER_DELETED') {
                 // Handle logout
                 AppState.currentUser = null;
                 AppState.userProfile = null;
                 renderLogin();
             } else if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                 // Handle login or session refresh
                 if (session && session.user) {
                    AppState.currentUser = session.user;
                    if (!$app.querySelector('main')) { // Only render dash if not already there
                         renderDashboard();
                    }
                 }
             }
        });
        
        // Initial check
        checkSession();
        
        // Helper functions and more complex renderers
        
        function renderReviewCard(title, description, reviewType, revieweeId, review) {
            const isSubmitted = review && review.submitted_at;
            const statusColor = isSubmitted ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
            const statusText = isSubmitted ? 'Completed' : 'Not Started';
            const buttonText = isSubmitted ? 'View Review' : 'Start Review';
            const buttonClass = isSubmitted ? 'bg-slate-500 hover:bg-slate-600' : 'bg-sky-600 hover:bg-sky-700';

            return `
                 <div class="bg-white rounded-lg shadow p-6 flex justify-between items-center">
                     <div>
                         <h4 class="font-semibold text-slate-800">${title}</h4>
                         <p class="text-sm text-slate-500 mt-1">${description}</p>
                     </div>
                     <div class="flex items-center space-x-4">
                         <span class="text-xs font-medium px-2.5 py-0.5 rounded-full ${statusColor}">${statusText}</span>
                         <button class="open-review-form text-white px-4 py-2 rounded-md transition ${buttonClass}" 
                                 data-review-type="${reviewType}" 
                                 data-reviewee-id="${revieweeId}"
                                 data-review-id="${review ? review.id : ''}">
                             ${buttonText}
                         </button>
                     </div>
                 </div>
            `;
        }
 
       function renderReleasedReview(title, review, isModalView = false, showSummarizeButton = true) {
            if (!review) {
                const wrapperClass = isModalView ? 'border border-slate-200 p-4 rounded-lg' : 'bg-white rounded-lg shadow p-6';
                return `
                     <div class="${wrapperClass}">
                         <h4 class="font-semibold text-slate-800">${title}</h4>
                         <p class="mt-2 text-sm text-slate-500">This review has not been submitted or is not available.</p>
                     </div>
                `;
            }
            const questions = getQuestionSet(review.review_type);
            const isAnonymous = review.review_type.startsWith('upward');
            const scoreMap = { 1: "Needs Improvement", 2: "Meeting Expectations", 3: "Exceeding", 4: "Top 10%"};
            const wrapperClass = isModalView ? 'border border-slate-200 p-4 rounded-lg' : 'bg-white rounded-lg shadow p-6';

            // Define sensitive questions that should not be shown to employees in the final view.
            const sensitiveQuestionKeys = ['q7', 'q8', 'q9', 'q10'];
            
            // Determine if the current user should see sensitive info
            // Admins and Ops Managers see everything
            const canSeeSensitive = ['admin', 'ops_manager'].includes(AppState.userProfile.role);

            return `
                <div class="${wrapperClass}">
                    <div class="flex justify-between items-start">
                         <h4 class="font-semibold text-slate-800">${title}</h4>
                         <div class="flex items-center space-x-3">
                             ${review.score ? `<span class="text-sm font-semibold px-3 py-1 rounded-full bg-blue-100 text-blue-800">Score: ${review.score} - ${scoreMap[review.score]}</span>` : ''}
                             ${isAnonymous ? '<span class="text-xs font-medium px-2.5 py-0.5 rounded-full bg-indigo-100 text-indigo-800">Anonymous</span>' : ''}
                         </div>
                    </div>
                    <div class="mt-4 border-t border-slate-200 pt-4 space-y-4">
                        ${Object.entries(questions).map(([key, question]) => {
                            // Hide the score question (as it's shown in the header)
                            if (question.includes('(14 scale)')) return '';
                            // Hide sensitive questions if the user is not privileged
                            if (!canSeeSensitive && sensitiveQuestionKeys.includes(key)) return '';

                            // Special formatting for sensitive questions for those who can see them
                            const isSensitive = sensitiveQuestionKeys.includes(key);
                            const questionClass = isSensitive ? "text-sm font-medium text-red-600" : "text-sm font-medium text-slate-600";
                            const answerBg = isSensitive ? "bg-red-50" : "bg-slate-50";

                            return `
                                 <div>
                                     <p class="${questionClass}">${isSensitive ? '[Sensitive] ' : ''}${question}</p>
                                     <p class="text-sm text-slate-800 ${answerBg} p-2 rounded-md mt-1 whitespace-pre-wrap">${review.questions[key] || '<em>No answer provided.</em>'}</p>
                                 </div>
                            `;
                        }).join('')}
                    </div>
                   ${showSummarizeButton ? `
                       <div class="mt-4 pt-4 border-t border-slate-200">
                           <button class="summarize-btn text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded-md flex items-center space-x-2" data-review-id="${review.id}">
                               <span></span>
                               <span>Summarize Feedback</span>
                           </button>
                       </div>
                   ` : ''}
                </div>
            `;
        }
        
        function attachDashboardListeners() {
            const logoutBtn = document.getElementById('logout-btn');
            if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);

            document.querySelectorAll('.open-review-form').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { reviewType, revieweeId, reviewId } = e.currentTarget.dataset;
                    renderReviewForm(reviewType, revieweeId, reviewId);
                });
            });
            
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.tab;
                    document.querySelectorAll('.admin-tab').forEach(t => {
                        t.classList.remove('border-sky-500', 'text-sky-600');
                        t.classList.add('border-transparent', 'text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
                    });
                    e.currentTarget.classList.add('border-sky-500', 'text-sky-600');
                    e.currentTarget.classList.remove('border-transparent', 'text-slate-500');

                    document.querySelectorAll('[id^="admin-tab-content-"]').forEach(content => content.classList.add('hidden'));
                    document.getElementById(`admin-tab-content-${tabName}`).classList.remove('hidden');

                    if(tabName === 'status') {
                        if (AppState.currentPhase === 3) populateScoreTable();
                        else populateStatusTable();
                    }
                    if(tabName === 'analytics') renderAllAnalytics();
                    if(tabName === 'scores') populateScoresOverviewTable();
                });
            });

            const nextPhaseBtn = document.getElementById('next-phase-btn');
            if (nextPhaseBtn) nextPhaseBtn.addEventListener('click', handlePhaseChange);
            
            const managerFilter = document.getElementById('manager-filter');
            if(managerFilter) managerFilter.addEventListener('change', () => {
                if (AppState.currentPhase === 3) populateScoreTable();
                else populateStatusTable();
            });

            const roleFilter = document.getElementById('role-filter');
            if(roleFilter) roleFilter.addEventListener('change', populateScoresOverviewTable);
            
            const analyticsManagerFilter = document.getElementById('analytics-manager-filter');
            if(analyticsManagerFilter) analyticsManagerFilter.addEventListener('change', () => renderAllAnalytics());

            // Add listener for new role filter
            const analyticsRoleFilter = document.getElementById('analytics-role-filter');
            if(analyticsRoleFilter) analyticsRoleFilter.addEventListener('change', () => renderAllAnalytics());
            
            const exportCsvBtn = document.getElementById('export-csv-btn');
            if (exportCsvBtn) exportCsvBtn.addEventListener('click', handleExportCSV);
            
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            if (exportPdfBtn) exportPdfBtn.addEventListener('click', handleExportPDF);

            // Use event delegation for dynamic buttons
            document.addEventListener('click', e => {
                if (e.target && e.target.closest('.edit-score-btn')) {
                    handleEditScore(e.target.closest('.edit-score-btn'));
                }
                if (e.target && e.target.closest('.summarize-btn')) {
                    handleSummarizeFeedback(e.target.closest('.summarize-btn'));
                }
                if (e.target && e.target.closest('.view-full-review-btn')) {
                    handleViewFullReview(e.target.closest('.view-full-review-btn'));
                }
                // New handler for the calibration context button
                if (e.target && e.target.closest('.view-calibration-context-btn')) {
                    handleViewCalibrationContext(e.target.closest('.view-calibration-context-btn'));
                }
            });
        }
        
        // NEW HELPER FUNCTION to render different form fields
        function renderFormField(key, question, review, isSubmitted) {
            const value = review.questions[key] || '';
            const isDisabled = isSubmitted ? 'disabled' : '';

            if (question.includes('(14 scale)')) {
                // q6
                return `<select id="${key}" name="${key}" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" ${isDisabled}>
                    <option value="" ${!value ? 'selected' : ''}>Select a score</option>
                    <option value="1" ${value == '1' ? 'selected' : ''}>1: Needs Improvement</option>
                    <option value="2" ${value == '2' ? 'selected' : ''}>2: Meeting Expectations</option>
                    <option value="3" ${value == '3' ? 'selected' : ''}>3: Exceeding Expectations</option>
                    <option value="4" ${value == '4' ? 'selected' : ''}>4: Top 10%</option>
                </select>`;
            }

            if (question.includes('attrition risk')) { // q7 in downward reviews
                return `<select id="${key}" name="${key}" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" ${isDisabled}>
                    <option value="" ${!value ? 'selected' : ''}>Select an option</option>
                    <option value="Yes" ${value.toLowerCase() == 'yes' ? 'selected' : ''}>Yes</option>
                    <option value="No" ${value.toLowerCase() == 'no' ? 'selected' : ''}>No</option>
                </select>`;
            }

            if (question.includes('promoted now')) { // q8 in downward reviews
                return `<select id="${key}" name="${key}" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" ${isDisabled}>
                    <option value="" ${!value ? 'selected' : ''}>Select an option</option>
                    <option value="Yes" ${value == 'Yes' ? 'selected' : ''}>Yes</option>
                    <option value="No" ${value == 'No' ? 'selected' : ''}>No</option>
                    <option value="Not Now" ${value == 'Not Now' ? 'selected' : ''}>Not Now</option>
                </select>`;
            }

            // NEW: Add check for leadership/cohesion question
            if (question.includes('managers leadership style') || question.includes('QA Coachs coaching style')) {
                const options = ["Very satisfied", "satisfied", "neutral", "not satisfied", "very dissatisfied"];
                return `<select id="${key}" name="${key}" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" ${isDisabled}>
                    <option value="" ${!value ? 'selected' : ''}>Select an option</option>
                    ${options.map(opt => `<option value="${opt}" ${value.toLowerCase() === opt.toLowerCase() ? 'selected' : ''}>${opt}</option>`).join('')}
                </select>`;
            }

            // Default textarea
            return `<textarea id="${key}" name="${key}" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" ${isDisabled}>${value}</textarea>`;
        }

        // Review Form Logic
        function renderReviewForm(reviewType, revieweeId, reviewId) {
            const review = AppState.reviews.find(r => r.id == reviewId) || { questions: {}, submitted_at: null };
            const questions = getQuestionSet(reviewType);
            const reviewee = AppState.users.find(u => u.id === revieweeId);
            const isSubmitted = !!review.submitted_at;
            
           // --- START: Logic to show Contextual Reviews ---
           let referenceReviewsHtml = '';
           if (reviewType === 'downward_manager' && reviewee) { 
               // --- For Manager reviewing Agent ---
               
               // 1. Find Agent's Self-Review
               const selfReview = AppState.reviews.find(r => 
                   r.reviewee_id === revieweeId && r.review_type === 'self' && r.submitted_at
               );

               // 2. Find QA's Downward Review
               const qaCoach = AppState.users.find(u => u.id === reviewee.qa_coach_id);
               const qaCoachName = qaCoach ? qaCoach.email : 'the QA Coach';
               const qaReview = AppState.reviews.find(r => 
                   r.reviewee_id === revieweeId && r.review_type === 'downward_qa' && r.submitted_at
               );

               let selfReviewDisplay = selfReview
                   ? `
                       <h3 class="text-lg font-semibold text-slate-800 mb-2">Agent's Self-Review (for reference)</h3>
                       ${renderReleasedReview(`${reviewee.email}'s Self-Review`, selfReview, true, true)}
                   `
                   : `
                       <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                           <p class="text-sm font-medium text-yellow-800">Note: The agent's self-review has not been submitted yet.</p>
                       </div>
                   `;

               let qaReviewDisplay = qaReview
                   ? `
                       <h3 class="text-lg font-semibold text-slate-800 mb-2 mt-4">QA Coach Review (for reference)</h3>
                       ${renderReleasedReview(`${qaCoachName}'s QA Review`, qaReview, true, true)}
                   `
                   : `
                       <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mt-4">
                           <p class="text-sm font-medium text-yellow-800">Note: The QA review from ${qaCoachName} has not been submitted yet.</p>
                       </div>
                   `;

               referenceReviewsHtml = `<div class="my-6">${selfReviewDisplay}${qaReviewDisplay}</div>`;

           } else if (reviewType === 'downward_ops' && reviewee) {
               // --- For Ops Manager reviewing Manager/QA ---
               
               // 1. Find Leader's Self-Review
               const selfReview = AppState.reviews.find(r => 
                   r.reviewee_id === revieweeId && r.review_type === 'self' && r.submitted_at
               );

               referenceReviewsHtml = `<div class="my-6">`;
               if (selfReview) {
                   referenceReviewsHtml += `
                       <h3 class="text-lg font-semibold text-slate-800 mb-2">Leader's Self-Review (for reference)</h3>
                       ${renderReleasedReview(`${reviewee.email}'s Self-Review`, selfReview, true, true)}
                   `;
               } else {
                   referenceReviewsHtml += `
                       <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                           <p class="text-sm font-medium text-yellow-800">Note: The leader's self-review has not been submitted yet.</p>
                       </div>
                   `;
               }
               referenceReviewsHtml += `</div>`;
           }
           // --- END: Logic to show Contextual Reviews ---


            const titleMap = {
                'self': 'Self-Review',
                'upward_manager': `Upward Review for ${reviewee.email}`,
                'upward_qa': `Upward Review for ${reviewee.email}`,
                'upward_ops': `Upward Review for ${reviewee.email}`,
                'downward_manager': `Downward Review for ${reviewee.email}`,
                'downward_qa': `QA Downward Review for ${reviewee.email}`,
                'downward_ops': `Downward Review for ${reviewee.email}`,
            };

             $app.innerHTML = `
                ${renderHeader()}
                <main class="py-10">
                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                        <button id="back-to-dashboard" class="mb-4 text-sm font-medium text-sky-600 hover:text-sky-800 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                            Back to Dashboard
                        </button>
                        <div class="bg-white rounded-lg shadow p-8">
                            <h2 class="text-2xl font-bold text-slate-900">${titleMap[reviewType]}</h2>
                             ${isSubmitted ? '<p class="mt-2 text-sm text-yellow-700 bg-yellow-100 p-3 rounded-md">This review has been submitted and cannot be edited.</p>' : ''}
                           
                           <!-- Inject QA and Self-review content here -->
                           ${referenceReviewsHtml}
                           
                           ${referenceReviewsHtml ? `<h3 class="text-lg font-semibold text-slate-800 border-b pb-2 mb-4">Your Review</h3>` : ''}

                            <form id="review-form" class="mt-6 space-y-6">
                                ${Object.entries(questions).map(([key, question]) => `
                                    <div>
                                        <label for="${key}" class="block text-sm font-medium text-slate-700">${question}</label>
                                        ${renderFormField(key, question, review, isSubmitted)}
                                    </div>
                                `).join('')}
                                ${!isSubmitted ? `
                                <div class="pt-5">
                                    <div class="flex justify-end space-x-3">
                                        <button type="button" id="save-progress-btn" class="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">Save Progress</button>
                                        <button type="submit" id="submit-review-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">Submit Review</button>
                                    </div>
                                </div>
                                ` : ''}
                            </form>
                        </div>
                    </div>
                </main>
             `;
            
            document.getElementById('back-to-dashboard').addEventListener('click', renderDashboard);

            if (!isSubmitted) {
                document.getElementById('review-form').addEventListener('submit', (e) => handleReviewSubmit(e, reviewType, revieweeId, review.id, true)); // Pass existing review.id
                document.getElementById('save-progress-btn').addEventListener('click', (e) => handleReviewSubmit(e, reviewType, revieweeId, review.id, false)); // Pass existing review.id
            }
        }

        async function handleReviewSubmit(e, reviewType, revieweeId, reviewId, isFinalSubmit) {
            e.preventDefault();
            const form = document.getElementById('review-form');
            const formData = new FormData(form);
            const questions = Object.fromEntries(formData.entries());
            
            let score = null;
            const questionSet = getQuestionSet(reviewType);
            // Find the key for the score question (e.g., 'q6')
            const scoreQuestionKey = Object.keys(questionSet).find(key => questionSet[key].includes('(14 scale)'));
            
            if (scoreQuestionKey) {
                const scoreValue = questions[scoreQuestionKey];
                if (scoreValue) score = parseInt(scoreValue, 10);
            }

            const reviewData = {
                reviewer_id: AppState.currentUser.id,
                reviewee_id: revieweeId,
                review_type: reviewType,
                phase: AppState.currentPhase,
                questions: questions,
                score: score,
            };

            if (isFinalSubmit) {
                 const confirmed = await renderModal('Confirm Submission', 'Are you sure you want to submit? This action cannot be undone.', 'Submit Review');
                 if (!confirmed) return;
                 reviewData.submitted_at = new Date().toISOString();
            }
            
            $app.insertAdjacentHTML('beforeend', renderSpinner());
            
            let query;
            if (reviewId) {
                // Update existing review
                query = supabaseClient.from('reviews').update(reviewData).eq('id', reviewId);
            } else {
                // Insert new review
                query = supabaseClient.from('reviews').insert(reviewData).select().single();
            }

            const { data: newOrUpdatedReview, error } = await query;

            if (error) {
                renderToast(error.message, 'error');
            } else {
                renderToast(isFinalSubmit ? 'Review submitted!' : 'Progress saved!', 'success');
                // Manually update local state to avoid full re-fetch
                if (reviewId) { // Update
                    const index = AppState.reviews.findIndex(r => r.id == reviewId);
                    if (index !== -1) AppState.reviews[index] = {...AppState.reviews[index], ...reviewData};
                } else if (newOrUpdatedReview) { // Insert
                    AppState.reviews.push(newOrUpdatedReview);
                }
            }
            
            // Go back to dashboard
            await renderDashboard();
        }

        function getQuestionSet(type) {
            const questionSets = {
                'self': {
                    q1: 'What did you accomplish over the past year?',
                    q2: 'What is one thing you are doing well that you want to keep doing?',
                    q3: 'What is one thing you would like to improve/develop?',
                    q4: 'Which of Tempos values do you incorporate into your work the most?',
                    q5: 'Which of Tempos values do you need to develop the most?',
                },
                'downward_manager': {
                    q1: 'Provide specific examples of how well your direct report has performed over the past year.',
                    q2: 'What is one thing this person has been doing well and should continue doing?',
                    q3: 'What is one thing this person should focus on improving over the next year?',
                    q4: 'Which of Tempos values does your direct report incorporate into their work the most?',
                    q5: 'Which of Tempos values does your direct report need to develop the most?',
                    q6: 'How would you rate your employees overall performance score? (14 scale)',
                    q7: 'Is this person an attrition risk?',
                    q8: 'Should this person be promoted now?',
                    q9: 'If recommending promotion, what should their new title be?',
                    q10: 'Any comments/suggestions about this persons compensation (salary, bonus, equity)?',
                },
                'downward_qa': {
                    q1: 'What is the agent doing particularly well in their role?',
                    q2: 'What specific skill or behavior should the agent focus on improving?',
                    q3: 'Provide any final comments on the agents overall performance last year.',
                },
                'downward_ops': { // Same as manager to agent
                    q1: 'Provide specific examples of how well your direct report has performed over the past year.',
                    q2: 'What is one thing this person has been doing well and should continue doing?',
                    q3: 'What is one thing this person should focus on improving over the next year?',
                    q4: 'Which of Tempos values does your direct report incorporate into their work the most?',
                    q5: 'Which of Tempos values does your direct report need to develop the most?',
                    q6: 'How would you rate your employees overall performance score? (14 scale)',
                    q7: 'Is this person an attrition risk?',
                    q8: 'Should this person be promoted now?',
                    q9: 'If recommending promotion, what should their new title be?',
                    q10: 'Any comments/suggestions about this persons compensation (salary, bonus, equity)?',
                },
                'upward_manager': {
                    q1: 'How would you describe your managers communication and ability to support the team?',
                    q2: 'How does your manager ensure team goals align with company objectives?',
                    q3: 'How well does your manager provide constructive feedback to develop your skills?',
                    q4: 'How confident are you in your managers decision-making? Do they consider team input?',
                    q5: 'Evaluate your managers leadership style and efforts in building team cohesion.',
                    q6: 'What should your manager keep doing?',
                    q7: 'What should your manager change?',
                },
                'upward_qa': { 
                    q1: 'How would you describe your QA Coachs communication and ability to support the team?',
                    q2: 'How does your QA Coach ensure team goals align with company objectives?',
                    q3: 'How well does your QA Coach provide constructive feedback to develop your skills?',
                    q4: 'How confident are you in your QA Coachs decision-making? Do they consider team input?',
                    q5: 'Evaluate your QA Coachs coaching style and efforts in helping you improve.',
                    q6: 'What should your QA Coach keep doing?',
                    q7: 'What should your QA Coach change?',
                },
                'upward_ops': {
                    q1: 'How would you describe your managers communication and ability to support the team?',
                    q2: 'How does your manager ensure team goals align with company objectives?',
                    q3: 'How well does your manager provide constructive feedback to develop your skills?',
                    q4: 'How confident are you in your managers decision-making? Do they consider team input?',
                    q5: 'Evaluate your managers leadership style and efforts in building team cohesion.',
                    q6: 'What should your manager keep doing?',
                    q7: 'What should your manager change?',
                }
            };
            return questionSets[type] || {};
        }

        async function handlePhaseChange(e) {
            const nextPhase = e.currentTarget.dataset.nextPhase;
            const confirmed = await renderModal('Confirm Phase Change', `Are you sure you want to move to Phase ${nextPhase}?`, `Move to Phase ${nextPhase}`);
            if (confirmed) {
                 $app.insertAdjacentHTML('beforeend', renderSpinner());
                 const { error } = await supabaseClient.from('phases').update({ current_phase: parseInt(nextPhase) }).eq('id', 'current');
                 if (error) renderToast(error.message, 'error');
                 else {
                     await renderDashboard();
                     renderToast(`Successfully moved to Phase ${nextPhase}!`, 'success');
                 }
            }
        }
        
        function populateStatusTable() {
            const tableBody = document.querySelector('#status-table tbody');
            if (!tableBody) return; // Guard clause if tab isn't visible
            const managerFilter = document.getElementById('manager-filter');
            const selectedManagerId = managerFilter.value;
            
            let filteredUsers = AppState.users.filter(u => u.role !== 'admin');
            if (selectedManagerId !== 'all') {
                filteredUsers = filteredUsers.filter(u => u.manager_id === selectedManagerId || u.id === selectedManagerId);
            }
            
            const rows = filteredUsers.map(user => {
                const requiredReviews = getRequiredReviewsForUser(user, AppState.currentPhase);
                if (requiredReviews.length === 0) return '';
                const reviewStatusHtml = requiredReviews.map(req => {
                    const review = AppState.reviews.find(r => r.reviewer_id === user.id && r.review_type === req.type && r.reviewee_id === req.reviewee_id);
                    const isSubmitted = review && review.submitted_at;
                    const statusBadge = `<span class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${isSubmitted ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${isSubmitted ? 'Completed' : 'Pending'}</span>`;
                    return `<div class="py-1">${req.name} ${statusBadge}</div>`;
                }).join('');

                return `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${user.role}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${reviewStatusHtml}</td>
                </tr>`;
            }).join('');
            tableBody.innerHTML = rows || `<tr><td colspan="3" class="text-center p-4 text-slate-500">No users match the filter.</td></tr>`;
        }

        function populateScoreTable() {
            const tableBody = document.querySelector('#score-table tbody');
            if (!tableBody) return; // Guard clause
            const managerFilter = document.getElementById('manager-filter');
            const selectedManagerId = managerFilter.value;
            const scoreMap = { 1: "Needs Improvement", 2: "Meeting Expectations", 3: "Exceeding", 4: "Top 10%"};

            let scoredReviews = AppState.reviews.filter(r => r.score && r.review_type !== 'downward_qa' && r.review_type.startsWith('downward'));

            if (selectedManagerId !== 'all') {
                // Find all users *managed* by this manager (e.g., agents)
                const teamMemberIds = AppState.users.filter(u => u.manager_id === selectedManagerId).map(u => u.id);
                // Also include the manager themself (for ops_manager viewing manager)
                teamMemberIds.push(selectedManagerId);
                
                scoredReviews = scoredReviews.filter(r => teamMemberIds.includes(r.reviewee_id));
            }
            
            const rows = scoredReviews.map(review => {
                const reviewee = AppState.users.find(u => u.id === review.reviewee_id);
                const reviewer = AppState.users.find(u => u.id === review.reviewer_id);
                return `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${reviewee?.email || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${reviewer?.email || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${review.score}: ${scoreMap[review.score] || ''}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-4">
                        <button class="view-calibration-context-btn text-indigo-600 hover:text-indigo-800" data-user-id="${review.reviewee_id}">View Context</button>
                        <button class="edit-score-btn text-sky-600 hover:text-sky-800" data-review-id="${review.id}" data-current-score="${review.score}">Edit</button>
                    </td>
                </tr>`;
            }).join('');
             tableBody.innerHTML = rows || `<tr><td colspan="4" class="text-center p-4 text-slate-500">No scored reviews match the filter.</td></tr>`;
        }

        function populateScoresOverviewTable() {
            const tableBody = document.querySelector('#scores-overview-table tbody');
            if (!tableBody) return; // Guard clause
            const roleFilter = document.getElementById('role-filter');
            const selectedRole = roleFilter.value;
            const scoreMap = { 1: "Needs Improvement", 2: "Meeting Expectations", 3: "Exceeding", 4: "Top 10%"};

            let scoredReviews = AppState.reviews.filter(r => r.score && r.submitted_at);

            if (selectedRole !== 'all') {
                const userIdsInRole = AppState.users.filter(u => u.role === selectedRole).map(u => u.id);
                scoredReviews = scoredReviews.filter(r => userIdsInRole.includes(r.reviewee_id));
            }
            
            const rows = scoredReviews.map(review => {
                const reviewee = AppState.users.find(u => u.id === review.reviewee_id);
                const reviewer = AppState.users.find(u => u.id === review.reviewer_id);
                return `<tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${reviewee?.email || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 capitalize">${reviewee?.role.replace('_', ' ') || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${reviewer?.email || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${review.score}: ${scoreMap[review.score] || ''}</td>
                </tr>`;
            }).join('');
            tableBody.innerHTML = rows || `<tr><td colspan="4" class="text-center p-4 text-slate-500">No scored reviews match the filter.</td></tr>`;
        }
        
        async function handleEditScore(button) {
            const { reviewId, currentScore } = button.dataset;
            const scoreOptions = `
                <select id="new-score-select" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm">
                    <option value="1" ${currentScore == 1 ? 'selected' : ''}>1: Needs Improvement</option>
                    <option value="2" ${currentScore == 2 ? 'selected' : ''}>2: Meeting Expectations</option>
                    <option value="3" ${currentScore == 3 ? 'selected' : ''}>3: Exceeding Expectations</option>
                    <option value="4" ${currentScore == 4 ? 'selected' : ''}>4: Top 10%</option>
                </select>
            `;
            const newScore = await renderModal('Adjust Score', 'Select the new performance score.', 'Update Score', 'Cancel', scoreOptions);

            if (newScore === false || newScore === undefined) return;

            const spinner = document.createElement('div');
            spinner.innerHTML = renderSpinner();
            document.body.appendChild(spinner);
            
            try {
                const { data: updatedReview, error } = await supabaseClient
                    .from('reviews')
                    .update({ score: parseInt(newScore) })
                    .eq('id', reviewId)
                    .select()
                    .single();

                if (error) throw error;
                
                // Update local state directly instead of full refresh
                const reviewIndex = AppState.reviews.findIndex(r => r.id == reviewId);
                if (reviewIndex !== -1) {
                    AppState.reviews[reviewIndex] = updatedReview;
                }

                // Re-populate only the table
                populateScoreTable();

                renderToast('Score updated successfully!', 'success');

            } catch (error) {
                console.error('Failed to update score:', error);
                renderToast(`Error updating score: ${error.message}`, 'error');
            } finally {
                spinner.remove();
            }
        }

        // NEW: Special filtered view for Admin calibration
        async function handleViewCalibrationContext(button) {
            const { userId } = button.dataset;
            const user = AppState.users.find(u => u.id === userId);
            if (!user) return;

            // Find all reviews *about* this user that are self or downward
            const relatedReviews = AppState.reviews.filter(r => 
                r.reviewee_id === userId && // Only reviews *about* this user
                (r.review_type === 'self' || r.review_type.startsWith('downward')) && // Only self or downward
                r.submitted_at
            );

            if (relatedReviews.length === 0) {
                renderToast(`No submitted self or downward reviews found for ${user.email}.`, 'info');
                return;
            }

            // Sort reviews logically (self first, then downward)
            relatedReviews.sort((a, b) => {
                if (a.review_type === 'self') return -1;
                if (b.review_type === 'self') return 1;
                return 0; // Downward reviews can come after self in any order
            });


            let modalContentHTML = '<div class="space-y-4">';
            for (const review of relatedReviews) {
                let title = '';
                if (review.review_type === 'self') {
                    title = 'Self-Review';
                } else if (review.review_type.startsWith('downward')) {
                    const reviewer = AppState.users.find(u => u.id === review.reviewer_id);
                    const reviewerRole = reviewer ? `(${reviewer.role.replace('_', ' ')})` : '';
                    title = `Downward Review from ${reviewer?.email || 'N/A'} ${reviewerRole}`;
                }
                
               // When Ops/Admin views all reviews, show summarize button
               modalContentHTML += renderReleasedReview(title, review, true, true); 
            }
            modalContentHTML += '</div>';
            
            renderFullReviewModal(user.email, modalContentHTML);
        }

        // RESTORED: Original "View All" function for Ops Manager
        async function handleViewFullReview(button) {
            const { userId } = button.dataset;
            const user = AppState.users.find(u => u.id === userId);
            if (!user) return;

            // Find all reviews where this user is either the reviewer or the reviewee
            const relatedReviews = AppState.reviews.filter(r => 
                (r.reviewer_id === userId || r.reviewee_id === userId) && r.submitted_at
            );

            if (relatedReviews.length === 0) {
                renderToast(`No submitted reviews found for ${user.email}.`, 'info');
                return;
            }

            // Sort reviews logically (self, then downward, then upward)
            relatedReviews.sort((a, b) => {
                if (a.review_type === 'self' && a.reviewee_id === userId) return -1;
                if (b.review_type === 'self' && b.reviewee_id === userId) return 1;
                if (a.review_type.startsWith('downward') && a.reviewee_id === userId) return -1;
                if (b.review_type.startsWith('downward') && b.reviewee_id === userId) return 1;
                if (a.review_type.startsWith('upward') && a.reviewee_id === userId) return 1; // Upward about them last
                if (b.review_type.startsWith('upward') && b.reviewee_id === userId) return -1;
                return 0; // Other reviews (e.g., written by them)
            });


            let modalContentHTML = '<div class="space-y-4">';
            for (const review of relatedReviews) {
                let title = '';
                if (review.review_type === 'self' && review.reviewer_id === userId) {
                    title = 'Self-Review';
                } else if (review.reviewee_id === userId) { // Review is about them
                    const reviewer = AppState.users.find(u => u.id === review.reviewer_id);
                    const reviewerRole = reviewer ? `(${reviewer.role.replace('_', ' ')})` : '';
                    if (review.review_type.startsWith('upward')) {
                        title = 'Upward Feedback (Anonymous)';
                    } else {
                        title = `Downward Review from ${reviewer?.email || 'N/A'} ${reviewerRole}`;
                    }
                } else { // Review is written by them
                    const reviewee = AppState.users.find(u => u.id === review.reviewee_id);
                     if (review.review_type.startsWith('upward')) {
                         title = `Upward Review for ${reviewee?.email || 'N/A'}`;
                     } else {
                         title = `Downward Review for ${reviewee?.email || 'N/A'}`;
                     }
                }
                
               // When Ops/Admin views all reviews, show summarize button
               modalContentHTML += renderReleasedReview(title, review, true, true); 
            }
            modalContentHTML += '</div>';
            
            renderFullReviewModal(user.email, modalContentHTML);
        }
        
        function getRequiredReviewsForUser(user, phase) {
            const reqs = [];
            if (phase === 1) {
                if (['agent', 'manager', 'qacoach'].includes(user.role)) reqs.push({ name: 'Self-Review', type: 'self', reviewee_id: user.id });
                if (user.role === 'agent') {
                    if (user.manager_id) reqs.push({ name: 'Upward (Manager)', type: 'upward_manager', reviewee_id: user.manager_id });
                    if (user.qa_coach_id) reqs.push({ name: 'Upward (QA Coach)', type: 'upward_qa', reviewee_id: user.qa_coach_id });
                }
                if (['manager', 'qacoach'].includes(user.role)) {
                    if (user.manager_id) reqs.push({ name: 'Upward (Ops)', type: 'upward_ops', reviewee_id: user.manager_id });
                }
            } else if (phase === 2) {
                if (user.role === 'manager') AppState.users.filter(u => u.manager_id === user.id).forEach(agent => reqs.push({ name: `Downward (${agent.email})`, type: 'downward_manager', reviewee_id: agent.id}));
                if (user.role === 'qacoach') AppState.users.filter(u => u.qa_coach_id === user.id).forEach(agent => reqs.push({ name: `Downward (${agent.email})`, type: 'downward_qa', reviewee_id: agent.id}));
                if (user.role === 'ops_manager') AppState.users.filter(u => u.manager_id === user.id).forEach(report => reqs.push({ name: `Downward (${report.email})`, type: 'downward_ops', reviewee_id: report.id}));
            }
            return reqs;
        }
        
        // --- Gemini API Integration ---
        async function callGeminiApi(prompt) {
            const apiKey = ""; // Leave empty, will be handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };

            let response;
            let result;
            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate a summary.";
                    } else {
                        throw new Error(`API Error: ${response.status}`);
                    }
                } catch (error) {
                    retries--;
                    if (retries === 0) {
                        console.error("Gemini API call failed after multiple retries:", error);
                        return "Failed to get summary due to a network or API error.";
                    }
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        async function handleSummarizeFeedback(button) {
            const { reviewId } = button.dataset;
            const review = AppState.reviews.find(r => r.id == reviewId);
            if (!review) {
                renderToast("Could not find review data.", "error");
                return;
            }
            
            // Disable button to prevent multiple clicks
            button.disabled = true;
            button.innerHTML = '<span></span> <span>Summarizing...</span>';

            const modalContent = `<div id="summary-content" class="my-4 p-4 bg-slate-100 rounded-md min-h-[10rem] flex items-center justify-center"><div class="spinner"></div></div>`;
            // Show a modal that *doesn't* require a promise, as we'll close it manually
            const modalPromise = renderModal(' AI-Powered Summary', 'Generating a summary of the feedback...', 'Close', '', modalContent);
            
            const questionSet = getQuestionSet(review.review_type);
            let fullReviewText = "";
            for (const [key, question] of Object.entries(questionSet)) {
                // Don't send sensitive questions to AI if they aren't for AI
                 const sensitiveQuestionKeys = ['q7', 'q8', 'q9', 'q10'];
                 if (sensitiveQuestionKeys.includes(key)) continue;
                 
                const answer = review.questions[key] || "No answer provided.";
                fullReviewText += `Q: ${question}\nA: ${answer}\n\n`;
            }

            const systemPrompt = "You are an expert HR professional. Summarize the following performance review feedback into two sections: 'Key Strengths' and 'Areas for Development'. Provide a balanced, professional, and constructive summary. Use bullet points for clarity.";
            const finalPrompt = `${systemPrompt}\n\n--- REVIEW DATA ---\n${fullReviewText}`;

            const summary = await callGeminiApi(finalPrompt);

            const summaryContentEl = document.getElementById('summary-content');
            if (summaryContentEl) {
                // Basic markdown to HTML conversion for bullet points
                const formattedSummary = summary
                    .replace(/\*\*(.*?)\*\*/g, '<br><strong class="text-slate-800">$1</strong>') // Bold
                    .replace(/\* (.*?)(?=\n\* |\n\n|$) /g, '<li class="ml-4 list-disc">$1</li>') // Bullets
                    .replace(/(\r\n|\n|\r)/g, '<br>'); // Newlines
                    
                summaryContentEl.innerHTML = `<div class="text-sm text-slate-700">${formattedSummary.replace('<br>', '')}</div>`; // Remove first <br>
                summaryContentEl.classList.remove('items-center', 'justify-center');
            }
            
            // Re-enable button
            button.disabled = false;
            button.innerHTML = '<span></span> <span>Summarize Feedback</span>';
        }

        // Analytics
        let chartInstances = {};
        function renderAllAnalytics() {
            const managerFilter = document.getElementById('analytics-manager-filter');
            const roleFilter = document.getElementById('analytics-role-filter');
            
            if (!managerFilter || !roleFilter) return; // Guard clause if tab not rendered
            
            const selectedManagerId = managerFilter.value;
            const selectedRole = roleFilter.value;
            
            const analyticsData = calculateAnalyticsData(selectedManagerId, selectedRole);
            
            renderStatCards(analyticsData);
            renderTeamScoreChart(analyticsData.teamScoresData); // <-- Fixed
            renderScoreByRoleChart(analyticsData.scoreByRoleData); // <-- New
            renderAttritionChart(analyticsData.attritionData); // <-- Updated
            renderPromotionChart(analyticsData.promotionData); // <-- New
        }
        
        function calculateAnalyticsData(managerId, role) {
            let relevantUsers = AppState.users.filter(u => u.role !== 'admin');

            // --- Apply Filters ---
            if (managerId !== 'all') {
                // "Team" = direct reports of the selected manager
                relevantUsers = relevantUsers.filter(u => u.manager_id === managerId);
            }
            if (role !== 'all') {
                relevantUsers = relevantUsers.filter(u => u.role === role);
            }
            
            const relevantUserIds = relevantUsers.map(u => u.id);
            
            // --- Calculate Completion ---
            let totalRequiredReviews = 0;
            for(let phase = 1; phase <= AppState.currentPhase; phase++) {
                 relevantUsers.forEach(user => {
                     totalRequiredReviews += getRequiredReviewsForUser(user, phase).length;
                 });
            }
            const completedReviews = AppState.reviews.filter(r => {
                return r.submitted_at && (relevantUserIds.includes(r.reviewer_id) || relevantUserIds.includes(r.reviewee_id));
            }).length;
            const completionRate = totalRequiredReviews > 0 ? ((completedReviews / totalRequiredReviews) * 100).toFixed(0) : 0;

            // --- Get All Scored Downward Reviews for Filtered Users ---
            // These are the reviews we will analyze for scores, attrition, and promotion
            const downwardReviews = AppState.reviews.filter(r => 
                r.submitted_at && 
                r.review_type.startsWith('downward') && 
                r.score && // Only reviews that have a score
                relevantUserIds.includes(r.reviewee_id) // Only for users in our filtered group
            );
            
            // --- Calculate Avg Score ---
            const scores = downwardReviews.map(r => r.score).filter(s => s);
            const averageScore = scores.length ? (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2) : 'N/A';
            
            // --- Calculate Attrition & Promotion ---
            const attritionData = { 'Yes': 0, 'No': 0, 'N/A': 0 };
            const promotionData = { 'Yes': 0, 'No': 0, 'Not Now': 0, 'N/A': 0 };
            
            downwardReviews.forEach(r => {
                if (r.review_type === 'downward_manager' || r.review_type === 'downward_ops') {
                    // Attrition (q7)
                    const attritionAnswer = r.questions?.q7?.toLowerCase();
                    if (attritionAnswer === 'yes') attritionData['Yes']++;
                    else if (attritionAnswer === 'no') attritionData['No']++;
                    else attritionData['N/A']++;
                    
                    // Promotion (q8)
                    const promotionAnswer = r.questions?.q8;
                    if (promotionAnswer === 'Yes') promotionData['Yes']++;
                    else if (promotionAnswer === 'No') promotionData['No']++;
                    else if (promotionAnswer === 'Not Now') promotionData['Not Now']++;
                    else promotionData['N/A']++;
                }
            });

            // --- Calculate Score by Role (Uses all submitted reviews, ignores filters) ---
            const scoreByRoleData = {
                'agent': { 1: 0, 2: 0, 3: 0, 4: 0 },
                'manager': { 1: 0, 2: 0, 3: 0, 4: 0 },
                'qacoach': { 1: 0, 2: 0, 3: 0, 4: 0 },
            };
            const allScoredReviews = AppState.reviews.filter(r => r.submitted_at && r.review_type.startsWith('downward') && r.score);
            allScoredReviews.forEach(r => {
                const revieweeRole = AppState.users.find(u => u.id === r.reviewee_id)?.role;
                if (revieweeRole && scoreByRoleData[revieweeRole]) {
                    scoreByRoleData[revieweeRole][r.score]++;
                }
            });

            // --- Calculate Team Scores (FIXED) (Uses all users, ignores filters) ---
            const teamScoresData = {};
            const allManagers = AppState.users.filter(u => u.role === 'manager' || u.role === 'ops_manager');
            
            allManagers.forEach(manager => {
                const reportIds = AppState.users.filter(u => u.manager_id === manager.id).map(u => u.id);
                if (reportIds.length > 0) {
                    const teamScores = AppState.reviews
                        .filter(r => reportIds.includes(r.reviewee_id) && r.review_type.startsWith('downward') && r.score)
                        .map(r => r.score);
                    
                    if (teamScores.length > 0) {
                        const avg = (teamScores.reduce((a, b) => a + b, 0) / teamScores.length);
                        teamScoresData[manager.email] = avg.toFixed(2);
                    }
                }
            });
            
            // --- Return All Data ---
            return {
                totalReviews: totalRequiredReviews,
                completionRate: completionRate,
                averageScore: averageScore,
                attritionData: attritionData,
                promotionData: promotionData,
                scoreByRoleData: scoreByRoleData,
                teamScoresData: teamScoresData,
            };
        }

        function renderStatCards(data) {
            const container = document.getElementById('stat-cards');
            if (!container) return;
            container.innerHTML = `
                <div class="bg-white p-5 rounded-lg shadow"><p class="text-sm text-slate-500">Completion Rate</p><p class="text-3xl font-bold text-slate-800">${data.completionRate}%</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><p class="text-sm text-slate-500">Average Score</p><p class="text-3xl font-bold text-slate-800">${data.averageScore}</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><p class="text-sm text-slate-500">High Potentials (Promo 'Yes')</p><p class="text-3xl font-bold text-slate-800">${data.promotionData['Yes']}</p></div>
                <div class="bg-white p-5 rounded-lg shadow"><p class="text-sm text-slate-500">High Attrition Risk ('Yes')</p><p class="text-3xl font-bold text-slate-800">${data.attritionData['Yes']}</p></div>
            `;
        }

        function renderScoreByRoleChart(data) {
            const ctxEl = document.getElementById('score-by-role-chart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            
            const labels = ['Agents', 'Managers', 'QA Coaches'];
            const datasets = [
                {
                    label: '1 - Needs Improvement',
                    data: [data.agent[1], data.manager[1], data.qacoach[1]],
                    backgroundColor: '#ef4444',
                },
                {
                    label: '2 - Meeting Expectations',
                    data: [data.agent[2], data.manager[2], data.qacoach[2]],
                    backgroundColor: '#f59e0b',
                },
                {
                    label: '3 - Exceeding',
                    data: [data.agent[3], data.manager[3], data.qacoach[3]],
                    backgroundColor: '#22c55e',
                },
                {
                    label: '4 - Top 10%',
                    data: [data.agent[4], data.manager[4], data.qacoach[4]],
                    backgroundColor: '#3b82f6',
                },
            ];
            
            if (chartInstances.scoreByRole) chartInstances.scoreByRole.destroy();
            chartInstances.scoreByRole = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true }
                    },
                    plugins: { 
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        function renderAttritionChart(data) {
            const ctxEl = document.getElementById('attrition-chart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            
            if (chartInstances.attrition) chartInstances.attrition.destroy();
            chartInstances.attrition = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Yes', 'No', 'N/A'],
                    datasets: [{ 
                        data: [data['Yes'], data['No'], data['N/A']], 
                        backgroundColor: ['#ef4444', '#22c55e', '#cbd5e1'] 
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }} }
            });
        }

        function renderPromotionChart(data) {
            const ctxEl = document.getElementById('promotion-chart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            
            if (chartInstances.promotion) chartInstances.promotion.destroy();
            chartInstances.promotion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Yes', 'No', 'Not Now', 'N/A'],
                    datasets: [{ 
                        data: [data['Yes'], data['No'], data['Not Now'], data['N/A']], 
                        backgroundColor: ['#22c55e', '#ef4444', '#f59e0b', '#cbd5e1'] 
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }} }
            });
        }

        function renderTeamScoreChart(data) {
            const ctxEl = document.getElementById('team-score-chart');
            if (!ctxEl) return;
            const ctx = ctxEl.getContext('2d');
            
            if (chartInstances.teamScore) chartInstances.teamScore.destroy();
            chartInstances.teamScore = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ 
                        label: 'Average Score', 
                        data: Object.values(data), 
                        backgroundColor: '#3b82f6' 
                    }]
                },
                options: { 
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false }}
                }
            });
        }
        
        // Export Logic
        function handleExportCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Reviewer", "Reviewee", "Review Type", "Submission Date", "Question", "Answer", "Score"];
            csvContent += headers.join(",") + "\r\n";

            AppState.reviews.forEach(review => {
                if (!review.submitted_at) return; // Only export submitted
                const questions = getQuestionSet(review.review_type);
                const reviewer = AppState.users.find(u => u.id === review.reviewer_id)?.email || 'N/A';
                const reviewee = AppState.users.find(u => u.id === review.reviewee_id)?.email || 'N/A';
                
                Object.entries(review.questions).forEach(([key, answer]) => {
                    const questionText = questions[key] || key;
                    const row = [
                        reviewer, 
                        reviewee, 
                        review.review_type, 
                        review.submitted_at ? new Date(review.submitted_at).toLocaleDateString() : 'Not Submitted', 
                        `"${questionText.replace(/"/g, '""')}"`, 
                        `"${String(answer).replace(/"/g, '""')}"`, 
                        review.score || '' 
                    ];
                    csvContent += row.join(",") + "\r\n";
                });
            });

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "performance_reviews.csv");
            document.body.appendChild(link);
            link.click();
            link.remove();
            renderToast('CSV export started.', 'success');
        }

        function handleExportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text("Performance Review Full Report", 14, 16);
            doc.setFontSize(10);
            doc.text(`Exported on: ${new Date().toLocaleDateString()}`, 14, 22);

            let yPos = 30;
            const sortedReviews = [...AppState.reviews]
                .filter(r => r.submitted_at) // Only submitted
                .sort((a, b) => { // Sort by reviewee, then type
                    const emailA = AppState.users.find(u => u.id === a.reviewee_id)?.email || '';
                    const emailB = AppState.users.find(u => u.id === b.reviewee_id)?.email || '';
                    if (emailA !== emailB) return emailA.localeCompare(emailB);
                    return a.review_type.localeCompare(b.review_type);
                });
            
            sortedReviews.forEach(review => {
                if (yPos > 260) { doc.addPage(); yPos = 15; }
                const reviewer = AppState.users.find(u => u.id === review.reviewer_id)?.email || 'N/A';
                const reviewee = AppState.users.find(u => u.id === review.reviewee_id)?.email || 'N/A';
                const questions = getQuestionSet(review.review_type);

                doc.setFont(undefined, 'bold');
                doc.text(`Review for: ${reviewee} by ${reviewer} (${review.review_type})`, 14, yPos);
                yPos += 7;
                
                const tableBody = Object.entries(review.questions).map(([key, answer]) => [questions[key] || key, String(answer)]);
                if (review.score) tableBody.push(['Overall Score', String(review.score)]);

                doc.autoTable({
                    startY: yPos,
                    head: [['Question', 'Answer']],
                    body: tableBody,
                    theme: 'striped',
                    headStyles: { fillColor: [34, 139, 230] }, // Sky color
                    didDrawPage: (data) => { yPos = data.cursor.y; }
                });
                yPos = doc.lastAutoTable.finalY + 10;
            });
            
            doc.save("performance_reviews.pdf");
            renderToast('PDF export started.', 'success');
        }

    </script>
</body>
</html>
