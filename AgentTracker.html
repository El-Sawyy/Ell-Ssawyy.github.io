<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance & Quality Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class', // or 'media'
        theme: {
            extend: {
                typography: ({ theme }) => ({
                    DEFAULT: {
                        css: {
                            a: {
                              color: theme('colors.blue.600'),
                              textDecoration: 'underline',
                              '&:hover': {
                                color: theme('colors.blue.700'),
                              },
                            },
                        }
                    },
                    invert: {
                        css: {
                            a: {
                              color: theme('colors.blue.400'),
                              '&:hover': {
                                color: theme('colors.blue.500'),
                              },
                            },
                        }
                    }
                })
            }
        }
      }
    </script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Libraries (v9+ compat libraries for global access) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <!-- Libraries for DOCX download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.min.js"></script>
    <style>
        /* Styles to mimic Tailwind Prose for better rendering of raw HTML */
        .prose {
            color: #374151; /* gray-700 */
        }
        .dark .prose {
            color: #d1d5db; /* gray-300 */
        }
        .prose a {
          color: #2563eb; /* A default blue link color */
          text-decoration: underline;
        }
        .dark .prose a {
          color: #60a5fa; /* A lighter blue for dark mode */
        }
        .prose strong {
            font-weight: 600;
        }
        .prose ul, .prose ol {
            margin-top: 1em;
            margin-bottom: 1em;
            padding-left: 1.5em;
        }
        .prose ul {
            list-style-type: disc;
        }
         .prose ol {
            list-style-type: decimal;
        }
        .prose li {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
        }
        /* Fix for contentEditable divs */
        .rich-text-editor div, .rich-text-editor p, .rich-text-editor br {
             margin: 0 !important;
             padding: 0 !important;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // --- Your Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyDB183VLIdw9tE7gr5cbs0dCPsyjmXG9r8",
          authDomain: "tempo-tracker-719c9.firebaseapp.com",
          projectId: "tempo-tracker-719c9",
          storageBucket: "tempo-tracker-719c9.appspot.com",
          messagingSenderId: "528680834479",
          appId: "1:528680834479:web:41fe2ca649ce4c286c8b5a"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const { useState, useEffect, useCallback, createContext, useContext, useMemo } = React;

        // --- Theme Context and Provider ---
        const ThemeContext = createContext();

        const ThemeProvider = ({ children }) => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'dark');

            useEffect(() => {
                const root = window.document.documentElement;
                root.classList.remove('light', 'dark');
                root.classList.add(theme);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prevTheme => (prevTheme === 'dark' ? 'light' : 'dark'));
            };

            return (
                <ThemeContext.Provider value={{ theme, toggleTheme }}>
                    {children}
                </ThemeContext.Provider>
            );
        };

        const useTheme = () => useContext(ThemeContext);
        
        // --- SVG Icons ---
        const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const ChevronDownIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>;
        const FileTextIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>;
        const AlertTriangleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>;
        const PlusCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
        const XIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const EyeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const SparklesIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.9 5.8-5.8 1.9 5.8 1.9 1.9 5.8 1.9-5.8 5.8-1.9-5.8-1.9z"/></svg>;
        const CheckCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const LogOutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
        const SunIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
        const MoonIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
        const MessageSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
        const ClipboardIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>;
        const LinkIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>;
        const CheckboxIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>;

        const TEAMS = ['T2 Order Support', 'Social Media Team', 'T2 Product Support', 'Member Experience Team', 'Unassigned'];

        // --- Main App Controller ---
        function Main() {
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [agentId, setAgentId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [dbError, setDbError] = useState(null);

            useEffect(() => {
                const unsubscribeAuth = auth.onAuthStateChanged((userAuth) => {
                    if (userAuth) {
                        setUser(userAuth);
                        const unsubscribeRole = db.collection('users').doc(userAuth.uid).onSnapshot(userDoc => {
                            setLoading(false);
                            setDbError(null);
                            if (userDoc.exists) {
                                const data = userDoc.data();
                                setUserRole(data.role);
                                setAgentId(data.agentId || null);
                            } else {
                                setUserRole(null);
                            }
                        }, (error) => {
                             console.error("Error fetching user role:", error);
                             if (error.code === 'permission-denied') {
                                 setDbError("Could not verify your role due to a database permissions issue. Please contact your administrator and ask them to verify the Firestore security rules.");
                             } else {
                                 setDbError("An unexpected error occurred while fetching your user role.");
                             }
                             setUserRole(null);
                             setLoading(false);
                        });
                        return () => unsubscribeRole();
                    } else {
                        setUser(null);
                        setUserRole(null);
                        setLoading(false);
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            if (loading) {
                return <div className="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">Loading...</div>;
            }
            
            if (dbError && user) {
                 return (
                     <div className="flex items-center justify-center min-h-screen flex-col bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
                         <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 px-4 py-3 rounded-lg relative text-center max-w-lg" role="alert">
                             <strong className="font-bold">Permissions Error!</strong>
                             <p className="block sm:inline ml-2">{dbError}</p>
                             <button onClick={() => auth.signOut()} className="mt-4 bg-red-500 text-white py-2 px-4 rounded-lg">Log Out</button>
                         </div>
                     </div>
                 );
            }

            if (!user) {
                return <LoginPage />;
            }
            if (userRole === 'admin') {
                return <AdminView user={user}/>;
            }
            if (userRole === 'agent') {
                return <AgentView user={user} agentId={agentId} />;
            }
            return (
                 <div className="flex items-center justify-center min-h-screen flex-col bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
                     <p className="mb-4">Your account role is not yet assigned. Please contact an administrator.</p>
                     <button onClick={() => auth.signOut()} className="bg-red-500 text-white py-2 px-4 rounded-lg">Log Out</button>
                 </div>
            );
        }

        // --- Login Page Component ---
        function LoginPage() {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [employeeId, setEmployeeId] = useState('');
            const [team, setTeam] = useState(TEAMS[0]);
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isLogin) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        // 1. Create user in Auth
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const { user } = userCredential;

                        // 2. Create agent profile first to get its ID
                        const agentRef = await db.collection('agents').add({
                            name,
                            employeeId,
                            email: user.email,
                            team,
                            createdAt: new Date().toISOString(),
                        });

                        // 3. Create user document with role and agentId
                        await db.collection('users').doc(user.uid).set({
                            email: user.email,
                            role: 'agent',
                            agentId: agentRef.id // Link user to their agent profile
                        });
                    }
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
                    <div className="absolute top-4 right-4">
                        <ThemeToggleButton />
                    </div>
                    <div className="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md w-full max-w-md">
                        <h2 className="text-2xl font-bold mb-6 text-center text-gray-800 dark:text-gray-200">{isLogin ? 'Log In' : 'Sign Up'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && (
                                <React.Fragment>
                                    <FormInput label="Full Name" type="text" value={name} onChange={e => setName(e.target.value)} required />
                                    <FormInput label="Employee ID" type="text" value={employeeId} onChange={e => setEmployeeId(e.target.value)} required />
                                    <div>
                                        <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Team</label>
                                        <select value={team} onChange={e => setTeam(e.target.value)} className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                            {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>
                                </React.Fragment>
                            )}
                            <FormInput label="Email" type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                            <FormInput label="Password" type="password" value={password} onChange={e => setPassword(e.target.value)} required />
                            
                            {error && <p className="text-red-500 text-sm">{error}</p>}
                            <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">{isLogin ? 'Log In' : 'Sign Up'}</button>
                        </form>
                        <p className="text-center mt-4 text-gray-600 dark:text-gray-400">
                            {isLogin ? "Don't have an account?" : 'Already have an account?'}
                            <button onClick={() => setIsLogin(!isLogin)} className="text-blue-500 hover:underline ml-1">
                                {isLogin ? 'Sign Up' : 'Log In'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        // --- Admin View Component ---
        function AdminView({ user }) {
            const [view, setView] = useState('dashboard');
            const [agents, setAgents] = useState([]);
            const [selectedAgent, setSelectedAgent] = useState(null);
            const [plans, setPlans] = useState([]);
            const [warnings, setWarnings] = useState([]);
            const [coachingSessions, setCoachingSessions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [modal, setModal] = useState({ isOpen: false, type: '', data: null });
            const [agentDetailView, setAgentDetailView] = useState('coaching');
            const [coachFilter, setCoachFilter] = useState('All');
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
            const [expandedTeams, setExpandedTeams] = useState({});

            const agentsPath = `agents`;
            const getPlansPath = (agentId) => `agents/${agentId}/plans`;
            const getWarningsPath = (agentId) => `agents/${agentId}/warnings`;
            const getCoachingPath = (agentId) => `agents/${agentId}/coaching`;
            
            const groupedAgents = useMemo(() => {
                const groups = agents.reduce((acc, agent) => {
                    const team = agent.team || 'Unassigned';
                    if (!acc[team]) {
                        acc[team] = [];
                    }
                    acc[team].push(agent);
                    return acc;
                }, {});
                return Object.keys(groups).sort().reduce((acc, key) => ({...acc, [key]: groups[key]}), {});
            }, [agents]);

            useEffect(() => {
                // Pre-expand all teams by default
                const allTeams = agents.reduce((acc, agent) => ({...acc, [agent.team || 'Unassigned']: true }), {});
                setExpandedTeams(allTeams);
            }, [agents]);
            
            const toggleTeam = (teamName) => {
                setExpandedTeams(prev => ({...prev, [teamName]: !prev[teamName]}));
            };

            const filteredPlans = useMemo(() => {
                if (!plans) return [];
                return plans.filter(p => {
                    const itemDate = new Date(p.startDate || p.date);
                    return itemDate.getMonth() === selectedMonth && itemDate.getFullYear() === selectedYear;
                });
            }, [plans, selectedMonth, selectedYear]);

            const filteredWarnings = useMemo(() => {
                if (!warnings) return [];
                return warnings.filter(w => {
                    const itemDate = new Date(w.date);
                    return itemDate.getMonth() === selectedMonth && itemDate.getFullYear() === selectedYear;
                });
            }, [warnings, selectedMonth, selectedYear]);

            const filteredCoaching = useMemo(() => {
                if (!coachingSessions) return [];
                return coachingSessions.filter(c => {
                    const itemDate = new Date(c.date);
                    return itemDate.getMonth() === selectedMonth && itemDate.getFullYear() === selectedYear;
                });
            }, [coachingSessions, selectedMonth, selectedYear]);
            
            useEffect(() => {
                const unsubscribe = db.collection(agentsPath).onSnapshot((snapshot) => {
                    setAgents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                }, (error) => console.error("Error fetching agents:", error));
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!selectedAgent) { 
                    setPlans([]); 
                    setWarnings([]);
                    setCoachingSessions([]); 
                    return; 
                }
                setCoachFilter('All');

                const unsubPlans = db.collection(getPlansPath(selectedAgent.id)).orderBy('startDate', 'desc').onSnapshot((snapshot) => setPlans(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubWarnings = db.collection(getWarningsPath(selectedAgent.id)).orderBy('date', 'desc').onSnapshot((snapshot) => setWarnings(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubCoaching = db.collection(getCoachingPath(selectedAgent.id)).orderBy('date', 'desc').onSnapshot((snapshot) => setCoachingSessions(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                return () => { unsubPlans(); unsubWarnings(); unsubCoaching(); };
            }, [selectedAgent]);

            const handleSaveData = async (type, data) => {
                const collectionMap = {
                    'plan': getPlansPath(selectedAgent.id),
                    'warning': getWarningsPath(selectedAgent.id),
                    'coaching': getCoachingPath(selectedAgent.id),
                    'agent': agentsPath,
                };
                if (!collectionMap[type] || (type !== 'agent' && !selectedAgent && type !== 'agent')) return;
                
                const collectionRef = db.collection(collectionMap[type]);
                try {
                    const dataToSave = { ...data };
                    const id = data.id;
                    delete dataToSave.id;
                    if (id) {
                         await collectionRef.doc(id).update({...dataToSave, lastModifiedBy: user.email});
                    } else {
                         await collectionRef.add({ ...dataToSave, createdBy: user.email, createdAt: new Date().toISOString() });
                    }
                    closeModal();
                } catch (error) { console.error(`Error saving ${type}:`, error); }
            };

            const handleDelete = async (type, id) => {
               if (!selectedAgent) return;
                const collectionMap = {
                    'plan': getPlansPath(selectedAgent.id),
                    'warning': getWarningsPath(selectedAgent.id),
                    'coaching': getCoachingPath(selectedAgent.id),
                };
               openModal('CONFIRM_DELETE', { 
                   title: `Delete ${type}`,
                   message: `Are you sure you want to delete this ${type}?`,
                   onConfirm: async () => {
                       await db.collection(collectionMap[type]).doc(id).delete();
                       closeModal();
                   }
               });
            };

            const handleDeleteAgent = (agent) => {
                openModal('CONFIRM_DELETE', {
                    title: `Delete Agent: ${agent.name}`,
                    message: `This will also delete all associated plans, warnings, and coaching sessions. This cannot be undone.`,
                    onConfirm: async () => {
                        const plansSnapshot = await db.collection(getPlansPath(agent.id)).get();
                        await Promise.all(plansSnapshot.docs.map(doc => doc.ref.delete()));
                        const warningsSnapshot = await db.collection(getWarningsPath(agent.id)).get();
                        await Promise.all(warningsSnapshot.docs.map(doc => doc.ref.delete()));
                        const coachingSnapshot = await db.collection(getCoachingPath(agent.id)).get();
                        await Promise.all(coachingSnapshot.docs.map(doc => doc.ref.delete()));
                        
                        await db.collection(agentsPath).doc(agent.id).delete();
                        if (selectedAgent?.id === agent.id) setSelectedAgent(null);
                        closeModal();
                    }
                });
            };
            
            const openModal = (type, data = null) => setModal({ isOpen: true, type, data });
            const closeModal = () => setModal({ isOpen: false, type: '', data: null });
            
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const years = [...new Set(coachingSessions.concat(plans, warnings).map(s => new Date(s.date || s.startDate).getFullYear()))].sort((a,b) => b-a);


            return (
                 <div className="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen font-sans flex flex-col md:flex-row transition-colors duration-300">
                      <aside className="w-full md:w-72 bg-white dark:bg-gray-800 p-4 border-r border-gray-200 dark:border-gray-700 flex-shrink-0">
                          <div className="flex justify-between items-center mb-4">
                              <h1 className="text-xl font-bold text-gray-900 dark:text-white">Admin Tracker</h1>
                               <div className="flex items-center gap-2">
                                   <ThemeToggleButton />
                                   <button onClick={() => auth.signOut()} title="Log Out" className="text-gray-500 hover:text-red-500"><LogOutIcon /></button>
                               </div>
                          </div>
                          <div className="flex border border-gray-200 dark:border-gray-700 rounded-md mb-4">
                           <button onClick={() => setView('dashboard')} className={`w-1/2 p-2 text-sm font-semibold rounded-l-md ${view === 'dashboard' ? 'bg-blue-600 text-white' : 'bg-transparent text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'}`}>Dashboard</button>
                           <button onClick={() => setView('tracker')} className={`w-1/2 p-2 text-sm font-semibold rounded-r-md ${view === 'tracker' ? 'bg-blue-600 text-white' : 'bg-transparent text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700'}`}>Agents</button>
                          </div>
                          {view === 'tracker' && (
                              <nav className="space-y-1">
                                  {isLoading ? <p>Loading...</p> : Object.keys(groupedAgents).map(teamName => (
                                      <div key={teamName}>
                                          <button onClick={() => toggleTeam(teamName)} className="w-full flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-left font-semibold">
                                              <span>{teamName}</span>
                                              <ChevronDownIcon />
                                          </button>
                                          {expandedTeams[teamName] && (
                                              <div className="pl-4">
                                                  {groupedAgents[teamName].map(agent => (
                                                      <div key={agent.id} className={`group flex items-center justify-between p-2 rounded-lg ${selectedAgent?.id === agent.id ? 'bg-blue-100 dark:bg-blue-900' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`}>
                                                          <a href="#" onClick={(e) => { e.preventDefault(); setSelectedAgent(agent); }} className="flex items-center gap-3 flex-grow">
                                                              <UserIcon />
                                                              <div>
                                                                  <span className="font-semibold">{agent.name}</span>
                                                                  <span className="text-xs text-gray-500 dark:text-gray-400 block">ID: {agent.employeeId}</span>
                                                              </div>
                                                          </a>
                                                          <div className="flex opacity-0 group-hover:opacity-100">
                                                              <button onClick={() => openModal('EDIT_AGENT', agent)} className="text-gray-500 hover:text-green-600 p-1 rounded-full"><EditIcon /></button>
                                                              <button onClick={() => handleDeleteAgent(agent)} className="text-gray-500 hover:text-red-600 p-1 rounded-full"><TrashIcon /></button>
                                                          </div>
                                                      </div>
                                                  ))}
                                              </div>
                                          )}
                                      </div>
                                  ))}
                              </nav>
                          )}
                      </aside>
                      <main className="flex-1 p-4 md:p-8 overflow-auto">
                          {view === 'dashboard' ? <AdminDashboard agents={agents} setSelectedAgent={setSelectedAgent} setView={setView} setAgentDetailView={setAgentDetailView} selectedMonth={selectedMonth} setSelectedMonth={setSelectedMonth} selectedYear={selectedYear} setSelectedYear={setSelectedYear} /> : 
                           selectedAgent ? (
                              <div>
                                  <header className="mb-8">
                                      <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-1">{selectedAgent.name}'s Dashboard</h2>
                                      <p className="text-gray-500 dark:text-gray-400">Employee ID: {selectedAgent.employeeId}</p>
                                  </header>
                                  <DashboardStats plans={plans} warnings={warnings} />

                                  <div className="flex justify-end items-center gap-2 mb-4">
                                      <span className="text-sm font-medium text-gray-600 dark:text-gray-400">Filter by month:</span>
                                      <select value={selectedMonth} onChange={e => setSelectedMonth(parseInt(e.target.value))} className="p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                          {months.map((month, i) => <option key={month} value={i}>{month}</option>)}
                                      </select>
                                      <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                          {years.map(year => <option key={year} value={year}>{year}</option>)}
                                      </select>
                                  </div>

                                  <div className="mb-6">
                                    <div className="flex border border-gray-200 dark:border-gray-700 rounded-md">
                                        <button onClick={() => setAgentDetailView('coaching')} className={`w-1/3 p-2 text-sm font-semibold rounded-l-md transition-colors ${agentDetailView === 'coaching' ? 'bg-purple-600 text-white' : 'bg-transparent text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700'}`}>
                                            Coaching
                                        </button>
                                        <button onClick={() => setAgentDetailView('plans')} className={`w-1/3 p-2 text-sm font-semibold border-l border-r border-gray-200 dark:border-gray-700 transition-colors ${agentDetailView === 'plans' ? 'bg-green-600 text-white' : 'bg-transparent text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700'}`}>
                                            Plans
                                        </button>
                                        <button onClick={() => setAgentDetailView('warnings')} className={`w-1/3 p-2 text-sm font-semibold rounded-r-md transition-colors ${agentDetailView === 'warnings' ? 'bg-yellow-500 text-white' : 'bg-transparent text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700'}`}>
                                            Warnings
                                        </button>
                                    </div>
                                  </div>
                                  <div className="space-y-8">
                                      {agentDetailView === 'coaching' && <CoachingSectionForAdmin user={user} coachingSessions={filteredCoaching} coachFilter={coachFilter} setCoachFilter={setCoachFilter} openModal={openModal} handleDelete={handleDelete} />}
                                      {agentDetailView === 'plans' && (
                                          <section>
                                              <div className="flex items-center justify-between mb-4">
                                                  <h3 className="text-2xl font-semibold flex items-center gap-2"><FileTextIcon /> Plans (PIP/QIP)</h3>
                                                  <button onClick={() => openModal('EDIT_PLAN')} className="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                                      <PlusCircleIcon /> Create Plan
                                                  </button>
                                              </div>
                                              <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
                                                  {filteredPlans.length > 0 ? filteredPlans.map(plan => (
                                                      <DocumentListItem key={plan.id} doc={plan} type="plan" onView={() => openModal('VIEW_PLAN', plan)} onEdit={() => openModal('EDIT_PLAN', plan)} onDelete={() => handleDelete('plan', plan.id)} selectedAgent={selectedAgent} getPlansPath={getPlansPath} isAdmin={true} />
                                                  )) : <p className="text-gray-500 dark:text-gray-400 p-4">No plans for this agent for the selected period.</p>}
                                              </div>
                                          </section>
                                      )}
                                      {agentDetailView === 'warnings' && (
                                          <section>
                                              <div className="flex items-center justify-between mb-4">
                                                  <h3 className="text-2xl font-semibold flex items-center gap-2"><AlertTriangleIcon /> Warnings</h3>
                                                  <button onClick={() => openModal('EDIT_WARNING')} className="bg-yellow-500 text-white py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors flex items-center gap-2">
                                                      <PlusCircleIcon /> Create Warning
                                                  </button>
                                              </div>
                                              <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
                                                 {filteredWarnings.length > 0 ? filteredWarnings.map(warning => (
                                                      <DocumentListItem key={warning.id} doc={warning} type="warning" onView={() => openModal('VIEW_WARNING', warning)} onEdit={() => openModal('EDIT_WARNING', warning)} onDelete={() => handleDelete('warning', warning.id)} isAdmin={true}/>
                                                  )) : <p className="text-gray-500 dark:text-gray-400 p-4">No warnings on record for this agent for the selected period.</p>}
                                              </div>
                                          </section>
                                      )}
                                  </div>
                              </div>
                          ) : (
                              <div className="flex items-center justify-center h-full"><div className="text-center"><h2 className="text-2xl font-semibold text-gray-600 dark:text-gray-300">Select an agent to view their details</h2></div></div>
                          )}
                      </main>
                      {modal.isOpen && (
                          <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                              <div className={`bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full ${modal.type.startsWith('VIEW') ? 'max-w-4xl' : 'max-w-2xl'} max-h-[90vh] relative flex flex-col`}>
                                  <div className="flex-shrink-0 flex justify-between items-center p-4 border-b dark:border-gray-700">
                                      <h3 className="text-xl font-semibold">{ 
                                          modal.type === 'EDIT_AGENT' ? (modal.data?.id ? 'Edit Agent' : 'Add New Agent') : 
                                          modal.type === 'EDIT_PLAN' ? (modal.data?.id ? 'Edit Plan' : 'Create New Plan') : 
                                          modal.type === 'EDIT_WARNING' ? (modal.data?.id ? 'Edit Warning' : 'Create New Warning') : 
                                          modal.type === 'EDIT_COACHING' ? (modal.data?.id ? 'Edit Coaching Session' : 'Create Coaching Session') : 
                                          modal.type === 'VIEW_PLAN' ? `Viewing Plan: ${modal.data.type}` : 
                                          modal.type === 'VIEW_WARNING' ? `Viewing Warning: ${modal.data.type}` : 
                                          modal.type === 'VIEW_COACHING' ? `Viewing Session: ${new Date(modal.data.date).toLocaleDateString()}` :
                                          (modal.data?.title || 'Confirm Deletion') 
                                      }</h3>
                                      <button onClick={closeModal} className="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200"><XIcon /></button>
                                  </div>
                                  <div className="p-6 overflow-y-auto flex-grow">
                                      {modal.type === 'EDIT_AGENT' && <AgentForm onSubmit={(data) => handleSaveData('agent', {...data, id: modal.data?.id})} onCancel={closeModal} initialData={modal.data} />}
                                      {modal.type === 'EDIT_PLAN' && <PlanForm onSubmit={(data) => handleSaveData('plan', data)} onCancel={closeModal} initialData={modal.data} />}
                                      {modal.type === 'EDIT_WARNING' && <WarningForm onSubmit={(data) => handleSaveData('warning', data)} onCancel={closeModal} initialData={modal.data} />}
                                      {modal.type === 'EDIT_COACHING' && <CoachingForm onSubmit={(data) => handleSaveData('coaching', data)} onCancel={closeModal} initialData={modal.data} />}

                                      {(modal.type === 'VIEW_PLAN' || modal.type === 'VIEW_WARNING') && <DocumentViewer data={modal.data} type={modal.type.split('_')[1].toLowerCase()} agent={selectedAgent} user={user} isAdmin={true} />}
                                      {modal.type === 'VIEW_COACHING' && <CoachingViewer data={modal.data} />}

                                       {modal.type === 'CONFIRM_DELETE' && (
                                           <div>
                                               <p>{modal.data?.message || 'Are you sure you want to delete this item?'}</p>
                                               <div className="flex justify-end gap-2 mt-4"><button onClick={closeModal} className="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500">Cancel</button><button onClick={modal.data.onConfirm} className="py-2 px-4 rounded-md bg-red-600 text-white hover:bg-red-700">Delete</button></div>
                                           </div>
                                       )}
                                  </div>
                              </div>
                          </div>
                      )}
                 </div>
            )
        }
        
        // --- Agent View Component ---
        function AgentView({ user, agentId }) {
            const [agentData, setAgentData] = useState(null);
            const [plans, setPlans] = useState([]);
            const [warnings, setWarnings] = useState([]);
            const [coachingSessions, setCoachingSessions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [modal, setModal] = useState({ isOpen: false, type: '', data: null });
            const [error, setError] = useState(null);
            const [agentDashboardView, setAgentDashboardView] = useState('coaching');
            const [coachFilter, setCoachFilter] = useState('All');
            const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth());
            const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());

            const monthlyFilteredSessions = useMemo(() => {
                return coachingSessions.filter(session => {
                    const sessionDate = new Date(session.date);
                    return sessionDate.getMonth() === selectedMonth && sessionDate.getFullYear() === selectedYear;
                });
            }, [coachingSessions, selectedMonth, selectedYear]);

            const coachTypes = useMemo(() => ['All', ...new Set(monthlyFilteredSessions.map(s => s.coachType).filter(Boolean))], [monthlyFilteredSessions]);
            
            const filteredCoachingSessions = useMemo(() => {
                if (coachFilter === 'All') return monthlyFilteredSessions;
                return monthlyFilteredSessions.filter(s => s.coachType === coachFilter);
            }, [coachFilter, monthlyFilteredSessions]);

            useEffect(() => {
                if (!agentId) {
                    setIsLoading(false);
                    return;
                }
                
                setIsLoading(true);
                setError(null);
                
                let unsubscribes = [];

                const agentDocRef = db.collection('agents').doc(agentId);
                unsubscribes.push(agentDocRef.onSnapshot(agentDoc => {
                    setIsLoading(false);
                    if (agentDoc.exists) {
                        setAgentData({ id: agentDoc.id, ...agentDoc.data() });
                        
                        unsubscribes.push(db.collection(`agents/${agentId}/plans`).orderBy('startDate', 'desc').onSnapshot(snap => setPlans(snap.docs.map(d => ({id:d.id, ...d.data()})))));
                        unsubscribes.push(db.collection(`agents/${agentId}/warnings`).orderBy('date', 'desc').onSnapshot(snap => setWarnings(snap.docs.map(d => ({id:d.id, ...d.data()})))));
                        unsubscribes.push(db.collection(`agents/${agentId}/coaching`).orderBy('date', 'desc').onSnapshot(snap => setCoachingSessions(snap.docs.map(d => ({id:d.id, ...d.data()})))));

                    } else {
                        setAgentData(null);
                    }
                }, err => {
                     console.error("Error fetching agent profile:", err);
                     setError("Could not load your profile due to a database permissions error. Please contact an admin.");
                     setIsLoading(false);
                }));


                return () => {
                    unsubscribes.forEach(unsub => unsub());
                };
            }, [agentId]);
            
            const openModal = (type, data = null) => setModal({ isOpen: true, type, data });
            const closeModal = () => setModal({ isOpen: false, type: '', data: null });

            if (isLoading) return <div className="flex items-center justify-center min-h-screen">Loading Your Data...</div>;

            if (error) {
                return (
                     <div className="flex items-center justify-center min-h-screen flex-col">
                         <p className="mb-4 text-red-500">{error}</p>
                         <button onClick={() => auth.signOut()} className="bg-red-500 text-white py-2 px-4 rounded-lg">Log Out</button>
                     </div>
                );
            }

            if (!agentData) {
                return (
                    <div className="flex items-center justify-center min-h-screen flex-col">
                        <p className="mb-4">Your agent profile has not been set up by an administrator yet.</p>
                        <button onClick={() => auth.signOut()} className="bg-red-500 text-white py-2 px-4 rounded-lg">Log Out</button>
                    </div>
                );
            }

            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const years = [...new Set(coachingSessions.map(s => new Date(s.date).getFullYear()))].sort((a,b) => b-a);

            return (
                 <div className="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen font-sans transition-colors duration-300">
                      <header className="bg-white dark:bg-gray-800 shadow p-4 flex justify-between items-center">
                          <h1 className="text-xl font-bold text-gray-900 dark:text-white">Your Performance Dashboard</h1>
                           <div className="flex items-center gap-4">
                               <ThemeToggleButton />
                               <button onClick={() => auth.signOut()} title="Log Out" className="text-gray-500 hover:text-red-500 flex items-center gap-2">
                                   <LogOutIcon />
                                   <span>Log Out</span>
                               </button>
                           </div>
                      </header>
                      <main className="p-4 md:p-8">
                          <DashboardStats plans={plans} warnings={warnings} />
                          <div className="mb-6">
                            <div className="flex border border-gray-200 dark:border-gray-700 rounded-md">
                                <button onClick={() => setAgentDashboardView('coaching')} className={`w-1/3 p-2 text-sm font-semibold rounded-l-md transition-colors ${agentDashboardView === 'coaching' ? 'bg-purple-600 text-white' : 'bg-transparent text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700'}`}>
                                    Coaching
                                </button>
                                <button onClick={() => setAgentDashboardView('plans')} className={`w-1/3 p-2 text-sm font-semibold border-l border-r border-gray-200 dark:border-gray-700 transition-colors ${agentDashboardView === 'plans' ? 'bg-green-600 text-white' : 'bg-transparent text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700'}`}>
                                    Plans
                                </button>
                                <button onClick={() => setAgentDashboardView('warnings')} className={`w-1/3 p-2 text-sm font-semibold rounded-r-md transition-colors ${agentDashboardView === 'warnings' ? 'bg-yellow-500 text-white' : 'bg-transparent text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-700'}`}>
                                    Warnings
                                </button>
                            </div>
                          </div>
                          <div className="space-y-8">
                              {agentDashboardView === 'coaching' && (
                                  <section>
                                      <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-2xl font-semibold flex items-center gap-2"><MessageSquareIcon /> Your Coaching Sessions</h3>
                                        <div className="flex gap-2">
                                            <select value={selectedMonth} onChange={e => setSelectedMonth(parseInt(e.target.value))} className="p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                {months.map((month, i) => <option key={month} value={i}>{month}</option>)}
                                            </select>
                                            <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                                {years.map(year => <option key={year} value={year}>{year}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    {coachTypes.length > 1 && (
                                        <div className="flex flex-wrap gap-2 mb-4 border-b dark:border-gray-700 pb-4">
                                            {coachTypes.map(type => (
                                                <button 
                                                    key={type}
                                                    onClick={() => setCoachFilter(type)}
                                                    className={`px-3 py-1 text-sm rounded-full transition-colors ${coachFilter === type ? 'bg-purple-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600'}`}
                                                >
                                                    {type}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
                                        {filteredCoachingSessions.length > 0 ? filteredCoachingSessions.map(session => (
                                            <CoachingListItem key={session.id} doc={session} onView={() => openModal('VIEW_COACHING', session)} isAdmin={false} />
                                        )) : <p className="p-4 text-gray-500 dark:text-gray-400">You have no coaching sessions for the selected period.</p>}
                                    </div>
                                  </section>
                              )}
                              {agentDashboardView === 'plans' && (
                                <section>
                                    <h3 className="text-2xl font-semibold flex items-center gap-2 mb-4"><FileTextIcon /> Your Plans</h3>
                                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
                                        {plans.length > 0 ? plans.map(plan => (
                                            <DocumentListItem key={plan.id} doc={plan} type="plan" onView={() => openModal('VIEW_PLAN', plan)} isAdmin={false} />
                                        )) : <p className="p-4 text-gray-500 dark:text-gray-400">You have no performance plans on record.</p>}
                                    </div>
                                </section>
                              )}
                              {agentDashboardView === 'warnings' && (
                                <section>
                                    <h3 className="text-2xl font-semibold flex items-center gap-2 mb-4"><AlertTriangleIcon /> Your Warnings</h3>
                                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
                                        {warnings.length > 0 ? warnings.map(warning => (
                                            <DocumentListItem key={warning.id} doc={warning} type="warning" onView={() => openModal('VIEW_WARNING', warning)} isAdmin={false} />
                                        )) : <p className="p-4 text-gray-500 dark:text-gray-400">You have no warnings on record.</p>}
                                    </div>
                                </section>
                              )}
                          </div>
                      </main>
                      {modal.isOpen && (
                          <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
                              <div className={`bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] relative flex flex-col`}>
                                  <div className="flex-shrink-0 flex justify-between items-center p-4 border-b dark:border-gray-700">
                                      <h3 className="text-xl font-semibold">{
                                          modal.type === 'VIEW_PLAN' ? 'Viewing Plan' :
                                          modal.type === 'VIEW_WARNING' ? 'Viewing Warning' :
                                          modal.type === 'VIEW_COACHING' ? `Viewing Session: ${new Date(modal.data.date).toLocaleDateString()}` :
                                          'Viewing Document'
                                      }</h3>
                                      <button onClick={closeModal} className="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200"><XIcon /></button>
                                  </div>
                                  <div className="p-6 overflow-y-auto flex-grow">
                                      {(modal.type === 'VIEW_PLAN' || modal.type === 'VIEW_WARNING') && <DocumentViewer data={modal.data} type={modal.type.split('_')[1].toLowerCase()} agent={agentData} isAdmin={false} user={user} />}
                                      {modal.type === 'VIEW_COACHING' && <CoachingViewer data={modal.data} />}
                                  </div>
                              </div>
                          </div>
                      )}
                 </div>
            );
        }
        
        // --- Shared Components ---

        const CoachingSectionForAdmin = ({ user, coachingSessions, coachFilter, setCoachFilter, openModal, handleDelete }) => {
            const coachTypes = useMemo(() => ['All', ...new Set(coachingSessions.map(s => s.coachType).filter(Boolean))], [coachingSessions]);
            
            const filteredCoachingSessions = useMemo(() => {
                if (coachFilter === 'All') return coachingSessions;
                return coachingSessions.filter(s => s.coachType === coachFilter);
            }, [coachFilter, coachingSessions]);

            return (
                <section>
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-2xl font-semibold flex items-center gap-2"><MessageSquareIcon /> Coaching Sessions</h3>
                        <button onClick={() => openModal('EDIT_COACHING')} className="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2">
                            <PlusCircleIcon /> Create Session
                        </button>
                    </div>
                    
                    {coachTypes.length > 1 && (
                        <div className="flex flex-wrap gap-2 mb-4 border-b dark:border-gray-700 pb-4">
                            {coachTypes.map(type => (
                                <button 
                                    key={type}
                                    onClick={() => setCoachFilter(type)}
                                    className={`px-3 py-1 text-sm rounded-full transition-colors ${coachFilter === type ? 'bg-purple-600 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600'}`}
                                >
                                    {type}
                                </button>
                            ))}
                        </div>
                    )}

                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow">
                        {filteredCoachingSessions.length > 0 ? filteredCoachingSessions.map(session => (
                            <CoachingListItem key={session.id} doc={session} onEdit={() => openModal('EDIT_COACHING', session)} onView={() => openModal('VIEW_COACHING', session)} onDelete={() => handleDelete('coaching', session.id)} isAdmin={true} user={user} />
                        )) : <p className="text-gray-500 dark:text-gray-400 p-4">No coaching sessions match the current filter.</p>}
                    </div>
                </section>
            );
        };
        
        const ThemeToggleButton = () => {
            const { theme, toggleTheme } = useTheme();
            return (
                <button onClick={toggleTheme} className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600">
                    {theme === 'dark' ? <SunIcon /> : <MoonIcon />}
                </button>
            );
        };

        const AdminDashboard = ({ agents, setSelectedAgent, setView, setAgentDetailView, selectedMonth, setSelectedMonth, selectedYear, setSelectedYear }) => {
            const [allPlans, setAllPlans] = useState([]);
            const [allWarnings, setAllWarnings] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filterType, setFilterType] = useState('active');
            const [allCoaching, setAllCoaching] = useState([]);
            const [coachPerformance, setCoachPerformance] = useState([]);

            useEffect(() => {
                if (!agents.length) {
                    setLoading(false);
                    setAllPlans([]);
                    setAllWarnings([]);
                    setAllCoaching([]);
                    return;
                }

                setLoading(true);
                const plansPromises = agents.map(agent => db.collection(`agents/${agent.id}/plans`).get().then(snap => snap.docs.map(doc => ({ ...doc.data(), id: doc.id, agentId: agent.id, agentName: agent.name }))));
                const warningsPromises = agents.map(agent => db.collection(`agents/${agent.id}/warnings`).get().then(snap => snap.docs.map(doc => ({ ...doc.data(), id: doc.id, agentId: agent.id, agentName: agent.name }))));
                const coachingPromises = agents.map(agent => db.collection(`agents/${agent.id}/coaching`).get().then(snap => snap.docs.map(doc => ({ ...doc.data(), id: doc.id, agentId: agent.id, agentName: agent.name }))));

                Promise.all([Promise.all(plansPromises), Promise.all(warningsPromises), Promise.all(coachingPromises)])
                    .then(([plansArrays, warningsArrays, coachingArrays]) => {
                        setAllPlans(plansArrays.flat());
                        setAllWarnings(warningsArrays.flat());
                        setAllCoaching(coachingArrays.flat());
                        setLoading(false);
                    })
                    .catch(error => {
                        console.error("Error fetching all agent data:", error);
                        setLoading(false);
                    });
            }, [agents]);
            
            const filteredDataForStats = useMemo(() => {
                const yearFilter = (item) => new Date(item.date || item.startDate).getFullYear() === selectedYear;
                const monthFilter = (item) => new Date(item.date || item.startDate).getMonth() === selectedMonth;

                const plansForYear = allPlans.filter(yearFilter);
                const warningsForYear = allWarnings.filter(yearFilter);

                if (selectedMonth === -1) { // "All Months" selected
                    return {
                        plans: plansForYear,
                        warnings: warningsForYear
                    };
                }
                
                return {
                    plans: plansForYear.filter(monthFilter),
                    warnings: warningsForYear.filter(monthFilter)
                };

            }, [allPlans, allWarnings, selectedMonth, selectedYear]);
            
            useEffect(() => {
                const performance = {};
                const dataToProcess = selectedMonth === -1 
                    ? allCoaching.filter(c => new Date(c.date).getFullYear() === selectedYear)
                    : allCoaching.filter(session => {
                        const sessionDate = new Date(session.date);
                        return sessionDate.getMonth() === selectedMonth && sessionDate.getFullYear() === selectedYear;
                    });

                dataToProcess.forEach(session => {
                    const coach = session.lastModifiedBy || session.createdBy;
                    if (!coach) return;
                    if (!performance[coach]) {
                        performance[coach] = { total: 0, '1-to-1': 0, 'QA Coaching': 0, 'Feedback': 0 };
                    }
                    performance[coach].total++;
                    if (performance[coach][session.sessionType] !== undefined) {
                        performance[coach][session.sessionType]++;
                    }
                });
                setCoachPerformance(Object.entries(performance).map(([coach, data]) => ({ coach, ...data })));
            }, [allCoaching, selectedMonth, selectedYear]);

            const { totalPlans, passedPlans, failedPlans, activePlans, totalWarnings } = useMemo(() => {
                const plans = filteredDataForStats.plans;
                const warnings = filteredDataForStats.warnings;
                return {
                    totalPlans: plans.length,
                    passedPlans: plans.filter(p => p.status === 'Passed').length,
                    failedPlans: plans.filter(p => p.status === 'Failed').length,
                    activePlans: plans.filter(p => p.status === 'Active').length,
                    totalWarnings: warnings.length
                };
            }, [filteredDataForStats]);

            const goToAgent = (item, viewType) => {
                const agent = agents.find(a => a.id === item.agentId);
                if (agent) {
                    const itemDate = new Date(item.date || item.startDate);
                    setSelectedMonth(itemDate.getMonth());
                    setSelectedYear(itemDate.getFullYear());

                    setSelectedAgent(agent);
                    setAgentDetailView(viewType);
                    setView('tracker');
                }
            };
            
            const { title, items: allItemsOfFilterType } = useMemo(() => {
                switch (filterType) {
                    case 'total': return { title: 'All Plans', items: allPlans };
                    case 'passed': return { title: 'Passed Plans', items: allPlans.filter(p => p.status === 'Passed') };
                    case 'failed': return { title: 'Failed Plans', items: allPlans.filter(p => p.status === 'Failed') };
                    case 'warnings': return { title: 'All Warnings', items: allWarnings };
                    case 'active':
                    default: return { title: 'Active Plans', items: allPlans.filter(p => p.status === 'Active') };
                }
            }, [filterType, allPlans, allWarnings]);

            const items = useMemo(() => {
                const yearFilter = (item) => new Date(item.date || item.startDate).getFullYear() === selectedYear;
                const monthFilter = (item) => new Date(item.date || item.startDate).getMonth() === selectedMonth;
                
                const forYear = allItemsOfFilterType.filter(yearFilter);
                if(selectedMonth === -1) return forYear;
                return forYear.filter(monthFilter);

            }, [allItemsOfFilterType, selectedMonth, selectedYear]);


            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const years = [...new Set(allCoaching.concat(allPlans, allWarnings).map(s => {
                const date = s.date || s.startDate;
                return date ? new Date(date).getFullYear() : null;
            }).filter(Boolean))].sort((a,b) => b-a);

            return (
                <div>
                    <h2 className="text-3xl font-bold text-gray-900 dark:text-white mb-6">Admin Dashboard</h2>
                     <div className="flex justify-end items-center gap-2 mb-4">
                        <span className="text-sm font-medium text-gray-600 dark:text-gray-400">Filter by period:</span>
                        <select value={selectedMonth} onChange={e => setSelectedMonth(parseInt(e.target.value))} className="p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                            <option value={-1}>All Months</option>
                            {months.map((month, i) => <option key={month} value={i}>{month}</option>)}
                        </select>
                        <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                            {years.map(year => <option key={year} value={year}>{year}</option>)}
                        </select>
                    </div>
                    <div className="mb-8">
                        {loading ? <p>Loading stats...</p> :
                        <section className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                            <StatCard title="Total Plans" value={totalPlans} icon={<FileTextIcon />} colorClass="text-gray-500" onClick={() => setFilterType('total')} isActive={filterType === 'total'} />
                            <StatCard title="Passed Plans" value={passedPlans} icon={<CheckCircleIcon />} colorClass="text-green-500" onClick={() => setFilterType('passed')} isActive={filterType === 'passed'} />
                            <StatCard title="Failed Plans" value={failedPlans} icon={<XIcon />} colorClass="text-red-500" onClick={() => setFilterType('failed')} isActive={filterType === 'failed'} />
                            <StatCard title="Active Plans" value={activePlans} icon={<FileTextIcon />} colorClass="text-blue-500" onClick={() => setFilterType('active')} isActive={filterType === 'active'} />
                            <StatCard title="Total Warnings" value={totalWarnings} icon={<AlertTriangleIcon />} colorClass="text-yellow-500" onClick={() => setFilterType('warnings')} isActive={filterType === 'warnings'} />
                        </section>
                        }
                    </div>

                    <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-semibold">{title}</h3>
                        </div>
                        
                        {loading ? <p>Loading data...</p> : 
                            items.length === 0 ? <p className="text-center text-gray-500 dark:text-gray-400">No items match the criteria for the selected period.</p> :
                            <div className="space-y-2">
                                {items.sort((a,b) => new Date(b.date || b.endDate || 0) - new Date(a.date || a.endDate || 0)).map(item => (
                                    filterType === 'warnings' ? (
                                        <div key={item.id} onClick={() => goToAgent(item, 'warnings')} className="p-4 border dark:border-gray-700 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                            <p className="font-bold">{item.agentName}</p>
                                            <p className="text-sm truncate">{item.type}: {item.summaryOfConcerns || 'No summary'}</p>
                                            <p className="text-xs text-gray-500 dark:text-gray-400">Date: {new Date(item.date).toLocaleDateString()}</p>
                                        </div>
                                    ) : (
                                        <div key={item.id} onClick={() => goToAgent(item, 'plans')} className="p-4 border dark:border-gray-700 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer">
                                            <p className="font-bold">{item.agentName}</p>
                                            <p className="text-sm">{item.type}: {item.areasOfFocus && item.areasOfFocus[0] ? item.areasOfFocus[0].title : 'General Plan'}</p>
                                            <p className="text-xs text-gray-500 dark:text-gray-400">Ends: {item.endDate ? new Date(item.endDate).toLocaleDateString() : 'N/A'}</p>
                                        </div>
                                    )
                                ))}
                            </div>
                        }
                    </div>
                    
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-semibold">Coach Performance</h3>
                        </div>
                        {loading ? <p>Loading performance data...</p> :
                            coachPerformance.length > 0 ? (
                                <table className="w-full text-left table-auto">
                                    <thead>
                                        <tr className="border-b dark:border-gray-600">
                                            <th className="pb-2">Coach</th>
                                            <th className="pb-2 text-center">1-to-1</th>
                                            <th className="pb-2 text-center">QA Coaching</th>
                                            <th className="pb-2 text-center">Feedback</th>
                                            <th className="pb-2 text-center font-bold">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {coachPerformance.map(perf => (
                                            <tr key={perf.coach} className="border-b dark:border-gray-700">
                                                <td className="py-2 font-semibold">{perf.coach}</td>
                                                <td className="py-2 text-center">{perf['1-to-1']}</td>
                                                <td className="py-2 text-center">{perf['QA Coaching']}</td>
                                                <td className="py-2 text-center">{perf['Feedback']}</td>
                                                <td className="py-2 text-center font-bold">{perf.total}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            ) : <p className="text-center text-gray-500 dark:text-gray-400">No coaching sessions found for the selected period.</p>
                        }
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, icon, colorClass, onClick, isActive }) => {
            const activeClass = isActive ? 'ring-2 ring-blue-500 shadow-lg' : 'shadow';
            return (
                <button onClick={onClick} className={`bg-white dark:bg-gray-800 p-6 rounded-lg flex items-center gap-4 w-full text-left transition-all hover:shadow-xl ${activeClass}`}>
                    <div className={`text-3xl ${colorClass}`}>{icon}</div>
                    <div>
                        <p className="text-4xl font-bold text-gray-800 dark:text-gray-100">{value}</p>
                        <p className="text-sm font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">{title}</p>
                    </div>
                </button>
            );
        };
        const DashboardStats = ({ plans, warnings }) => {
            const activePlans = plans.filter(p => p.status === 'Active').length;
            const totalWarnings = warnings.length;
            const passedPlans = plans.filter(p => p.status === 'Passed').length;

            return (
                <section className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <StatCard title="Active Plans" value={activePlans} icon={<FileTextIcon />} colorClass="text-blue-500" />
                    <StatCard title="Total Warnings" value={totalWarnings} icon={<AlertTriangleIcon />} colorClass="text-yellow-500" />
                    <StatCard title="Passed Plans" value={passedPlans} icon={<CheckCircleIcon />} colorClass="text-green-500" />
                </section>
            );
        };
        const DocumentListItem = ({ doc, type, onView, onEdit, onDelete, selectedAgent, getPlansPath, isAdmin }) => {
            const statusColor = { Active: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300', Completed: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300', Passed: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300', Failed: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300', Extended: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' };
            const handleUpdatePlanStatus = (planId, status) => { if (!db || !selectedAgent) return; db.collection(getPlansPath(selectedAgent.id)).doc(planId).update({ status }); };

            if (type === 'warning') {
                return (
                       <div className="flex items-center justify-between p-4 border-b dark:border-gray-700 last:border-b-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                           <div className="flex-1 overflow-hidden"><p className="text-xs font-bold uppercase text-yellow-500">{doc.type}</p><p className="font-semibold text-gray-800 dark:text-gray-200 truncate">{doc.summaryOfConcerns || 'No summary'}</p></div>
                           <div className="flex items-center gap-2 flex-shrink-0"><button onClick={onView} className="p-2 text-gray-500 hover:text-blue-600"><EyeIcon /></button>{isAdmin && <><button onClick={onEdit} className="p-2 text-gray-500 hover:text-green-600"><EditIcon /></button><button onClick={onDelete} className="p-2 text-gray-500 hover:text-red-600"><TrashIcon /></button></>}</div>
                       </div>
                );
            }
            
            const title = (doc.areasOfFocus && doc.areasOfFocus[0] ? doc.areasOfFocus[0].title : 'PIP/QIP');
            return (
                <div className="flex items-center justify-between p-4 border-b dark:border-gray-700 last:border-b-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <div className="flex-1 overflow-hidden"><p className="text-xs font-bold uppercase text-indigo-500">{doc.type}</p><p className="font-semibold text-gray-800 dark:text-gray-200 truncate">{title}</p><p className="text-sm text-gray-500">{doc.startDate ? `Start: ${new Date(doc.startDate).toLocaleDateString()} | End: ${new Date(doc.endDate).toLocaleDateString()}` : ''}</p></div>
                    {isAdmin ? <select value={doc.status} onChange={(e) => handleUpdatePlanStatus(doc.id, e.target.value)} className={`appearance-none flex-shrink-0 text-xs p-1 rounded-md border-none mx-4 ${statusColor[doc.status]} dark:bg-gray-700 dark:text-gray-200`}><option>Active</option><option>Passed</option><option>Failed</option><option>Extended</option><option>Completed</option></select> : <span className={`flex-shrink-0 text-xs font-bold px-2 py-1 rounded-full mx-4 ${statusColor[doc.status]}`}>{doc.status}</span>}
                    <div className="flex items-center gap-2 flex-shrink-0"><button onClick={onView} className="p-2 text-gray-500 hover:text-blue-600"><EyeIcon /></button>{isAdmin && <><button onClick={onEdit} className="p-2 text-gray-500 hover:text-green-600"><EditIcon /></button><button onClick={onDelete} className="p-2 text-gray-500 hover:text-red-600"><TrashIcon /></button></>}</div>
                </div>
            );
        };
        const CoachingListItem = ({ doc, onView, onEdit, onDelete, isAdmin, user }) => {
            const isOwner = user && user.email === doc.createdBy;
            return (
                <div className="flex items-center justify-between p-4 border-b dark:border-gray-700 last:border-b-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <div className="flex-1 overflow-hidden">
                        <p className="text-xs font-bold uppercase text-purple-500">{doc.coachType} - {doc.sessionType}</p>
                        <p className="font-semibold text-gray-800 dark:text-gray-200 truncate">Session on {new Date(doc.date).toLocaleDateString()}</p>
                        <p className="text-xs text-gray-500">By: {doc.lastModifiedBy || doc.createdBy || 'N/A'}</p>
                    </div>
                    <div className="flex items-center gap-2 flex-shrink-0">
                        <button onClick={onView} className="p-2 text-gray-500 hover:text-blue-600"><EyeIcon /></button>
                        {isAdmin && isOwner && (
                            <>
                                <button onClick={onEdit} className="p-2 text-gray-500 hover:text-green-600"><EditIcon /></button>
                                <button onClick={onDelete} className="p-2 text-gray-500 hover:text-red-600"><TrashIcon /></button>
                            </>
                        )}
                    </div>
                </div>
            );
        };
        const DocumentViewer = ({ data, type, agent, user, isAdmin }) => {
            const [coachingNotes, setCoachingNotes] = useState([]);
            const [newNote, setNewNote] = useState("");
            const [noteType, setNoteType] = useState('Note'); // 'Note', 'Bullets', 'Email'
            const [noteSubject, setNoteSubject] = useState("");
            const [bulletPoints, setBulletPoints] = useState([""]);
            const [agentSignName, setAgentSignName] = useState("");
            const [leaderSignName, setLeaderSignName] = useState("");
            const docRef = agent && data?.id ? db.collection(`agents/${agent.id}/${type}s`).doc(data.id) : null;
             const [copySuccess, setCopySuccess] = useState('');

            useEffect(() => {
                if(type !== 'plan' || !docRef) return;
                 const unsubscribe = docRef.collection('coachingNotes').orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                     setCoachingNotes(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()})));
                 });
                 return () => unsubscribe();
            }, [data, type, agent]);
            
            const handleAddBulletPoint = () => setBulletPoints([...bulletPoints, ""]);
            const handleBulletPointChange = (index, value) => {
                const newPoints = [...bulletPoints];
                newPoints[index] = value;
                setBulletPoints(newPoints);
            };

            const handleAddCoachingNote = async (e) => {
                e.preventDefault();
                if(type !== 'plan' || !docRef) return;
                let content;
                switch (noteType) {
                    case 'Bullets':
                        content = bulletPoints.filter(pt => pt.trim() !== "");
                        if (content.length === 0) return;
                        break;
                    case 'Email':
                        if (!noteSubject.trim() || !newNote.trim()) return;
                        content = { subject: noteSubject, body: newNote };
                        break;
                    default: // Note
                        if (!newNote.trim()) return;
                        content = newNote;
                }

                await docRef.collection('coachingNotes').add({
                    type: noteType,
                    content,
                    author: user.email,
                    createdAt: new Date().toISOString()
                });
                setNewNote("");
                setNoteSubject("");
                setBulletPoints([""]);
            };

            const handleSign = async (role) => {
                if(!docRef) return;
                const name = role === 'agent' ? agentSignName : leaderSignName;
                if(!name.trim()) return;

                const signatureData = {
                    name: name,
                    date: new Date().toISOString()
                };

                if(role === 'agent') {
                    await docRef.update({ agentSignature: signatureData });
                } else {
                    await docRef.update({ leaderSignature: signatureData });
                }
            };

             const richTextToPlain = (html) => {
                const tempDiv = document.createElement('div');
                if (!html) return '';
                tempDiv.innerHTML = html;
                tempDiv.querySelectorAll('li').forEach(li => {
                    li.textContent = ` ${li.textContent}\n`;
                });
                return tempDiv.textContent || tempDiv.innerText || '';
            };
            
            const handleCopy = () => {
                let textToCopy = '';
                if (type === 'plan') {
                    const actionPlanText = Array.isArray(data.actionPlan)
                        ? (data.actionPlan || []).map(task => `     - [${task.completed ? 'x' : ' '}] ${task.text}`).join('\n')
                        : `   ${richTextToPlain(data.actionPlan)}`;

                    textToCopy = `
Performance Improvement Plan (${data.type})
-----------------------------------
Employee: ${agent.name}
Manager: ${data.managerName}
Start Date: ${new Date(data.startDate).toLocaleDateString()}
End Date: ${new Date(data.endDate).toLocaleDateString()}

--- INTRODUCTION ---
${richTextToPlain(data.introduction)}

--- EMPOWERMENT STATEMENT ---
${richTextToPlain(data.empowermentStatement)}

--- AREAS OF FOCUS ---
${(data.areasOfFocus || []).map((area, i) => `
${i + 1}. ${area.title}
   - Expectation: ${richTextToPlain(area.expectation)}
   - Action Plan:
${actionPlanText}
   - Goal: ${area.goal}
`).join('\n')}

--- SUPPORT PLAN ---
${richTextToPlain(data.supportPlan)}

--- CONSEQUENCES ---
${richTextToPlain(data.consequences)}
`;
                } else if (type === 'warning') {
                     textToCopy = `
Warning (${data.type})
-----------------------------------
Employee: ${agent.name}
Manager: ${data.manager}
Date: ${new Date(data.date).toLocaleDateString()}

--- SUMMARY ---
${richTextToPlain(data.summaryOfConcerns)}

--- ACTION PLAN ---
${richTextToPlain(data.improvementActionPlan)}

--- NEXT ACTION ---
${richTextToPlain(data.nextAction)}
`;
                }

                const textArea = document.createElement("textarea");
                textArea.value = textToCopy.trim();
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopySuccess('Copied!');
                } catch (err) {
                    setCopySuccess('Failed to copy.');
                }
                document.body.removeChild(textArea);
                setTimeout(() => setCopySuccess(''), 2000);
            };
            
            const renderField = (label, value) => ( <div className="flex flex-col sm:flex-row mb-2"><p className="w-full sm:w-1/4 font-semibold text-gray-600 dark:text-gray-400">{label}:</p><p className="w-full sm:w-3/4 text-gray-800 dark:text-gray-200">{value}</p></div> );
            const renderSection = (title, content) => ( 
                <div className="mt-6">
                    <h4 className="text-lg font-bold border-b dark:border-gray-600 pb-1 mb-2 text-gray-800 dark:text-gray-200">{title}</h4>
                    <div 
                        className="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300" 
                        dangerouslySetInnerHTML={{ __html: content || 'N/A' }} 
                    />
                </div>
            );
            
            const renderNoteContent = (note) => {
                switch(note.type) {
                    case 'Email':
                        return <div><p className="font-bold">{note.content.subject}</p><div className="prose dark:prose-invert max-w-none" dangerouslySetInnerHTML={{__html: note.content.body}} /></div>;
                    case 'Bullets':
                        return <ul className="list-disc list-inside">{note.content.map((pt, i) => <li key={i}>{pt}</li>)}</ul>;
                    case 'Note':
                    default:
                        return <div className="prose dark:prose-invert max-w-none" dangerouslySetInnerHTML={{__html: note.content}} />;
                }
            };
            
            return (
                 <div>
                      <div id="printable-document">
                          <h2 className="text-2xl font-bold text-center text-gray-800 dark:text-gray-200">{type === 'plan' ? `Plan (${data.type})` : 'Warning'}</h2>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6 text-sm">
                              {renderField("Employee Name", agent.name)}
                              {renderField("Date", new Date(data.date || data.startDate).toLocaleDateString())}
                              {renderField("Manager", data.managerName || data.manager)}
                              {type === 'plan' ? renderField("End Date", new Date(data.endDate).toLocaleDateString()) : renderField("Warning Type", data.type)}
                          </div>
                          
                          {type === 'warning' && ( <> 
                              {renderSection("Summary", data.summaryOfConcerns)} 
                              {renderSection("Action Plan", data.improvementActionPlan)} 
                              {renderSection("Next Action", data.nextAction)} 
                          </> )}
                          
                          {type === 'plan' && ( <> 
                              {renderSection("Introduction", data.introduction)} 
                              {renderSection("Empowerment", data.empowermentStatement)} 
                              <div className="mt-6"><h4 className="text-lg font-bold border-b dark:border-gray-600 pb-1 mb-2">Areas of Focus</h4>{data.areasOfFocus?.map((area, index) => ( 
                                  <div key={index} className="mb-4 p-2 border-l-2 border-blue-500 pl-4">
                                      <h5 className="font-bold text-gray-800 dark:text-gray-200">{index + 1}. {area.title}</h5>
                                      <div className="mt-2"><strong className="text-gray-600 dark:text-gray-400 block mb-1">Expectation:</strong> <div className="prose dark:prose-invert max-w-none" dangerouslySetInnerHTML={{ __html: area.expectation || ''}} /></div>
                                      <div className="mt-2"><strong className="text-gray-600 dark:text-gray-400 block mb-1">Action Plan:</strong>
                                           {Array.isArray(area.actionPlan) ? (
                                                <div className="space-y-1 mt-1">
                                                    {(area.actionPlan || []).map((task, taskIndex) => (
                                                        <div key={taskIndex} className={`flex items-center ${task.completed ? 'line-through text-gray-500' : ''}`}>
                                                             {task.completed ? <CheckCircleIcon /> : <CheckboxIcon />}
                                                             <span className="ml-2">{task.text}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                           ) : (
                                                <div className="prose dark:prose-invert max-w-none" dangerouslySetInnerHTML={{ __html: area.actionPlan || ''}} />
                                           )}
                                      </div>
                                      <p className="text-gray-700 dark:text-gray-300 mt-2"><span className="font-semibold">Goal:</span> {area.goal}</p>
                                  </div> 
                              ))}</div> 
                              {renderSection("Support Plan", data.supportPlan)} 
                              {renderSection("Consequences", data.consequences)} 
                              <div className="mt-6"><h4 className="text-lg font-bold border-b dark:border-gray-600 pb-1 mb-2">QA Targets</h4><table className="w-full text-left table-auto"><thead><tr className="border-b dark:border-gray-600"><th className="pb-2">Week</th><th className="pb-2">Required</th><th className="pb-2">Achieved</th></tr></thead><tbody>{data.qaTargets?.map((target, index) => ( <tr key={index} className="border-b dark:border-gray-700"><td className="py-2">{target.week}</td><td className="py-2">{target.required}</td><td className="py-2">{target.achieved}</td></tr> ))}</tbody></table></div> 
                          </> )}
                          
                          {type === 'plan' && (
                              <div className="mt-6 no-print">
                                  <h4 className="text-lg font-bold border-b dark:border-gray-600 pb-1 mb-2">Coaching Notes</h4>
                                  {isAdmin && (
                                      <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg mb-4">
                                          <div className="flex gap-2 mb-2">
                                              <button onClick={() => setNoteType('Note')} className={`px-3 py-1 text-sm rounded-md ${noteType === 'Note' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-600'}`}>Note</button>
                                              <button onClick={() => setNoteType('Bullets')} className={`px-3 py-1 text-sm rounded-md ${noteType === 'Bullets' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-600'}`}>Points</button>
                                              <button onClick={() => setNoteType('Email')} className={`px-3 py-1 text-sm rounded-md ${noteType === 'Email' ? 'bg-blue-600 text-white' : 'bg-gray-200 dark:bg-gray-600'}`}>Email</button>
                                          </div>
                                          <form onSubmit={handleAddCoachingNote}>
                                              {noteType === 'Email' && <FormInput label="Subject" value={noteSubject} onChange={e => setNoteSubject(e.target.value)} className="mb-2" />}
                                              {noteType === 'Bullets' ? (
                                                   <div className="space-y-2">
                                                       {bulletPoints.map((point, index) => (
                                                           <input key={index} type="text" value={point} onChange={e => handleBulletPointChange(index, e.target.value)} className="w-full p-2 border rounded-md bg-white dark:bg-gray-800" placeholder={`Point ${index + 1}`}/>
                                                       ))}
                                                       <button type="button" onClick={handleAddBulletPoint} className="text-sm text-blue-600">+ Add Point</button>
                                                   </div>
                                              ) : (
                                               <RichTextInput label={noteType === 'Email' ? 'Body' : 'Add new note'} value={newNote} onChange={setNewNote} />
                                              )}
                                              <button type="submit" className="mt-2 py-2 px-4 bg-blue-600 text-white rounded-md">Add Note</button>
                                          </form>
                                      </div>
                                  )}
                                   {coachingNotes.length > 0 ? (
                                      <div className="space-y-3">
                                          {coachingNotes.map(note => (
                                              <div key={note.id} className="p-3 bg-gray-50 dark:bg-gray-700 rounded-md">
                                                  <div className="text-sm text-gray-800 dark:text-gray-200">{renderNoteContent(note)}</div>
                                                  <p className="text-xs text-gray-500 dark:text-gray-400 text-right">-{note.author} on {new Date(note.createdAt).toLocaleString()}</p>
                                              </div>
                                          ))}
                                      </div>
                                   ) : <p className="text-gray-500 dark:text-gray-400">No coaching notes yet.</p>}
                              </div>
                          )}

                          <div className="flex justify-between mt-16 pt-8 border-t dark:border-gray-600">
                               <div>
                                   <p>Employee's Signature</p>
                                   {data.agentSignature ? (
                                       <div className="mt-2">
                                           <p className="font-semibold text-lg">{data.agentSignature.name}</p>
                                           <p className="text-xs text-gray-500">Signed on {new Date(data.agentSignature.date).toLocaleString()}</p>
                                       </div>
                                   ) : !isAdmin ? (
                                       <div className="flex gap-2 items-center mt-2">
                                           <FormInput placeholder="Type your full name" value={agentSignName} onChange={e => setAgentSignName(e.target.value)} />
                                           <button onClick={() => handleSign('agent')} className="py-2 px-4 bg-green-600 text-white rounded-md">Sign</button>
                                       </div>
                                   ) : <p className="mt-8">____________________</p>}
                               </div>
                               <div>
                                   <p>Leader's Signature</p>
                                   {data.leaderSignature ? (
                                        <div className="mt-2 text-right">
                                           <p className="font-semibold text-lg">{data.leaderSignature.name}</p>
                                           <p className="text-xs text-gray-500">Signed on {new Date(data.leaderSignature.date).toLocaleString()}</p>
                                       </div>
                                   ) : isAdmin ? (
                                       <div className="flex gap-2 items-center mt-2">
                                           <FormInput placeholder="Type your full name" value={leaderSignName} onChange={e => setLeaderSignName(e.target.value)} />
                                           <button onClick={() => handleSign('leader')} className="py-2 px-4 bg-green-600 text-white rounded-md">Sign</button>
                                       </div>
                                   ) : <p className="mt-8">____________________</p>}
                               </div>
                          </div>
                      </div>
                       <div className="flex justify-end mt-6 pt-4 border-t dark:border-gray-700">
                           <button onClick={handleCopy} className="flex items-center gap-2 py-2 px-4 rounded-md bg-blue-600 text-white hover:bg-blue-700">
                               <ClipboardIcon /> {copySuccess || 'Copy Content'}
                           </button>
                       </div>
                 </div>
            );
        };
        const CoachingViewer = ({ data }) => {
            const [copySuccess, setCopySuccess] = useState('');

            const handleCopy = () => {
                // Create a temporary element to render the HTML content to plain text
                const tempDiv = document.createElement('div');
                
                const richTextToPlain = (html) => {
                    if (!html) return '';
                    tempDiv.innerHTML = html;
                    // Replace list items with bullet points
                    tempDiv.querySelectorAll('li').forEach(li => {
                        li.textContent = ` ${li.textContent}\n`;
                    });
                    return tempDiv.textContent || tempDiv.innerText || '';
                };
                
                let textToCopy = '';

                if (data.sessionType === 'Feedback') {
                    textToCopy = `
Coaching Session (Feedback): ${new Date(data.date).toLocaleDateString()}
Coach: ${data.lastModifiedBy || data.createdBy || 'N/A'}

--- CONTEXT ---
${richTextToPlain(data.context)}

--- OBSERVED BEHAVIOR ---
${richTextToPlain(data.observedBehavior)}

--- IMPACT ---
${richTextToPlain(data.impact)}

--- NEXT STEPS ---
${richTextToPlain(data.nextSteps)}
                    `.trim();
                } else {
                    textToCopy = `
Coaching Session: ${new Date(data.date).toLocaleDateString()}
Coach: ${data.lastModifiedBy || data.createdBy || 'N/A'}
Coach Type: ${data.coachType || 'N/A'}
Session Type: ${data.sessionType}

${data.lastWeekPerformance ? `--- LAST WEEK'S PERFORMANCE ---\n${richTextToPlain(data.lastWeekPerformance)}\n` : ''}
--- STRENGTHS ---
${richTextToPlain(data.strengths)}

--- OPPORTUNITIES ---
${richTextToPlain(data.opportunities)}

--- ACTION PLAN ---
${richTextToPlain(data.actionPlan)}

--- NOTES ---
${richTextToPlain(data.notes)}
                    `.trim();
                }

                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopySuccess('Copied!');
                } catch (err) {
                    setCopySuccess('Failed to copy.');
                }
                document.body.removeChild(textArea);
                setTimeout(() => setCopySuccess(''), 2000);
            };

            const renderField = (label, value) => ( <div className="flex flex-col sm:flex-row mb-2"><p className="w-full sm:w-1/4 font-semibold text-gray-600 dark:text-gray-400">{label}:</p><p className="w-full sm:w-3/4 text-gray-800 dark:text-gray-200">{value}</p></div> );
            const renderSection = (title, content) => ( 
                <div className="mt-6">
                    <h4 className="text-lg font-bold border-b dark:border-gray-600 pb-1 mb-2 text-gray-800 dark:text-gray-200">{title}</h4>
                    {/* Render the saved HTML content from the rich text editor */}
                    <div 
                        className="prose dark:prose-invert max-w-none text-gray-700 dark:text-gray-300" 
                        dangerouslySetInnerHTML={{ __html: content || 'N/A' }} 
                    />
                </div>
            );

            return (
                <div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6 text-sm">
                        {renderField("Date", new Date(data.date).toLocaleDateString())}
                        {renderField("Coach Type", data.coachType || 'Not specified')}
                        {renderField("Session Type", data.sessionType)}
                        {renderField("Submitted By", data.lastModifiedBy || data.createdBy || 'N/A')}
                    </div>
                    { data.sessionType === 'Feedback' ? (
                        <>
                            {renderSection("Context", data.context)}
                            {renderSection("Observed Behavior", data.observedBehavior)}
                            {renderSection("Impact", data.impact)}
                            {renderSection("Next Steps", data.nextSteps)}
                        </>
                    ) : (
                         <>
                            {data.lastWeekPerformance && renderSection("Last Week's Performance", data.lastWeekPerformance)}
                            {renderSection("Strengths", data.strengths)}
                            {renderSection("Opportunities", data.opportunities)}
                            {renderSection("Action Plan", data.actionPlan)}
                            {renderSection("Notes", data.notes)}
                        </>
                    )}

                     <div className="flex justify-end mt-6 pt-4 border-t dark:border-gray-700">
                         <button onClick={handleCopy} className="flex items-center gap-2 py-2 px-4 rounded-md bg-blue-600 text-white hover:bg-blue-700">
                             <ClipboardIcon /> {copySuccess || 'Copy Content'}
                         </button>
                     </div>
                </div>
            );
        };
        const FormSection = ({ title, children }) => <div className="space-y-2 p-3 border rounded-md dark:border-gray-600"><h4 className="font-semibold text-gray-700 dark:text-gray-300">{title}</h4>{children}</div>;
        const FormInput = ({ label, ...props }) => <div><label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">{label}</label><input {...props} className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600 text-gray-800 dark:text-gray-200" /></div>;
        
        const RichTextInput = ({ label, value, onChange }) => {
            const editorRef = React.useRef(null);
            
            const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>;

            const handleCommand = (command) => {
                document.execCommand(command, false, null);
                if (editorRef.current) {
                    editorRef.current.focus();
                    onChange(editorRef.current.innerHTML);
                }
            };

            const handleLink = () => {
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                const range = selection.getRangeAt(0);
                const selectedText = range.toString();

                let url = prompt('Enter the URL:', 'https://');
                if (url) {
                    // Restore selection before creating link
                    selection.removeAllRanges();
                    selection.addRange(range);
                    document.execCommand('createLink', false, url);
                    if (editorRef.current) {
                        editorRef.current.focus();
                        onChange(editorRef.current.innerHTML);
                    }
                }
            };

            const handleInput = (e) => {
                onChange(e.target.innerHTML);
            };
            
            const handlePaste = (e) => {
                e.preventDefault();
                let html = (e.clipboardData || window.clipboardData).getData('text/html');

                // If no HTML, fall back to plain text and convert newlines to <br>
                if (!html) {
                    let text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    html = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/(\r\n|\n|\r)/gm, '<br>');
                }

                // Sanitize the HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                // Remove unwanted inline styles and attributes from all elements
                tempDiv.querySelectorAll('*').forEach(el => {
                    el.removeAttribute('class');
                    el.style.backgroundColor = '';
                    el.style.background = '';
                    el.style.color = ''; // Let it inherit color
                    el.style.fontFamily = ''; // Let it inherit font
                    el.style.fontSize = ''; // Let it inherit font size
                    el.style.lineHeight = '';

                    // If the style attribute is now empty, remove it completely
                    if (el.getAttribute('style') === '') {
                        el.removeAttribute('style');
                    }
                });
                
                const sanitizedHtml = tempDiv.innerHTML;
                
                // Use execCommand to insert the sanitized HTML
                document.execCommand('insertHTML', false, sanitizedHtml);
                
                // Trigger the state update
                if(e.currentTarget) {
                   onChange(e.currentTarget.innerHTML);
                }
            };

            useEffect(() => {
                // Only update if the content is actually different, to avoid cursor jumps.
                if (editorRef.current && value !== editorRef.current.innerHTML) {
                    editorRef.current.innerHTML = value || '';
                }
            }, [value]);


            return (
                <div>
                    <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">{label}</label>
                    <div className="w-full border rounded-md bg-white dark:bg-gray-800 dark:border-gray-600">
                        <div className="flex items-center gap-1 p-1 border-b dark:border-gray-700">
                            <button type="button" title="Bold" onMouseDown={e => e.preventDefault()} onClick={() => handleCommand('bold')} className="px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 font-bold">B</button>
                            <button type="button" title="Italic" onMouseDown={e => e.preventDefault()} onClick={() => handleCommand('italic')} className="px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 italic">I</button>
                            <button type="button" title="Underline" onMouseDown={e => e.preventDefault()} onClick={() => handleCommand('underline')} className="px-2 py-1 rounded hover:bg-gray-200 dark:hover:bg-gray-600 underline">U</button>
                            <button type="button" title="Bulleted List" onMouseDown={e => e.preventDefault()} onClick={() => handleCommand('insertUnorderedList')} className="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-600"><ListIcon /></button>
                            <button type="button" title="Link" onMouseDown={e => e.preventDefault()} onClick={handleLink} className="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-600"><LinkIcon /></button>
                        </div>
                        <div
                            ref={editorRef}
                            contentEditable={true}
                            onInput={handleInput}
                            onPaste={handlePaste}
                            className="p-2 min-h-[100px] text-gray-800 dark:text-gray-200 focus:outline-none rich-text-editor"
                        ></div>
                    </div>
                </div>
            );
        };

        const AITools = ({ formType, onPopulate, disabled }) => { const [mode, setMode] = useState(null); const [text, setText] = useState(''); const [isProcessing, setIsProcessing] = useState(false); const [error, setError] = useState(''); const handleProcess = async () => { setIsProcessing(true); setError(''); const apiKey = "AIzaSyAhYDpHKXbTYQeGW3A-3g47XXDMGyB8NU0"; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; let prompt, schema; if (formType === 'plan') { schema = { type: 'OBJECT', properties: { managerName: { type: 'STRING' }, startDate: { type: 'STRING' }, endDate: { type: 'STRING' }, introduction: { type: 'STRING' }, empowermentStatement: { type: 'STRING' }, areasOfFocus: { type: 'ARRAY', items: { type: 'OBJECT', properties: { title: { type: 'STRING' }, expectation: { type: 'STRING' }, actionPlan: { type: 'ARRAY', items: {type: 'OBJECT', properties: {text: {type: 'STRING'}, completed: {type: 'BOOLEAN'}}} }, goal: { type: 'STRING' } } } }, supportPlan: { type: 'STRING' }, consequences: { type: 'STRING' }, qaTargets: { type: 'ARRAY', items: { type: 'OBJECT', properties: { week: { type: 'STRING' }, required: { type: 'STRING' }, achieved: { type: 'STRING' } } } } } }; } else if (formType === 'warning') { schema = { type: 'OBJECT', properties: { manager: { type: 'STRING' }, date: { type: 'STRING' }, summaryOfConcerns: { type: 'STRING' }, improvementActionPlan: { type: 'STRING' }, nextAction: { type: 'STRING' } } }; } else if (formType === 'coaching') { schema = { type: 'OBJECT', properties: { lastWeekPerformance: { type: 'STRING', description: "Summary of agent's performance from the previous week. Format with HTML using <strong> and <ul><li> tags." }, strengths: { type: 'STRING', description: "Positive points and things the agent is doing well. Format with HTML using <strong> and <ul><li> tags." }, opportunities: { type: 'STRING', description: "Areas for improvement and key discussion points. Format with HTML using <strong> and <ul><li> tags." }, actionPlan: { type: 'STRING', description: "A clear, itemized list of next steps for the agent. Format with HTML using <strong> and <ul><li> tags." }, notes: { type: 'STRING', description: "General summary, encouragement, or other notes. Format with HTML using <strong> tags for emphasis." }, context: { type: 'STRING', description: "The context or situation for the feedback. Format with HTML." }, observedBehavior: { type: 'STRING', description: "Specific, observable actions or behaviors. Format with HTML." }, impact: { type: 'STRING', description: "The impact of the observed behavior. Format with HTML." }, nextSteps: { type: 'STRING', description: "Next steps or consequences if behavior repeats. Format with HTML." } } }; } if (mode === 'fill') { prompt = `You are an expert administrative assistant. Analyze the following text and extract the information into a valid JSON object based on the provided schema. The text could be for a regular coaching session (with strengths, opportunities, etc.) or for a structured feedback session (with context, behavior, impact, next steps). Populate only the relevant fields for the type of session described. It is crucial that you identify and convert bullet points, numbered items, and distinct paragraphs into clean, structured HTML using tags like <ul>, <ol>, <li>, <p>, and <strong> for bolding. Retain any hyperlinks found in the original text.\n\nText:\n${text}`; } else { prompt = `You are a professional team leader. Generate a well-structured coaching document based on these notes: "${text}". The output must be a valid JSON object following the schema. Determine if the notes describe a standard coaching session or a structured feedback session and populate only the relevant fields. Format the content with professional and encouraging language. Use HTML to structure the text: use <strong> for emphasis, and use <ul> or <ol> for lists.`; } const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } }; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) throw new Error(`API error: ${response.statusText}`); const result = await response.json(); const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text; if (!jsonText) throw new Error("No content from API."); onPopulate(JSON.parse(jsonText)); setMode(null); } catch (err) { setError(`Failed. ${err.message}`); } finally { setIsProcessing(false); } }; if (!mode) { return <div className="my-4 pt-4 border-t dark:border-gray-700 flex gap-2"><button type="button" onClick={() => setMode('fill')} className="w-full flex items-center justify-center gap-2 text-sm py-2 px-4 rounded-md bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 hover:bg-indigo-200 dark:hover:bg-indigo-800 disabled:opacity-50"><SparklesIcon /> Auto-fill from Text</button><button type="button" onClick={() => setMode('generate')} className="w-full flex items-center justify-center gap-2 text-sm py-2 px-4 rounded-md bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 hover:bg-purple-200 dark:hover:bg-purple-800 disabled:opacity-50"><SparklesIcon /> Generate with AI</button></div>; } return <div className="my-4 pt-4 border-t dark:border-gray-700 space-y-2"><label className="block text-gray-700 dark:text-gray-300">{mode === 'fill' ? 'Paste text:' : 'Describe issue:'}</label>{mode === 'fill' ? <textarea value={text} onChange={e => setText(e.target.value)} rows="8" className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" /> : <input type="text" value={text} onChange={e => setText(e.target.value)} className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" />} {error && <p className="text-sm text-red-500">{error}</p>} <div className="flex justify-end gap-2"><button type="button" onClick={() => setMode(null)} className="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600">Cancel</button><button type="button" onClick={handleProcess} disabled={isProcessing || !text} className="py-2 px-4 rounded-md bg-blue-600 text-white">{isProcessing ? 'Processing...' : 'Go'}</button></div></div>;};
        const AgentForm = ({ onSubmit, onCancel, initialData }) => {
            const [formData, setFormData] = useState({
                name: '',
                employeeId: '',
                email: '',
                team: TEAMS[0],
                ...initialData
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({...prev, [name]: value}));
            };

            const handleSubmit = (e) => { e.preventDefault(); onSubmit(formData); };
            
            return ( <form onSubmit={handleSubmit} className="space-y-4">
                <FormInput label="Agent Name" name="name" type="text" value={formData.name} onChange={handleChange} required />
                <FormInput label="Employee ID" name="employeeId" type="text" value={formData.employeeId} onChange={handleChange} required />
                <FormInput label="Agent's Email" name="email" type="email" value={formData.email} onChange={handleChange} required />
                <div>
                    <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Team</label>
                    <select name="team" value={formData.team} onChange={handleChange} className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                    </select>
                </div>
                <div className="flex justify-end gap-2 pt-4">
                    <button type="button" onClick={onCancel} className="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600">Cancel</button>
                    <button type="submit" className="py-2 px-4 rounded-md bg-blue-600 text-white">{initialData?.id ? 'Save Changes' : 'Add Agent'}</button>
                </div>
            </form> );
        };
        const PlanForm = ({ onSubmit, onCancel, initialData }) => { 
            const getInitialFormData = () => {
                const defaultState = { type: 'PIP', managerName: '', startDate: '', endDate: '', introduction: '', empowermentStatement: '', areasOfFocus: [{ title: '', expectation: '', actionPlan: [{text: '', completed: false}], goal: '' }], supportPlan: '', consequences: '', qaTargets: [{ week: '', required: '', achieved: '' }] };
                if (!initialData) return defaultState;
                const normalizedData = { ...defaultState, ...initialData };
                if (initialData.areasOfFocus) {
                    normalizedData.areasOfFocus = initialData.areasOfFocus.map(area => {
                        if (typeof area.actionPlan === 'string') {
                            return { ...area, actionPlan: [{ text: area.actionPlan, completed: false }] };
                        }
                        if (!Array.isArray(area.actionPlan)) {
                             return { ...area, actionPlan: [{ text: '', completed: false }] };
                        }
                        return area;
                    });
                }
                return normalizedData;
            };
            const [formData, setFormData] = useState(getInitialFormData); 
            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value })); 
            const handleRichTextChange = (name, html) => {
                setFormData(prev => ({...prev, [name]: html}));
            };
            const handleDynamicChange = (index, e, section) => { const list = [...formData[section]]; list[index][e.target.name] = e.target.value; setFormData(p => ({ ...p, [section]: list })); }; 
            
            const handleActionPlanChange = (areaIndex, taskIndex, newText) => {
                const updatedAreas = [...formData.areasOfFocus];
                updatedAreas[areaIndex].actionPlan[taskIndex].text = newText;
                setFormData(prev => ({...prev, areasOfFocus: updatedAreas}));
            };

            const handleActionPlanCheck = (areaIndex, taskIndex, isChecked) => {
                const updatedAreas = [...formData.areasOfFocus];
                updatedAreas[areaIndex].actionPlan[taskIndex].completed = isChecked;
                setFormData(prev => ({...prev, areasOfFocus: updatedAreas}));
            };
             const addActionPlanItem = (areaIndex) => {
                const updatedAreas = [...formData.areasOfFocus];
                if (!updatedAreas[areaIndex].actionPlan) {
                    updatedAreas[areaIndex].actionPlan = [];
                }
                updatedAreas[areaIndex].actionPlan.push({ text: '', completed: false });
                setFormData(prev => ({...prev, areasOfFocus: updatedAreas}));
            };

            const removeActionPlanItem = (areaIndex, taskIndex) => {
                const updatedAreas = [...formData.areasOfFocus];
                updatedAreas[areaIndex].actionPlan.splice(taskIndex, 1);
                setFormData(prev => ({...prev, areasOfFocus: updatedAreas}));
            };

            const addDynamicItem = (section, item) => setFormData(p => ({ ...p, [section]: [...p[section], { ...item, actionPlan: [{text: '', completed: false}] }] })); 
            const removeDynamicItem = (index, section) => { const list = [...formData[section]]; list.splice(index, 1); setFormData(p => ({ ...p, [section]: list })); }; 
            
            return <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
                <AITools formType="plan" onPopulate={(data) => setFormData(p => ({...p, ...data}))} />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormInput label="Manager Name" name="managerName" value={formData.managerName} onChange={handleChange} required />
                    <div><label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Plan Type</label><select name="type" value={formData.type} onChange={handleChange} className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600"><option value="PIP">PIP</option><option value="QIP">QIP</option></select></div>
                    <FormInput label="Start Date" name="startDate" type="date" value={formData.startDate} onChange={handleChange} required />
                    <FormInput label="End Date" name="endDate" type="date" value={formData.endDate} onChange={handleChange} required />
                </div>
                <RichTextInput label="Introduction" value={formData.introduction} onChange={(html) => handleRichTextChange('introduction', html)} />
                <RichTextInput label="Empowerment Statement" value={formData.empowermentStatement} onChange={(html) => handleRichTextChange('empowermentStatement', html)} />
                <FormSection title="Areas of Focus">{formData.areasOfFocus.map((area, index) => ( 
                    <div key={index} className="space-y-3 p-3 border dark:border-gray-700 rounded-md relative">
                        <FormInput label="Focus Title" name="title" value={area.title} onChange={e => handleDynamicChange(index, e, 'areasOfFocus')} />
                        <RichTextInput label="Expectation" value={area.expectation} onChange={(html) => { const list = [...formData.areasOfFocus]; list[index].expectation = html; setFormData(p => ({ ...p, areasOfFocus: list })); }} />
                        
                        <div>
                             <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Action Plan Checkpoints</label>
                             <div className="space-y-2">
                                {(area.actionPlan || []).map((task, taskIndex) => (
                                    <div key={taskIndex} className="flex items-center gap-2">
                                        <input type="checkbox" checked={!!task.completed} onChange={e => handleActionPlanCheck(index, taskIndex, e.target.checked)} className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"/>
                                        <input type="text" value={task.text} onChange={e => handleActionPlanChange(index, taskIndex, e.target.value)} className="w-full p-1 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600" placeholder="Action item..."/>
                                        <button type="button" onClick={() => removeActionPlanItem(index, taskIndex)} className="text-red-500 hover:text-red-700">&times;</button>
                                    </div>
                                ))}
                                <button type="button" onClick={() => addActionPlanItem(index)} className="text-sm text-blue-600 hover:underline">+ Add checkpoint</button>
                             </div>
                        </div>

                        <FormInput label="Goal" name="goal" value={area.goal} onChange={e => handleDynamicChange(index, e, 'areasOfFocus')} />
                        {formData.areasOfFocus.length > 1 && <button type="button" onClick={() => removeDynamicItem(index, 'areasOfFocus')} className="absolute top-1 right-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full p-1 leading-none">&times;</button>}
                    </div> 
                ))}<button type="button" onClick={() => addDynamicItem('areasOfFocus', { title: '', expectation: '', actionPlan: [], goal: '' })} className="text-sm text-blue-600 hover:underline mt-2">+ Add Area</button></FormSection>
                <RichTextInput label="Support Plan" value={formData.supportPlan} onChange={(html) => handleRichTextChange('supportPlan', html)} />
                <RichTextInput label="Consequences" value={formData.consequences} onChange={(html) => handleRichTextChange('consequences', html)} />
                <FormSection title="QA Targets">{formData.qaTargets.map((target, index) => ( <div key={index} className="grid grid-cols-4 gap-2 items-center"><FormInput label="Week" name="week" value={target.week} onChange={e => handleDynamicChange(index, e, 'qaTargets')} /><FormInput label="Required" name="required" value={target.required} onChange={e => handleDynamicChange(index, e, 'qaTargets')} /><FormInput label="Achieved" name="achieved" value={target.achieved} onChange={e => handleDynamicChange(index, e, 'qaTargets')} /><button type="button" onClick={() => removeDynamicItem(index, 'qaTargets')} className="mt-6 text-red-500 hover:bg-red-100 dark:hover:bg-red-900 rounded-full disabled:opacity-50" disabled={formData.qaTargets.length <= 1}>&times;</button></div> ))}<button type="button" onClick={() => addDynamicItem('qaTargets', { week: '', required: '', achieved: '' })} className="text-sm text-blue-600 hover:underline mt-2">+ Add Target</button></FormSection><div className="flex justify-end gap-2 pt-4"><button type="button" onClick={onCancel} className="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600">Cancel</button><button type="submit" className="py-2 px-4 rounded-md bg-green-600 text-white">{initialData?.id ? 'Save Changes' : 'Create Plan'}</button></div>
            </form>
        };
        const WarningForm = ({ onSubmit, onCancel, initialData }) => { 
            const [formData, setFormData] = useState({ type: 'Verbal', manager: '', date: '', summaryOfConcerns: '', improvementActionPlan: '', nextAction: '', ...initialData }); 
            const handleChange = (e) => setFormData(p => ({ ...p, [e.target.name]: e.target.value })); 
            const handleRichTextChange = (name, html) => {
                setFormData(prev => ({...prev, [name]: html}));
            };
            return <form onSubmit={(e) => { e.preventDefault(); onSubmit(formData); }} className="space-y-4">
                <AITools formType="warning" onPopulate={(data) => setFormData(p => ({...p, ...data}))} />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <FormInput label="Manager" name="manager" value={formData.manager} onChange={handleChange} required />
                    <div><label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Warning Type</label><select name="type" value={formData.type} onChange={handleChange} className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600"><option>Verbal</option><option>Written</option><option>Final Written Warning</option></select></div>
                    <FormInput label="Date" name="date" type="date" value={formData.date} onChange={handleChange} required />
                </div>
                <RichTextInput label="Summary" value={formData.summaryOfConcerns} onChange={(html) => handleRichTextChange('summaryOfConcerns', html)} />
                <RichTextInput label="Action Plan" value={formData.improvementActionPlan} onChange={(html) => handleRichTextChange('improvementActionPlan', html)} />
                <RichTextInput label="Next Action" value={formData.nextAction} onChange={(html) => handleRichTextChange('nextAction', html)} />
                <div className="flex justify-end gap-2 pt-4"><button type="button" onClick={onCancel} className="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600">Cancel</button><button type="submit" className="py-2 px-4 rounded-md bg-yellow-500 text-white">{initialData?.id ? 'Save Changes' : 'Create Warning'}</button></div>
            </form>
        };
        const CoachingForm = ({ onSubmit, onCancel, initialData }) => {
            const today = new Date().toISOString().split('T')[0];
            const [formData, setFormData] = useState({
                date: today,
                sessionType: '1-to-1',
                coachType: 'Team Leader',
                lastWeekPerformance: '',
                strengths: '',
                opportunities: '',
                actionPlan: '',
                notes: '',
                context: '',
                observedBehavior: '',
                impact: '',
                nextSteps: '',
                ...initialData
            });

            useEffect(() => {
                if (initialData) return; 
                setFormData(prev => {
                    if (prev.sessionType === 'Feedback') {
                        return {
                            ...prev,
                            lastWeekPerformance: '',
                            strengths: '',
                            opportunities: '',
                            actionPlan: '',
                            notes: ''
                        };
                    } else {
                         return {
                            ...prev,
                            context: '',
                            observedBehavior: '',
                            impact: '',
                            nextSteps: ''
                        };
                    }
                });
            }, [formData.sessionType, initialData]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleRichTextChange = (name, html) => {
                setFormData(prev => ({...prev, [name]: html}));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSubmit(formData);
            };
            
            const handleAiPopulate = (aiData) => {
                setFormData(prev => ({...prev, ...aiData}));
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                     <AITools formType="coaching" onPopulate={handleAiPopulate} />
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <FormInput label="Date" name="date" type="date" value={formData.date} onChange={handleChange} required />
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Coach Type</label>
                            <select name="coachType" value={formData.coachType} onChange={handleChange} className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Session Type</label>
                            <select name="sessionType" value={formData.sessionType} onChange={handleChange} className="w-full p-2 border rounded-md bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                                <option>1-to-1</option>
                                <option>QA Coaching</option>
                                <option>Feedback</option>
                            </select>
                        </div>
                    </div>
                    { (formData.sessionType === '1-to-1' || formData.sessionType === 'QA Coaching') ? (
                        <>
                            <RichTextInput label="Last Week's Performance" value={formData.lastWeekPerformance} onChange={(html) => handleRichTextChange('lastWeekPerformance', html)} />
                            <RichTextInput label="Strengths" value={formData.strengths} onChange={(html) => handleRichTextChange('strengths', html)} />
                            <RichTextInput label="Opportunities" value={formData.opportunities} onChange={(html) => handleRichTextChange('opportunities', html)} />
                            <RichTextInput label="Action Plan" value={formData.actionPlan} onChange={(html) => handleRichTextChange('actionPlan', html)} />
                            <RichTextInput label="Additional Notes" value={formData.notes} onChange={(html) => handleRichTextChange('notes', html)} />
                        </>
                    ) : (
                        <>
                            <RichTextInput label="Context" value={formData.context} onChange={(html) => handleRichTextChange('context', html)} />
                            <RichTextInput label="Observed Behavior" value={formData.observedBehavior} onChange={(html) => handleRichTextChange('observedBehavior', html)} />
                            <RichTextInput label="Impact" value={formData.impact} onChange={(html) => handleRichTextChange('impact', html)} />
                            <RichTextInput label="Next Steps" value={formData.nextSteps} onChange={(html) => handleRichTextChange('nextSteps', html)} />
                        </>
                    )}
                    <div className="flex justify-end gap-2 pt-4">
                        <button type="button" onClick={onCancel} className="py-2 px-4 rounded-md bg-gray-200 dark:bg-gray-600">Cancel</button>
                        <button type="submit" className="py-2 px-4 rounded-md bg-purple-600 text-white">{initialData?.id ? 'Save Changes' : 'Create Session'}</button>
                    </div>
                </form>
            );
        };


        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ThemeProvider><Main /></ThemeProvider>);
    </script>
</body>
</html>

